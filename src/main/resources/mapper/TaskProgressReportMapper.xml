<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicustomer.mapper.TaskProgressReportMapper">

    <!-- 结果映射 -->
    <resultMap id="TaskProgressReportResultMap" type="com.aicustomer.entity.TaskProgressReport">
        <id column="id" property="id"/>
        <result column="task_id" property="taskId"/>
        <result column="task_name" property="taskName"/>
        <result column="report_type" property="reportType"/>
        <result column="report_title" property="reportTitle"/>
        <result column="report_content" property="reportContent"/>
        <result column="employee_name" property="employeeName"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 查询任务进度汇报列表 -->
    <select id="findReports" resultMap="TaskProgressReportResultMap">
        SELECT 
            r.id,
            r.task_id,
            COALESCE(NULLIF(r.task_name, ''), t.title, t.name, CONCAT('任务', r.task_id)) as task_name,
            r.report_type,
            r.report_title,
            r.report_content,
            r.employee_name,
            r.create_time,
            r.update_time
        FROM task_progress_report r
        LEFT JOIN team_task t ON r.task_id = t.id AND t.deleted = 0
        <where>
            r.deleted = 0
            <if test="taskId != null">
                AND r.task_id = #{taskId}
            </if>
            <if test="employeeName != null and employeeName != ''">
                AND r.employee_name = #{employeeName}
            </if>
            <if test="reportType != null">
                AND r.report_type = #{reportType}
            </if>
        </where>
        ORDER BY r.create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据ID查询任务进度汇报 -->
    <select id="findById" resultMap="TaskProgressReportResultMap">
        SELECT 
            r.id,
            r.task_id,
            COALESCE(NULLIF(r.task_name, ''), t.title, t.name, CONCAT('任务', r.task_id)) as task_name,
            r.report_type,
            r.report_title,
            r.report_content,
            r.employee_name,
            r.create_time,
            r.update_time
        FROM task_progress_report r
        LEFT JOIN team_task t ON r.task_id = t.id AND t.deleted = 0
        WHERE r.id = #{id} AND r.deleted = 0
    </select>

    <!-- 插入任务进度汇报 -->
    <insert id="insert" parameterType="com.aicustomer.entity.TaskProgressReport" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO task_progress_report (
            task_id, task_name, report_type, report_title, report_content, employee_name,
            create_time, update_time, deleted, version
        ) VALUES (
            #{taskId}, #{taskName}, #{reportType}, #{reportTitle}, #{reportContent}, #{employeeName},
            #{createTime}, #{updateTime}, 0, 1
        )
    </insert>

    <!-- 更新任务进度汇报 -->
    <update id="update" parameterType="com.aicustomer.entity.TaskProgressReport">
        UPDATE task_progress_report SET
            task_id = #{taskId},
            task_name = #{taskName},
            report_type = #{reportType},
            report_title = #{reportTitle},
            report_content = #{reportContent},
            employee_name = #{employeeName},
            update_time = #{updateTime},
            version = version + 1
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 删除任务进度汇报（逻辑删除） -->
    <update id="delete">
        UPDATE task_progress_report SET deleted = 1, update_time = NOW() WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 获取汇报总数 -->
    <select id="countReports" resultType="int">
        SELECT COUNT(*) FROM task_progress_report
        <where>
            deleted = 0
            <if test="taskId != null">
                AND task_id = #{taskId}
            </if>
            <if test="employeeName != null and employeeName != ''">
                AND employee_name = #{employeeName}
            </if>
            <if test="reportType != null">
                AND report_type = #{reportType}
            </if>
        </where>
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicustomer.mapper.AiAnalysisMapper">

    <resultMap id="BaseResultMap" type="com.aicustomer.entity.AiAnalysis">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="customer_id" property="customerId" jdbcType="BIGINT"/>
        <result column="customer_name" property="customerName" jdbcType="VARCHAR"/>
        <result column="analysis_type" property="analysisType" jdbcType="INTEGER"/>
        <result column="title" property="title" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="summary" property="summary" jdbcType="VARCHAR"/>
        <result column="confidence" property="confidence" jdbcType="INTEGER"/>
        <result column="importance" property="importance" jdbcType="INTEGER"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="tags" property="tags" jdbcType="VARCHAR"/>
        <result column="keywords" property="keywords" jdbcType="VARCHAR"/>
        <result column="insights" property="insights" jdbcType="VARCHAR"/>
        <result column="recommendations" property="recommendations" jdbcType="VARCHAR"/>
        <result column="risk_level" property="riskLevel" jdbcType="INTEGER"/>
        <result column="opportunity_level" property="opportunityLevel" jdbcType="INTEGER"/>
        <result column="trend_direction" property="trendDirection" jdbcType="INTEGER"/>
        <result column="data_source" property="dataSource" jdbcType="VARCHAR"/>
        <result column="analysis_period" property="analysisPeriod" jdbcType="VARCHAR"/>
        <result column="model_version" property="modelVersion" jdbcType="VARCHAR"/>
        <result column="processing_time" property="processingTime" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="create_by" property="createBy" jdbcType="VARCHAR"/>
        <result column="update_by" property="updateBy" jdbcType="VARCHAR"/>
        <result column="deleted" property="deleted" jdbcType="TINYINT"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, customer_id, customer_name, analysis_type, title, content, summary, confidence,
        importance, status, tags, keywords, insights, recommendations, risk_level, opportunity_level,
        trend_direction, data_source, analysis_period, model_version, processing_time,
        create_time, update_time, create_by, update_by, deleted, version
    </sql>

    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM ai_analysis
        WHERE id = #{id} AND deleted = 0
    </select>

    <select id="selectList" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM ai_analysis
        WHERE deleted = 0
        <if test="analysis.customerId != null">
            AND customer_id = #{analysis.customerId}
        </if>
        <if test="analysis.analysisType != null">
            AND analysis_type = #{analysis.analysisType}
        </if>
        <if test="analysis.status != null">
            AND status = #{analysis.status}
        </if>
        <if test="analysis.importance != null">
            AND importance = #{analysis.importance}
        </if>
        ORDER BY create_time DESC
    </select>

    <select id="selectPage" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM ai_analysis
        WHERE deleted = 0
        <if test="analysis.customerId != null">
            AND customer_id = #{analysis.customerId}
        </if>
        <if test="analysis.analysisType != null">
            AND analysis_type = #{analysis.analysisType}
        </if>
        <if test="analysis.status != null">
            AND status = #{analysis.status}
        </if>
        <if test="analysis.importance != null">
            AND importance = #{analysis.importance}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <select id="selectCount" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM ai_analysis
        WHERE deleted = 0
        <if test="analysis.customerId != null">
            AND customer_id = #{analysis.customerId}
        </if>
        <if test="analysis.analysisType != null">
            AND analysis_type = #{analysis.analysisType}
        </if>
        <if test="analysis.status != null">
            AND status = #{analysis.status}
        </if>
        <if test="analysis.importance != null">
            AND importance = #{analysis.importance}
        </if>
    </select>

    <insert id="insert" parameterType="com.aicustomer.entity.AiAnalysis" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ai_analysis (
            customer_id, customer_name, analysis_type, title, content, summary, confidence,
            importance, status, tags, keywords, insights, recommendations, risk_level, opportunity_level,
            trend_direction, data_source, analysis_period, model_version, processing_time,
            create_time, update_time, create_by, update_by, deleted, version
        ) VALUES (
            #{customerId}, #{customerName}, #{analysisType}, #{title}, #{content}, #{summary}, #{confidence},
            #{importance}, #{status}, #{tags}, #{keywords}, #{insights}, #{recommendations}, #{riskLevel}, #{opportunityLevel},
            #{trendDirection}, #{dataSource}, #{analysisPeriod}, #{modelVersion}, #{processingTime},
            #{createTime}, #{updateTime}, #{createBy}, #{updateBy}, #{deleted}, #{version}
        )
    </insert>

    <update id="updateById" parameterType="com.aicustomer.entity.AiAnalysis">
        UPDATE ai_analysis
        SET customer_id = #{customerId},
            customer_name = #{customerName},
            analysis_type = #{analysisType},
            title = #{title},
            content = #{content},
            summary = #{summary},
            confidence = #{confidence},
            importance = #{importance},
            status = #{status},
            tags = #{tags},
            keywords = #{keywords},
            insights = #{insights},
            recommendations = #{recommendations},
            risk_level = #{riskLevel},
            opportunity_level = #{opportunityLevel},
            trend_direction = #{trendDirection},
            data_source = #{dataSource},
            analysis_period = #{analysisPeriod},
            model_version = #{modelVersion},
            processing_time = #{processingTime},
            update_time = #{updateTime},
            update_by = #{updateBy},
            version = version + 1
        WHERE id = #{id} AND deleted = 0
    </update>

    <update id="deleteById">
        UPDATE ai_analysis
        SET deleted = 1, update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <select id="selectByCustomerId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM ai_analysis
        WHERE customer_id = #{customerId} AND deleted = 0
        ORDER BY create_time DESC
    </select>

    <select id="selectStatistics" resultType="java.util.Map">
        SELECT
            COUNT(*) as totalAnalyses,
            COUNT(CASE WHEN analysis_type = 1 THEN 1 END) as behaviorAnalyses,
            COUNT(CASE WHEN analysis_type = 2 THEN 1 END) as sentimentAnalyses,
            COUNT(CASE WHEN analysis_type = 3 THEN 1 END) as trendAnalyses,
            COUNT(CASE WHEN analysis_type = 4 THEN 1 END) as riskAnalyses,
            AVG(confidence) as avgConfidence,
            COUNT(CASE WHEN importance = 3 THEN 1 END) as highImportanceCount,
            COUNT(CASE WHEN risk_level = 3 THEN 1 END) as highRiskCount
        FROM ai_analysis
        WHERE deleted = 0
        <if test="customerId != null">
            AND customer_id = #{customerId}
        </if>
        <if test="startTime != null">
            AND create_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND create_time &lt;= #{endTime}
        </if>
    </select>

</mapper>

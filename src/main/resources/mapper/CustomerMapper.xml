<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aicustomer.mapper.CustomerMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.aicustomer.entity.Customer">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="customer_code" property="customerCode" jdbcType="VARCHAR"/>
        <result column="customer_name" property="customerName" jdbcType="VARCHAR"/>
        <result column="customer_type" property="customerType" jdbcType="INTEGER"/>
        <result column="phone" property="phone" jdbcType="VARCHAR"/>
        <result column="email" property="email" jdbcType="VARCHAR"/>
        <result column="address" property="address" jdbcType="VARCHAR"/>
        <result column="customer_level" property="customerLevel" jdbcType="INTEGER"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="source" property="source" jdbcType="INTEGER"/>
        <result column="last_contact_time" property="lastContactTime" jdbcType="TIMESTAMP"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="create_by" property="createBy" jdbcType="VARCHAR"/>
        <result column="update_by" property="updateBy" jdbcType="VARCHAR"/>
        <result column="deleted" property="deleted" jdbcType="INTEGER"/>
        <result column="version" property="version" jdbcType="INTEGER"/>
        <!-- 新增字段 -->
        <result column="contact_person" property="contactPerson" jdbcType="VARCHAR"/>
        <result column="postal_code" property="postalCode" jdbcType="VARCHAR"/>
        <result column="fax" property="fax" jdbcType="VARCHAR"/>
        <result column="organization_code" property="organizationCode" jdbcType="VARCHAR"/>
        <result column="nationality" property="nationality" jdbcType="VARCHAR"/>
        <result column="applicant_nature" property="applicantNature" jdbcType="VARCHAR"/>
        <result column="agency_name" property="agencyName" jdbcType="VARCHAR"/>
        <result column="agency_code" property="agencyCode" jdbcType="VARCHAR"/>
        <result column="agency_address" property="agencyAddress" jdbcType="VARCHAR"/>
        <result column="agency_postal_code" property="agencyPostalCode" jdbcType="VARCHAR"/>
        <result column="agent_name" property="agentName" jdbcType="VARCHAR"/>
        <result column="agent_phone" property="agentPhone" jdbcType="VARCHAR"/>
        <result column="agent_fax" property="agentFax" jdbcType="VARCHAR"/>
        <result column="agent_mobile" property="agentMobile" jdbcType="VARCHAR"/>
        <result column="agent_email" property="agentEmail" jdbcType="VARCHAR"/>
    </resultMap>

    <!-- 基础列 -->
    <sql id="Base_Column_List">
        id, customer_code, customer_name, customer_type, phone, email, address,
        customer_level, status, remark, source, last_contact_time,
        create_time, update_time, create_by, update_by, deleted, version,
        contact_person, postal_code, fax, organization_code, nationality,
        applicant_nature, agency_name, agency_code, agency_address, agency_postal_code,
        agent_name, agent_phone, agent_fax, agent_mobile, agent_email
    </sql>

    <!-- 根据ID查询客户 -->
    <select id="selectById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM customer
        WHERE id = #{id} AND deleted = 0
    </select>

    <!-- 根据客户编号查询客户 -->
    <select id="selectByCustomerCode" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM customer
        WHERE customer_code = #{customerCode} AND deleted = 0
    </select>

    <!-- 查询客户列表 -->
    <select id="selectList" parameterType="com.aicustomer.entity.Customer" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM customer
        WHERE deleted = 0
        <if test="customer.customerName != null and customer.customerName != ''">
            AND customer_name LIKE CONCAT('%', #{customer.customerName}, '%')
        </if>
        <if test="customer.customerType != null">
            AND customer_type = #{customer.customerType}
        </if>
        <if test="customer.phone != null and customer.phone != ''">
            AND phone LIKE CONCAT('%', #{customer.phone}, '%')
        </if>
        <if test="customer.customerLevel != null">
            AND customer_level = #{customer.customerLevel}
        </if>
        <if test="customer.status != null">
            AND status = #{customer.status}
        </if>
        <if test="customer.source != null">
            AND source = #{customer.source}
        </if>
        ORDER BY create_time DESC
    </select>

    <!-- 分页查询客户 -->
    <select id="selectPage" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM customer
        WHERE deleted = 0
        <if test="customer.customerName != null and customer.customerName != ''">
            AND customer_name LIKE CONCAT('%', #{customer.customerName}, '%')
        </if>
        <if test="customer.customerType != null">
            AND customer_type = #{customer.customerType}
        </if>
        <if test="customer.phone != null and customer.phone != ''">
            AND phone LIKE CONCAT('%', #{customer.phone}, '%')
        </if>
        <if test="customer.customerLevel != null">
            AND customer_level = #{customer.customerLevel}
        </if>
        <if test="customer.status != null">
            AND status = #{customer.status}
        </if>
        <if test="customer.source != null">
            AND source = #{customer.source}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 查询客户总数 -->
    <select id="selectCount" parameterType="com.aicustomer.entity.Customer" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM customer
        WHERE deleted = 0
        <if test="customer.customerName != null and customer.customerName != ''">
            AND customer_name LIKE CONCAT('%', #{customer.customerName}, '%')
        </if>
        <if test="customer.customerType != null">
            AND customer_type = #{customer.customerType}
        </if>
        <if test="customer.phone != null and customer.phone != ''">
            AND phone LIKE CONCAT('%', #{customer.phone}, '%')
        </if>
        <if test="customer.customerLevel != null">
            AND customer_level = #{customer.customerLevel}
        </if>
        <if test="customer.status != null">
            AND status = #{customer.status}
        </if>
        <if test="customer.source != null">
            AND source = #{customer.source}
        </if>
    </select>

    <!-- 插入客户 -->
    <insert id="insert" parameterType="com.aicustomer.entity.Customer" useGeneratedKeys="true" keyProperty="customer.id">
        INSERT INTO customer (
            customer_code, customer_name, customer_type, phone, email, address,
            customer_level, status, remark, source, last_contact_time,
            create_time, update_time, create_by, update_by, deleted, version,
            contact_person, postal_code, fax, organization_code, nationality,
            applicant_nature, agency_name, agency_code, agency_address, agency_postal_code,
            agent_name, agent_phone, agent_fax, agent_mobile, agent_email
        ) VALUES (
            #{customer.customerCode}, #{customer.customerName}, #{customer.customerType},
            #{customer.phone}, #{customer.email}, #{customer.address},
            #{customer.customerLevel}, #{customer.status}, #{customer.remark},
            #{customer.source}, #{customer.lastContactTime},
            #{customer.createTime}, #{customer.updateTime}, #{customer.createBy},
            #{customer.updateBy}, #{customer.deleted}, #{customer.version},
            #{customer.contactPerson}, #{customer.postalCode}, #{customer.fax},
            #{customer.organizationCode}, #{customer.nationality},
            #{customer.applicantNature}, #{customer.agencyName}, #{customer.agencyCode},
            #{customer.agencyAddress}, #{customer.agencyPostalCode},
            #{customer.agentName}, #{customer.agentPhone}, #{customer.agentFax},
            #{customer.agentMobile}, #{customer.agentEmail}
        )
    </insert>

    <!-- 更新客户 -->
    <update id="updateById" parameterType="com.aicustomer.entity.Customer">
        UPDATE customer
        <set>
            <if test="customer.customerName != null and customer.customerName != ''">
                customer_name = #{customer.customerName},
            </if>
            <if test="customer.customerType != null">
                customer_type = #{customer.customerType},
            </if>
            <if test="customer.phone != null and customer.phone != ''">
                phone = #{customer.phone},
            </if>
            <if test="customer.email != null and customer.email != ''">
                email = #{customer.email},
            </if>
            <if test="customer.address != null and customer.address != ''">
                address = #{customer.address},
            </if>
            <if test="customer.customerLevel != null">
                customer_level = #{customer.customerLevel},
            </if>
            <if test="customer.status != null">
                status = #{customer.status},
            </if>
            <if test="customer.remark != null and customer.remark != ''">
                remark = #{customer.remark},
            </if>
            <if test="customer.source != null">
                source = #{customer.source},
            </if>
            <if test="customer.lastContactTime != null">
                last_contact_time = #{customer.lastContactTime},
            </if>
            <!-- 新增字段更新 -->
            <if test="customer.contactPerson != null and customer.contactPerson != ''">
                contact_person = #{customer.contactPerson},
            </if>
            <if test="customer.postalCode != null and customer.postalCode != ''">
                postal_code = #{customer.postalCode},
            </if>
            <if test="customer.fax != null and customer.fax != ''">
                fax = #{customer.fax},
            </if>
            <if test="customer.organizationCode != null and customer.organizationCode != ''">
                organization_code = #{customer.organizationCode},
            </if>
            <if test="customer.nationality != null and customer.nationality != ''">
                nationality = #{customer.nationality},
            </if>
            <if test="customer.applicantNature != null and customer.applicantNature != ''">
                applicant_nature = #{customer.applicantNature},
            </if>
            <if test="customer.agencyName != null and customer.agencyName != ''">
                agency_name = #{customer.agencyName},
            </if>
            <if test="customer.agencyCode != null and customer.agencyCode != ''">
                agency_code = #{customer.agencyCode},
            </if>
            <if test="customer.agencyAddress != null and customer.agencyAddress != ''">
                agency_address = #{customer.agencyAddress},
            </if>
            <if test="customer.agencyPostalCode != null and customer.agencyPostalCode != ''">
                agency_postal_code = #{customer.agencyPostalCode},
            </if>
            <if test="customer.agentName != null and customer.agentName != ''">
                agent_name = #{customer.agentName},
            </if>
            <if test="customer.agentPhone != null and customer.agentPhone != ''">
                agent_phone = #{customer.agentPhone},
            </if>
            <if test="customer.agentFax != null and customer.agentFax != ''">
                agent_fax = #{customer.agentFax},
            </if>
            <if test="customer.agentMobile != null and customer.agentMobile != ''">
                agent_mobile = #{customer.agentMobile},
            </if>
            <if test="customer.agentEmail != null and customer.agentEmail != ''">
                agent_email = #{customer.agentEmail},
            </if>
            <if test="customer.updateTime != null">
                update_time = #{customer.updateTime},
            </if>
            <if test="customer.updateBy != null and customer.updateBy != ''">
                update_by = #{customer.updateBy},
            </if>
            <if test="customer.version != null">
                version = #{customer.version} + 1,
            </if>
        </set>
        WHERE id = #{customer.id} AND deleted = 0
    </update>

    <!-- 根据ID删除客户 -->
    <update id="deleteById" parameterType="java.lang.Long">
        UPDATE customer
        SET deleted = 1, update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 批量删除客户 -->
    <update id="deleteByIds">
        UPDATE customer
        SET deleted = 1, update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted = 0
    </update>

</mapper>


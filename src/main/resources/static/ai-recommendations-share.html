<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能推荐报告分享 - AI客户管理系统</title>
    <link href="/lib/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet">
    <style>
        .share-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .share-header {
            text-align: center;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 2rem;
        }
        
        .share-header h2 {
            color: #212529;
            margin-bottom: 0.5rem;
        }
        
        .share-header .badge {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }
        
        .report-item {
            background-color: #f8f9fa;
            border-left: 4px solid #3b82f6;
            transition: box-shadow 0.2s;
        }
        
        .report-item:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .loading-container {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .error-container {
            text-align: center;
            padding: 4rem 2rem;
            color: #dc3545;
        }
        
        .print-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }
        
        @media print {
            .print-btn {
                display: none;
            }
            
            .share-container {
                box-shadow: none;
                margin: 0;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="share-container">
            <div id="loadingContainer" class="loading-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-3 text-muted">正在加载推荐报告...</p>
            </div>
            
            <div id="errorContainer" class="error-container" style="display: none;">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                <h3 class="mt-3">加载失败</h3>
                <p id="errorMessage">无法加载推荐报告数据</p>
                <a href="/ai-recommendations.html" class="btn btn-primary mt-3">
                    <i class="bi bi-arrow-left"></i> 返回推荐页面
                </a>
            </div>
            
            <div id="reportContainer" style="display: none;">
                <div class="share-header">
                    <h2><i class="bi bi-file-earmark-text"></i> AI智能推荐报告</h2>
                    <div class="mt-2">
                        <span class="badge bg-primary" id="reportBadge">分享报告</span>
                        <span class="badge bg-secondary ms-2" id="generateTimeBadge"></span>
                    </div>
                </div>
                
                <div id="reportContent">
                    <!-- 报告内容将动态加载 -->
                </div>
                
                <div class="report-footer mt-4 pt-3 border-top text-center">
                    <p class="text-muted small">本报告由AI智能推荐系统自动生成</p>
                    <p class="text-muted small">分享时间：<span id="shareTime"></span></p>
                </div>
            </div>
        </div>
        
        <button class="btn btn-primary print-btn" onclick="window.print()">
            <i class="bi bi-printer"></i> 打印报告
        </button>
    </div>
    
    <script src="/lib/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        // 从URL参数获取数据
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // 解析分享数据
        function parseShareData() {
            const dataParam = getUrlParameter('data');
            if (!dataParam) {
                showError('缺少分享数据参数');
                return null;
            }
            
            try {
                // Base64解码
                const decodedData = atob(decodeURIComponent(dataParam));
                const shareData = JSON.parse(decodedData);
                return shareData;
            } catch (error) {
                console.error('解析分享数据失败:', error);
                showError('分享数据格式错误，无法解析');
                return null;
            }
        }
        
        // 显示错误
        function showError(message) {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        // 渲染报告
        function renderReport(shareData) {
            if (!shareData || !shareData.recommendations || !Array.isArray(shareData.recommendations)) {
                showError('分享数据无效');
                return;
            }
            
            const recommendations = shareData.recommendations;
            
            // 更新生成时间
            if (shareData.generateTime) {
                const generateTime = new Date(shareData.generateTime);
                document.getElementById('generateTimeBadge').textContent = 
                    '生成时间：' + generateTime.toLocaleString('zh-CN');
            }
            
            // 更新分享时间
            document.getElementById('shareTime').textContent = new Date().toLocaleString('zh-CN');
            
            // 生成报告HTML
            let reportHtml = `
                <div class="report-body">
                    <p class="text-muted mb-4">推荐数量：${recommendations.length} 条</p>
            `;
            
            recommendations.forEach((rec, index) => {
                const typeText = getTypeText(rec.type);
                const priorityText = getPriorityText(rec.priority);
                const typeClass = getTypeClass(rec.type);
                const priorityClass = getPriorityClass(rec.priority);
                
                reportHtml += `
                    <div class="report-item mb-4 p-4 border rounded">
                        <h5 class="mb-3">推荐 ${index + 1}: ${rec.title || '未命名推荐'}</h5>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <strong>客户名称：</strong>${rec.customerName || '未指定'}
                            </div>
                            <div class="col-md-6">
                                <strong>推荐类型：</strong><span class="badge ${typeClass}">${typeText}</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <strong>优先级：</strong><span class="badge ${priorityClass}">${priorityText}</span>
                            </div>
                            <div class="col-md-6">
                                <strong>置信度：</strong>${rec.confidence ? Math.round(rec.confidence * 100) + '%' : '未知'}
                            </div>
                        </div>
                        <div class="mb-2">
                            <strong>推荐内容：</strong>
                            <p class="mt-2">${rec.content || '无'}</p>
                        </div>
                        <div class="mb-2">
                            <strong>推荐理由：</strong>
                            <p class="mt-2">${rec.reason || '无'}</p>
                        </div>
                        ${rec.createTime ? `
                        <div class="text-muted small">
                            <strong>创建时间：</strong>${rec.createTime}
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            reportHtml += `
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = reportHtml;
            
            // 隐藏加载，显示报告
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'block';
        }
        
        // 获取类型文本
        function getTypeText(type) {
            switch (type) {
                case 'product': return '产品推荐';
                case 'service': return '服务推荐';
                case 'strategy': return '策略推荐';
                default: return '其他';
            }
        }
        
        // 获取类型样式类
        function getTypeClass(type) {
            switch (type) {
                case 'product': return 'bg-primary';
                case 'service': return 'bg-success';
                case 'strategy': return 'bg-info';
                default: return 'bg-secondary';
            }
        }
        
        // 获取优先级文本
        function getPriorityText(priority) {
            switch (priority) {
                case 'high': return '高';
                case 'medium': return '中';
                case 'low': return '低';
                default: return '未知';
            }
        }
        
        // 获取优先级样式类
        function getPriorityClass(priority) {
            switch (priority) {
                case 'high': return 'bg-danger';
                case 'medium': return 'bg-warning';
                case 'low': return 'bg-secondary';
                default: return 'bg-secondary';
            }
        }
        
        // 页面加载完成后解析并显示报告
        document.addEventListener('DOMContentLoaded', function() {
            const shareData = parseShareData();
            if (shareData) {
                renderReport(shareData);
            }
        });
    </script>
</body>
</html>


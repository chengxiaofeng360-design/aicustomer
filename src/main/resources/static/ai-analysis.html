<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能分析 - AI客户管理系统</title>
    <link href="/lib/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet">
    <style>
        .opportunity-card {
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .opportunity-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .opportunity-card.high-priority {
            border-left-color: #dc3545;
        }
        .opportunity-card.medium-priority {
            border-left-color: #ffc107;
        }
        .opportunity-card.low-priority {
            border-left-color: #28a745;
        }
        .reminder-card {
            border-left: 4px solid #17a2b8;
            margin-bottom: 15px;
        }
        .reminder-card.birthday {
            border-left-color: #e83e8c;
        }
        .reminder-card.no-contact {
            border-left-color: #fd7e14;
        }
        .priority-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .customer-link {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        .customer-link:hover {
            text-decoration: underline;
        }
        .opportunity-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .keyword-tag {
            background-color: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            color: #495057;
        }
        .cooperation-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }
        .cooperation-score.medium {
            color: #ffc107;
        }
        .cooperation-score.low {
            color: #dc3545;
        }
        .insight-card {
            border-radius: 18px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px rgba(15,23,42,0.05);
            margin-bottom: 2rem;
        }
        .insight-list {
            margin: 0;
            padding-left: 1.2rem;
            color: #4a5568;
            font-size: 0.95rem;
        }
        .insight-item + .insight-item {
            margin-top: 0.35rem;
        }
        .insight-item strong {
            color: #1a202c;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 页面头部 -->
        <div class="page-header">
            <div class="page-title">
                <i class="bi bi-graph-up"></i> AI智能分析
            </div>
            <a href="/" class="back-home-btn">
                <i class="bi bi-house-fill"></i> 返回首页
            </a>
        </div>
        
        <!-- 统计卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="opportunityCount">0</div>
                    <div class="stats-label">业务机会</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="birthdayCount">0</div>
                    <div class="stats-label">生日提醒</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="noContactCount">0</div>
                    <div class="stats-label">待跟进客户</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="importantCustomerCount">0</div>
                    <div class="stats-label">重要客户</div>
                </div>
            </div>
        </div>

        <div class="card insight-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-journal-text"></i> 实时洞察
                </h5>
                <small class="text-muted" id="insightTimestamp">正在加载...</small>
            </div>
            <div class="card-body" id="analysisInsights">
                <div class="text-muted small">正在分析客户沟通、提醒和等级数据...</div>
            </div>
        </div>

        <div class="row">
            <!-- 左侧：业务机会 -->
            <div class="col-md-8">
        <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-lightbulb"></i> 业务机会
                        </h5>
                        <button class="btn btn-sm btn-primary" onclick="refreshOpportunities()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
            </div>
            <div class="card-body">
                        <div id="opportunitiesList">
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                                <p class="mt-2">正在分析数据库中的沟通记录...</p>
                            </div>
                        </div>
                    </div>
                        </div>

                <!-- 合作潜力分析 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up-arrow"></i> 合作潜力分析
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">选择客户</label>
                            <select class="form-select" id="customerSelect" onchange="analyzeCooperationPotential()">
                                <option value="">-- 请选择客户 --</option>
                            </select>
                        </div>
                        <div id="cooperationAnalysis" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>合作潜力评分</h6>
                                    <div class="cooperation-score" id="cooperationScore">-</div>
                                    <p class="text-muted small mt-2" id="cooperationScoreDesc">基于客户规模、行业匹配度、沟通频率等因素综合评估</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>分析维度</h6>
                                    <div id="cooperationDimensions"></div>
                        </div>
                    </div>
                            <div class="mt-3">
                                <h6>合作建议</h6>
                                <div id="cooperationSuggestions"></div>
                    </div>
                </div>
            </div>
        </div>
            </div>

            <!-- 右侧：客户维护提醒 -->
            <div class="col-md-4">
                <!-- 生日提醒 -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-gift"></i> 生日提醒
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshReminders()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="birthdayReminders">
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-hourglass-split"></i>
                                <p class="mt-2 small">正在查询客户生日信息...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 长时间未沟通提醒 -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history"></i> 待跟进客户
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshReminders()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="noContactReminders">
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-hourglass-split"></i>
                                <p class="mt-2 small">正在分析客户沟通记录...</p>
                </div>
            </div>
        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 业务机会详情模态框 -->
    <div class="modal fade" id="opportunityDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">业务机会详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="opportunityDetailContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/lib/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        const opportunityStore = {};
        let latestOpportunities = [];
        let latestBirthdays = [];
        let latestNoContacts = [];

        // 模拟数据（用于页面展示）
        const mockOpportunities = [
            {
                id: 1,
                customerId: 1,
                customerName: 'ABC科技有限公司',
                description: '客户在最近沟通中提到了合作、项目、方案相关需求，最近5次沟通显示有合作意向。',
                keywords: ['合作', '项目', '方案', '技术'],
                priority: 'high',
                detectedTime: '2024-01-25T10:30:00',
                communicationCount: 5
            },
            {
                id: 2,
                customerId: 2,
                customerName: 'XYZ咨询公司',
                description: '客户在最近沟通中提到了需求、产品、购买相关需求，最近3次沟通显示有合作意向。',
                keywords: ['需求', '产品', '购买'],
                priority: 'medium',
                detectedTime: '2024-01-24T14:20:00',
                communicationCount: 3
            },
            {
                id: 3,
                customerId: 3,
                customerName: '中科院植物研究所',
                description: '客户在最近沟通中提到了考虑、服务、支持相关需求，最近2次沟通显示有合作意向。',
                keywords: ['考虑', '服务', '支持'],
                priority: 'low',
                detectedTime: '2024-01-23T09:15:00',
                communicationCount: 2
            }
        ];

        const mockBirthdays = [
            {
                customerId: 1,
                customerName: '张伟',
                birthday: '1990-02-15',
                interests: '旅游、摄影、美食',
                daysUntil: 21
            },
            {
                customerId: 2,
                customerName: '李娜',
                birthday: '1985-01-28',
                interests: '设计、艺术、音乐',
                daysUntil: 3
            },
            {
                customerId: 3,
                customerName: '张三',
                birthday: '1992-01-26',
                interests: '创业、投资、运动',
                daysUntil: 1
            }
        ];

        const mockNoContacts = [
            {
                customerId: 4,
                customerName: '中科院植物研究所',
                daysSinceLastContact: 45,
                lastContactTime: '2023-12-10T10:00:00'
            },
            {
                customerId: 5,
                customerName: '钱七',
                daysSinceLastContact: 38,
                lastContactTime: '2023-12-17T14:30:00'
            }
        ];

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeAnalysisPage();
        });

        async function initializeAnalysisPage() {
            setSectionLoading('opportunitiesList', '正在分析数据库中的沟通记录...');
            setSectionLoading('birthdayReminders', '正在查询客户生日信息...');
            setSectionLoading('noContactReminders', '正在分析客户沟通记录...');
            setInsightsLoading();
            await Promise.all([loadOpportunities(), loadReminders()]);
            loadCustomerOptions();
        }

        // 更新统计数据
        function updateStats(opportunities, birthdays, noContacts, importantCount) {
            if (opportunities !== undefined) {
                document.getElementById('opportunityCount').textContent = opportunities.length;
            }
            if (birthdays !== undefined) {
                document.getElementById('birthdayCount').textContent = birthdays.length;
            }
            if (noContacts !== undefined) {
                document.getElementById('noContactCount').textContent = noContacts.length;
            }
            if (importantCount !== undefined) {
                document.getElementById('importantCustomerCount').textContent = importantCount;
            }
        }

        // 获取模拟的合作潜力分析数据
        function getMockCooperationAnalysis() {
            return {
                score: 85,
                description: '该客户具有很高的合作潜力，建议重点跟进，提供个性化服务方案。',
                dimensions: [
                    { name: '客户等级', score: 30, description: '客户等级越高，合作潜力越大' },
                    { name: '沟通频率', score: 20, description: '最近30天沟通4次' },
                    { name: '客户状态', score: 20, description: '正常' },
                    { name: '客户类型', score: 15, description: '企业客户' },
                    { name: '信息完整度', score: 8, description: '客户信息越完整，合作可能性越高' }
                ],
                suggestions: [
                    '建议主动联系，提供定制化服务方案',
                    '安排专人跟进，建立长期合作关系',
                    '增加沟通频率，深入了解客户需求'
                ]
            };
        }

        // 加载业务机会
        async function loadOpportunities() {
            try {
                const response = await fetch('/api/ai-analysis/business-opportunities');
                const result = await response.json();
                
                if (response.ok && result.code === 200 && Array.isArray(result.data)) {
                    latestOpportunities = result.data;
                    displayOpportunities(latestOpportunities);
                    updateStats(latestOpportunities, undefined, undefined, undefined);
                } else {
                    latestOpportunities = mockOpportunities;
                    displayOpportunities(mockOpportunities);
                    updateStats(mockOpportunities, undefined, undefined, undefined);
                }
            } catch (error) {
                console.error('加载业务机会失败:', error);
                latestOpportunities = mockOpportunities;
                displayOpportunities(mockOpportunities);
                updateStats(mockOpportunities, undefined, undefined, undefined);
            } finally {
                renderInsights();
            }
        }

        // 显示业务机会
        function displayOpportunities(opportunities) {
            const container = document.getElementById('opportunitiesList');
            
            if (!opportunities || opportunities.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4"><p>暂无业务机会</p></div>';
                return;
            }

            container.innerHTML = opportunities.map(opp => {
                if (opp && opp.id !== undefined) {
                    opportunityStore[opp.id] = opp;
                }
                const priorityClass = opp.priority === 'high' ? 'high-priority' : 
                                     opp.priority === 'low' ? 'low-priority' : '';
                const priorityText = opp.priority === 'high' ? '高优先级' : 
                                    opp.priority === 'low' ? '低优先级' : '';
                const priorityBadge = opp.priority === 'high' ? 'danger' : 
                                      opp.priority === 'low' ? 'success' : 'warning';

                return `
                    <div class="card opportunity-card ${priorityClass}" onclick="viewOpportunityDetail(${opp.id})">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">
                                    <a href="#" class="customer-link" onclick="event.stopPropagation(); goToCustomerDetail(${opp.customerId})">
                                        ${escapeHtml(opp.customerName)}
                                    </a>
                                </h6>
                                ${priorityText ? `<span class="badge bg-${priorityBadge} priority-badge">${priorityText}</span>` : ''}
                            </div>
                            <p class="text-muted small mb-2">${escapeHtml(opp.description)}</p>
                            ${opp.keywords && opp.keywords.length > 0 ? `
                                <div class="opportunity-keywords">
                                    ${opp.keywords.map(kw => `<span class="keyword-tag">${escapeHtml(kw)}</span>`).join('')}
                                </div>
                            ` : ''}
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> ${formatDate(opp.detectedTime)}
                                    ${opp.communicationCount ? ` | <i class="bi bi-chat-dots"></i> 最近${opp.communicationCount}次沟通` : ''}
                                </small>
                        </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 加载提醒
        async function loadReminders() {
            try {
                const response = await fetch('/api/ai-analysis/customer-reminders');
                const result = await response.json();
                
                if (response.ok && result.code === 200 && result.data) {
                    latestBirthdays = Array.isArray(result.data.birthdays) ? result.data.birthdays : [];
                    latestNoContacts = Array.isArray(result.data.noContacts) ? result.data.noContacts : [];
                    const importantCount = result.data.importantCustomerCount || 0;
                    displayBirthdayReminders(latestBirthdays);
                    displayNoContactReminders(latestNoContacts);
                    updateStats(undefined, latestBirthdays, latestNoContacts, importantCount);
                } else {
                    latestBirthdays = mockBirthdays;
                    latestNoContacts = mockNoContacts;
                    displayBirthdayReminders(mockBirthdays);
                    displayNoContactReminders(mockNoContacts);
                    updateStats(undefined, mockBirthdays, mockNoContacts, 3);
                }
            } catch (error) {
                console.error('加载提醒失败:', error);
                latestBirthdays = mockBirthdays;
                latestNoContacts = mockNoContacts;
                displayBirthdayReminders(mockBirthdays);
                displayNoContactReminders(mockNoContacts);
                updateStats(undefined, mockBirthdays, mockNoContacts, 3);
            } finally {
                renderInsights();
            }
        }

        // 显示生日提醒
        function displayBirthdayReminders(birthdays) {
            const container = document.getElementById('birthdayReminders');
            
            if (!birthdays || birthdays.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3"><p class="small">暂无生日提醒</p></div>';
                return;
            }

            container.innerHTML = birthdays.map(item => {
                // 处理daysUntil，可能是数字或需要计算
                let daysUntil = item.daysUntil;
                if (daysUntil === undefined && item.birthday) {
                    // 计算距离生日的天数
                    const today = new Date();
                    const birthday = new Date(item.birthday);
                    birthday.setFullYear(today.getFullYear());
                    if (birthday < today) {
                        birthday.setFullYear(today.getFullYear() + 1);
                    }
                    daysUntil = Math.ceil((birthday - today) / (1000 * 60 * 60 * 24));
                }
                
                const urgencyClass = daysUntil <= 1 ? 'text-danger' : daysUntil <= 3 ? 'text-warning' : '';
                const birthdayStr = item.birthday ? formatBirthday(item.birthday) : '';
                
                return `
                    <div class="card reminder-card birthday mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>
                                        <a href="#" class="customer-link" onclick="goToCustomerDetail(${item.customerId})">
                                            ${escapeHtml(item.customerName)}
                                        </a>
                                    </strong>
                                    <br>
                                    <small class="text-muted">
                                        ${birthdayStr} 
                                        <span class="${urgencyClass}">(${daysUntil === 0 ? '今天' : daysUntil === 1 ? '明天' : `${daysUntil}天后`})</span>
                                    </small>
                                </div>
                                ${item.interests ? `<small class="text-muted">${escapeHtml(item.interests)}</small>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 显示长时间未沟通提醒
        function displayNoContactReminders(noContacts) {
            const container = document.getElementById('noContactReminders');
            
            if (!noContacts || noContacts.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3"><p class="small">暂无待跟进客户</p></div>';
                return;
            }

            container.innerHTML = noContacts.map(item => {
                return `
                    <div class="card reminder-card no-contact mb-2">
                        <div class="card-body p-2">
                            <div>
                                <strong>
                                    <a href="#" class="customer-link" onclick="goToCustomerDetail(${item.customerId})">
                                        ${escapeHtml(item.customerName)}
                                    </a>
                                </strong>
                                <br>
                                <small class="text-muted">
                                    ${item.daysSinceLastContact}天未沟通
                                    ${item.lastContactTime ? ` | 上次: ${formatDate(item.lastContactTime)}` : ''}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 加载客户选项
        async function loadCustomerOptions() {
            try {
                const response = await fetch('/api/customer/list?page=1&size=1000');
                const result = await response.json();
                
                if (response.ok && result.code === 200 && result.data && result.data.list) {
                    const select = document.getElementById('customerSelect');
                    result.data.list.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = customer.customerName;
                        select.appendChild(option);
                    });
                } else {
                    addMockCustomerOptions();
                }
            } catch (error) {
                console.error('加载客户选项失败:', error);
                addMockCustomerOptions();
            }
        }

        // 添加模拟客户选项
        function addMockCustomerOptions() {
            const select = document.getElementById('customerSelect');
            const mockCustomers = [
                { id: 1, name: 'ABC科技有限公司' },
                { id: 2, name: 'XYZ咨询公司' },
                { id: 3, name: '中科院植物研究所' },
                { id: 4, name: '钱七' }
            ];
            mockCustomers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                select.appendChild(option);
            });
        }

        // 分析合作潜力
        async function analyzeCooperationPotential() {
            const customerId = document.getElementById('customerSelect').value;
            if (!customerId) {
                document.getElementById('cooperationAnalysis').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/api/ai-analysis/cooperation-potential/${customerId}`);
                const result = await response.json();
                
                if (response.ok && result.code === 200 && result.data) {
                    displayCooperationAnalysis(result.data);
                    document.getElementById('cooperationAnalysis').style.display = 'block';
                } else {
                    displayCooperationAnalysis(getMockCooperationAnalysis());
                    document.getElementById('cooperationAnalysis').style.display = 'block';
                }
            } catch (error) {
                console.error('分析合作潜力失败:', error);
                displayCooperationAnalysis(getMockCooperationAnalysis());
                document.getElementById('cooperationAnalysis').style.display = 'block';
            }
        }

        // 显示合作潜力分析
        function displayCooperationAnalysis(data) {
            const score = data.score || 0;
            const scoreClass = score >= 70 ? '' : score >= 50 ? 'medium' : 'low';
            
            document.getElementById('cooperationScore').textContent = score;
            document.getElementById('cooperationScore').className = `cooperation-score ${scoreClass}`;
            document.getElementById('cooperationScoreDesc').textContent = data.description || '';

            // 显示分析维度
            const dimensionsHtml = data.dimensions ? data.dimensions.map(dim => `
                <div class="mb-2">
                    <small><strong>${escapeHtml(dim.name)}:</strong> ${dim.score}分</small>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar" style="width: ${dim.score}%"></div>
                    </div>
                </div>
            `).join('') : '';
            document.getElementById('cooperationDimensions').innerHTML = dimensionsHtml;

            // 显示合作建议
            const suggestionsHtml = data.suggestions ? data.suggestions.map(s => `
                <div class="alert alert-info mb-2">
                    <i class="bi bi-lightbulb"></i> ${escapeHtml(s)}
                </div>
            `).join('') : '';
            document.getElementById('cooperationSuggestions').innerHTML = suggestionsHtml;
        }

        // 查看业务机会详情
        function viewOpportunityDetail(opportunityId) {
            const modal = new bootstrap.Modal(document.getElementById('opportunityDetailModal'));
            const container = document.getElementById('opportunityDetailContent');
            const opportunity = opportunityStore[opportunityId];

            if (!opportunity) {
                container.innerHTML = '<p class="text-muted mb-0">未能加载业务机会详情，请稍后再试。</p>';
                modal.show();
                return;
            }

            container.innerHTML = buildOpportunityDetail(opportunity);
            modal.show();
        }

        function buildOpportunityDetail(opportunity) {
            const priorityInfo = getPriorityBadgeInfo(opportunity.priority);
            const keywords = Array.isArray(opportunity.keywords) ? opportunity.keywords : [];
            const keywordsHtml = keywords.length ? `
                <div class="mb-3">
                    <h6>关联关键词</h6>
                    <div class="opportunity-keywords">
                        ${keywords.map(kw => `<span class="keyword-tag">${escapeHtml(kw)}</span>`).join('')}
                    </div>
                </div>
            ` : '';

            const insights = generateOpportunityInsights(opportunity);
            const insightsHtml = insights.length ? `
                <ul class="list-group list-group-flush">
                    ${insights.map(item => `<li class="list-group-item"><i class="bi bi-lightning-charge text-warning me-2"></i>${escapeHtml(item)}</li>`).join('')}
                </ul>
            ` : '<p class="text-muted mb-0">暂无分析要点。</p>';

            const suggestions = generateOpportunitySuggestions(opportunity);
            const suggestionsHtml = suggestions.length ? suggestions.map(s => `
                <div class="alert alert-info mb-2">
                    <i class="bi bi-check-circle me-2"></i>${escapeHtml(s)}
                        </div>
            `).join('') : '<p class="text-muted mb-0">暂无建议。</p>';

            return `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h5 class="mb-1">${escapeHtml(opportunity.customerName || '未知客户')}</h5>
                            <small class="text-muted">机会识别时间：${formatDate(opportunity.detectedTime) || '—'}</small>
                        </div>
                        ${priorityInfo.badge}
                    </div>
                </div>
                <div class="mb-3">
                    <h6>机会描述</h6>
                    <p class="text-muted mb-0">${escapeHtml(opportunity.description || '暂无描述')}</p>
                </div>
                ${keywordsHtml}
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="border rounded-3 p-3 bg-light">
                            <div class="text-muted small">最近沟通次数</div>
                            <div class="fw-bold fs-4">${opportunity.communicationCount || 0} 次</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="border rounded-3 p-3 bg-light">
                            <div class="text-muted small">优先级判断</div>
                            <div class="fw-bold fs-5">${priorityInfo.text}</div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <h6>分析要点</h6>
                    ${insightsHtml}
                </div>
                <div>
                    <h6>行动建议</h6>
                    ${suggestionsHtml}
                    </div>
                `;
        }

        function getPriorityBadgeInfo(priority) {
            switch (priority) {
                case 'high':
                    return {
                        text: '高优先级 · 需立即跟进',
                        badge: '<span class="badge bg-danger fs-6 px-3">高优先级</span>'
                    };
                case 'medium':
                    return {
                        text: '中优先级 · 建议保持跟进',
                        badge: '<span class="badge bg-warning text-dark fs-6 px-3">中优先级</span>'
                    };
                case 'low':
                    return {
                        text: '低优先级 · 可持续观察',
                        badge: '<span class="badge bg-success fs-6 px-3">低优先级</span>'
                    };
                default:
                    return {
                        text: '优先级待评估',
                        badge: '<span class="badge bg-secondary fs-6 px-3">未分级</span>'
                    };
            }
        }

        function generateOpportunityInsights(opportunity) {
            const insights = [];
            const keywords = Array.isArray(opportunity.keywords) ? opportunity.keywords : [];
            if (keywords.length) {
                insights.push(`捕捉到 ${keywords.length} 个高频需求关键词：${keywords.slice(0, 5).join('、')}`);
            }
            if (opportunity.communicationCount) {
                insights.push(`客户最近 ${opportunity.communicationCount} 次沟通均提及相关需求，热度持续升温`);
            }
            if (opportunity.priority === 'high') {
                insights.push('涉及“合作/项目/采购”等强信号，存在立即决策窗口');
            } else if (opportunity.priority === 'low') {
                insights.push('信号仍在萌芽阶段，可在常规联系中持续验证需求');
            }
            return insights;
        }

        function generateOpportunitySuggestions(opportunity) {
            const suggestions = [];
            const priority = opportunity.priority || 'medium';
            const keywords = Array.isArray(opportunity.keywords) ? opportunity.keywords : [];

            if (priority === 'high') {
                suggestions.push('尽快与客户约定深度沟通，准备方案或试用资料');
                suggestions.push('邀请业务/技术同事共同参与，缩短决策链路');
            } else if (priority === 'medium') {
                suggestions.push('保持每周跟进频率，进一步确认预算与决策人');
                suggestions.push('针对关键词整理案例或成功故事，增强说服力');
            } else {
                suggestions.push('通过内容触达或活动邀约维持互动，等待需求成熟');
            }

            if (keywords.includes('定制') || keywords.includes('方案')) {
                suggestions.push('准备一份定制化方案骨架，突出客户专属价值点');
            }
            if ((opportunity.communicationCount || 0) < 3) {
                suggestions.push('沟通次数较少，可先从轻量化材料或体验引导兴趣');
            }

            return suggestions;
        }

        // 跳转到客户详情
        function goToCustomerDetail(customerId) {
            window.location.href = `/customers.html?id=${customerId}`;
        }

        // 刷新
        function refreshOpportunities() {
            setSectionLoading('opportunitiesList', '正在重新分析沟通记录...');
            loadOpportunities();
        }

        function refreshReminders() {
            setSectionLoading('birthdayReminders', '正在刷新生日提醒...');
            setSectionLoading('noContactReminders', '正在刷新待跟进客户...');
            loadReminders();
        }

        // 工具函数
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatBirthday(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return (date.getMonth() + 1) + '月' + date.getDate() + '日';
        }

        function setSectionLoading(targetId, message) {
            const container = document.getElementById(targetId);
            if (container) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-hourglass-split" style="font-size: 1.5rem;"></i>
                        <p class="mt-2 small">${escapeHtml(message)}</p>
                    </div>
                `;
            }
        }

        function setInsightsLoading() {
            const container = document.getElementById('analysisInsights');
            const timestampEl = document.getElementById('insightTimestamp');
            if (container) {
                container.innerHTML = '<div class="text-muted small">正在根据实时数据计算洞察...</div>';
            }
            if (timestampEl) {
                timestampEl.textContent = '计算中...';
            }
        }

        function renderInsights() {
            const container = document.getElementById('analysisInsights');
            const timestampEl = document.getElementById('insightTimestamp');
            if (!container) return;

            const insights = [];
            if (latestOpportunities.length > 0) {
                const highPriority = latestOpportunities.filter(item => item.priority === 'high').length;
                const topCustomer = latestOpportunities[0];
                insights.push(`识别到 <strong>${latestOpportunities.length}</strong> 个业务机会，其中 <strong>${highPriority}</strong> 个高优先级。最新机会来自 <strong>${escapeHtml(topCustomer.customerName || '未知客户')}</strong>。`);
            } else {
                insights.push('近期暂未发现新的业务机会，建议继续保持客户沟通。');
            }

            if (latestBirthdays.length > 0) {
                const upcoming = latestBirthdays[0];
                const days = typeof upcoming.daysUntil === 'number' ? upcoming.daysUntil : '-';
                insights.push(`未来7天内有 <strong>${latestBirthdays.length}</strong> 位客户生日，最近的是 <strong>${escapeHtml(upcoming.customerName || '客户')}</strong>，距离 ${days === 0 ? '今天' : days + '天'}。`);
            } else {
                insights.push('未来7天暂无客户生日，可将精力放在深度跟进。');
            }

            if (latestNoContacts.length > 0) {
                const longest = latestNoContacts[0];
                insights.push(`共有 <strong>${latestNoContacts.length}</strong> 位客户超过30天未沟通，最长未联系客户为 <strong>${escapeHtml(longest.customerName || '客户')}</strong>，已 ${longest.daysSinceLastContact || '--'} 天未联络。`);
            } else {
                insights.push('暂无超过30天未联系客户，当前维护节奏健康。');
            }

            container.innerHTML = `
                <ul class="insight-list">
                    ${insights.map(item => `<li class="insight-item">${item}</li>`).join('')}
                </ul>
            `;

            if (timestampEl) {
                timestampEl.textContent = new Date().toLocaleString('zh-CN', {
                    hour12: false,
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能推荐 - AI客户管理系统</title>
    <link href="/lib/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet">
    <script>
        // 在head中先定义函数，确保onclick可以访问
        // 这些函数将在body中的script标签中被实际实现替换
        window.openGenerateContentModal = function(initialType) {
            // 检查实际实现是否已加载
            if (typeof window._openGenerateContentModal === 'function') {
                return window._openGenerateContentModal(initialType);
            }
            // 如果实际实现还未加载，等待后重试
            var retryCount = 0;
            var maxRetries = 50;
            var checkFunction = function() {
                retryCount++;
                if (typeof window._openGenerateContentModal === 'function') {
                    window._openGenerateContentModal(initialType);
                } else if (retryCount < maxRetries) {
                    setTimeout(checkFunction, 100);
                } else {
                    console.error('openGenerateContentModal函数未初始化，请刷新页面');
                    alert('功能正在加载中，请稍候再试');
                }
            };
            checkFunction();
        };
        
        window.openSendShareModal = function() {
            // 检查实际实现是否已加载
            if (typeof window._openSendShareModal === 'function') {
                return window._openSendShareModal();
            }
            // 如果实际实现还未加载，等待后重试
            var retryCount = 0;
            var maxRetries = 50;
            var checkFunction = function() {
                retryCount++;
                if (typeof window._openSendShareModal === 'function') {
                    window._openSendShareModal();
                } else if (retryCount < maxRetries) {
                    setTimeout(checkFunction, 100);
                } else {
                    console.error('openSendShareModal函数未初始化，请刷新页面');
                    alert('功能正在加载中，请稍候再试');
                }
            };
            checkFunction();
        };
        
        // 同时定义全局函数（不使用window前缀也可以访问）
        function openGenerateContentModal(initialType) {
            return window.openGenerateContentModal(initialType);
        }
        
        function openSendShareModal() {
            return window.openSendShareModal();
        }
    </script>
</head>
<body>
    <div class="main-container ai-page">
        <!-- 页面头部 -->
        <div class="ai-header">
            <div class="ai-header-text">
                <p class="ai-label">AI智能推荐 · 内容工作台</p>
                <h1 class="ai-title">按场景选择模板，快速输出客户内容</h1>
                <p class="ai-subtitle">结合 AI 草稿与自定义创作，生成营销文案、贺卡、名片、报告等多种内容形式。</p>
            </div>
        </div>
        
        <!-- 工作流程 -->
        <div class="workflow-steps mb-4">
            <div class="step">
                <div class="step-icon"><span>1</span></div>
                <div class="step-info">
                    <div class="step-title">选择场景</div>
                    <div class="step-desc">挑选适合的内容模块，或录入自定义推荐</div>
                </div>
            </div>
            <div class="step">
                <div class="step-icon"><span>2</span></div>
                <div class="step-info">
                    <div class="step-title">生成 + 编辑</div>
                    <div class="step-desc">AI 模板输出草稿，支持自定义调整与保存</div>
                </div>
            </div>
            <div class="step">
                <div class="step-icon"><span>3</span></div>
                <div class="step-info">
                    <div class="step-title">预览发送</div>
                    <div class="step-desc">一键复制、下载、短信/邮件推送或分享</div>
                </div>
            </div>
        </div>

        <!-- 个性化推荐 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">个性化推荐</h5>
            </div>
            <div class="card-body">
                <div class="content-modules-grid mb-4">
                    <div class="content-module-card module-gradient-orange">
                        <div class="module-badge"><i class="bi bi-megaphone"></i> 长文营销</div>
                        <h5 class="module-title">长文营销文案</h5>
                        <p class="module-desc">用于新品发布、方案宣讲等深度内容，结构完整，兼顾亮点与行动号召。</p>
                        <ul class="module-highlights">
                            <li><i class="bi bi-check2-circle"></i> 亮点+价值+CTA完整结构</li>
                            <li><i class="bi bi-check2-circle"></i> 适配公众号/官网/企微</li>
                            <li><i class="bi bi-check2-circle"></i> 支持二次编辑复用模板</li>
                        </ul>
                        <div class="module-actions">
                            <div class="action-block">
                                <p class="action-label">步骤 1 · 建立模板</p>
                                <button class="btn btn-dark btn-sm w-100" onclick="openGenerateContentModal('marketing-long')">
                                    <i class="bi bi-tools"></i> 编辑模板
                                </button>
                        </div>
                            <div class="action-block">
                                <p class="action-label">步骤 2 · 推送客户</p>
                                <button class="btn btn-light btn-sm w-100" onclick="openSendShareModal()">
                                    <i class="bi bi-send"></i> 发送 / 分享
                                </button>
                    </div>
                        </div>
                    </div>
                    <div class="content-module-card module-gradient-pink">
                        <div class="module-badge"><i class="bi bi-heart"></i> 贺卡祝福</div>
                        <h5 class="module-title">祝福贺卡</h5>
                        <p class="module-desc">节日、签约、周年、感谢等场景的一键祝福，随时传达温度。</p>
                        <ul class="module-highlights">
                            <li><i class="bi bi-check2-circle"></i> 自动带入客户名称</li>
                            <li><i class="bi bi-check2-circle"></i> 支持节日/通用模板</li>
                            <li><i class="bi bi-check2-circle"></i> 适配海报、短信、公众号</li>
                        </ul>
                        <div class="module-actions">
                            <button class="btn btn-dark btn-sm" onclick="openGenerateContentModal('greeting-card')">
                                <i class="bi bi-magic"></i> 建立模板
                            </button>
                            <button class="btn btn-light btn-sm" onclick="openSendShareModal()">
                                <i class="bi bi-people"></i> 发送给客户
                            </button>
                        </div>
                    </div>
                    <div class="content-module-card module-gradient-blue">
                        <div class="module-badge"><i class="bi bi-person-badge"></i> 名片引荐</div>
                        <h5 class="module-title">客户名片速递</h5>
                        <p class="module-desc">快速汇总客户画像、需求、推荐方案，方便转发或内部协作。</p>
                        <ul class="module-highlights">
                            <li><i class="bi bi-check2-circle"></i> 包含客户联系方式</li>
                            <li><i class="bi bi-check2-circle"></i> 附后续行动建议</li>
                            <li><i class="bi bi-check2-circle"></i> 适合作为内部引荐资料</li>
                        </ul>
                        <div class="module-actions">
                            <button class="btn btn-dark btn-sm" onclick="openGenerateContentModal('business-card')">
                                <i class="bi bi-magic"></i> 建立模板
                            </button>
                            <button class="btn btn-light btn-sm" onclick="openSendShareModal()">
                                <i class="bi bi-people"></i> 发送给客户
                        </button>
                    </div>
                </div>
                    <div class="content-module-card module-gradient-indigo">
                        <div class="module-badge"><i class="bi bi-journal-text"></i> 推荐报告</div>
                        <h5 class="module-title">正式推荐报告</h5>
                        <p class="module-desc">聚焦“背景-方案-价值-执行”结构，适合管理层或客户正式汇报。</p>
                        <ul class="module-highlights">
                            <li><i class="bi bi-check2-circle"></i> 自动带入优先级与置信度</li>
                            <li><i class="bi bi-check2-circle"></i> 支持下载与分享</li>
                            <li><i class="bi bi-check2-circle"></i> 可作为项目文档留档</li>
                        </ul>
                        <div class="module-actions">
                            <button class="btn btn-dark btn-sm" onclick="openGenerateContentModal('recommendation')">
                                <i class="bi bi-magic"></i> 建立模板
                            </button>
                            <button class="btn btn-light btn-sm" onclick="openSendShareModal()">
                                <i class="bi bi-people"></i> 发送给客户
                            </button>
                                </div>
                            </div>
                    <div class="content-module-card module-gradient-purple">
                        <div class="module-badge"><i class="bi bi-lightning-charge"></i> 短促销</div>
                        <h5 class="module-title">短促销文案</h5>
                        <p class="module-desc">面向短信、Banner、朋友圈的快讯式内容，突出痛点+方案+CTA。</p>
                        <ul class="module-highlights">
                            <li><i class="bi bi-check2-circle"></i> 适配短信/IM/社群</li>
                            <li><i class="bi bi-check2-circle"></i> 强调行动呼吁</li>
                            <li><i class="bi bi-check2-circle"></i> 可快速复制使用</li>
                        </ul>
                        <div class="module-actions">
                            <button class="btn btn-dark btn-sm" onclick="openGenerateContentModal('marketing-short')">
                                <i class="bi bi-magic"></i> 建立模板
                            </button>
                            <button class="btn btn-light btn-sm" onclick="openSendShareModal()">
                                <i class="bi bi-people"></i> 发送给客户
                            </button>
                                </div>
                            </div>
                                </div>
                <div class="card template-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                            <h5 class="mb-0">我的模板</h5>
                            <small class="text-muted">保存常用内容结构，随时复用或再次编辑</small>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="openGenerateContentModal('marketing-long')">
                            <i class="bi bi-plus-circle"></i> 新建模板
                    </button>
                </div>
                    <div class="card-body" id="templateListContainer">
                        <!-- 模板列表 -->
            </div>
                </div>
                <div id="recommendationResults">
                    <!-- 推荐结果列表 -->
                </div>
            </div>
        </div>

        <!-- 历史推荐记录 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">历史推荐记录</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">89</div>
                            <div class="stat-label">已采纳</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">45</div>
                            <div class="stat-label">待处理</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">67</div>
                            <div class="stat-label">采纳率</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">92%</div>
                            <div class="stat-label">准确率</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>客户名称</th>
                                <th>推荐类型</th>
                                <th>推荐内容</th>
                                <th>优先级</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <!-- 历史记录将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 推荐详情模态框 -->
    <div class="modal fade" id="recommendationDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">推荐详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="recommendationDetailContent">
                    <!-- 推荐详情内容将通过JavaScript动态加载 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="adoptRecommendation()">
                        <i class="bi bi-check"></i> 采纳推荐
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 内容生成模态框 -->
    <div class="modal fade" id="generateContentModal" tabindex="-1" aria-labelledby="generateContentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="generateContentModalLabel">
                        <i class="bi bi-file-earmark-text"></i> 生成内容并发送
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Tab导航 - 仅在非编辑模式下显示 -->
                    <ul class="nav nav-tabs mb-3" id="contentTabs" role="tablist" style="display: none;">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="report-tab" data-bs-toggle="tab" data-bs-target="#report-pane" type="button" role="tab">
                                <i class="bi bi-file-text"></i> 推荐报告
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="template-tab" data-bs-toggle="tab" data-bs-target="#template-pane" type="button" role="tab">
                                <i class="bi bi-envelope"></i> 营销模板
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="customer-tab" data-bs-toggle="tab" data-bs-target="#customer-pane" type="button" role="tab">
                                <i class="bi bi-people"></i> 选择客户
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview-pane" type="button" role="tab">
                                <i class="bi bi-eye"></i> 发送预览
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="share-tab" data-bs-toggle="tab" data-bs-target="#share-pane" type="button" role="tab">
                                <i class="bi bi-share"></i> 分享
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab内容 -->
                    <div class="tab-content" id="contentTabContent">
                        <!-- Tab 1: 内容生成/编辑 -->
                        <div class="tab-pane fade show active" id="report-pane" role="tabpanel">
                            <!-- 内容类型选择 - 仅在非编辑模式下显示 -->
                            <div class="mb-3" id="contentTypeSelector" style="display: none;">
                                <label class="form-label">内容类型</label>
                                <select class="form-select" id="contentType" onchange="changeContentType()">
                                    <option value="recommendation">推荐报告</option>
                                    <option value="meeting">会议纪要</option>
                                    <option value="news">新闻稿</option>
                                    <option value="report">报道</option>
                                    <option value="reference">推荐信</option>
                                    <option value="marketing-long">长文营销文案</option>
                                    <option value="greeting-card">祝福贺卡</option>
                                    <option value="business-card">名片引荐</option>
                                    <option value="marketing-short">短促销文案</option>
                                </select>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0" id="contentTypeTitle">推荐报告预览</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-warning" id="editReportBtn" onclick="toggleReportEdit()">
                                        <i class="bi bi-pencil"></i> 编辑内容
                                    </button>
                                    <button class="btn btn-sm btn-outline-dark" onclick="saveCurrentTemplate()">
                                        <i class="bi bi-bookmark"></i> 保存为模板
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="downloadReport()">
                                        <i class="bi bi-download"></i> 下载
                                    </button>
                                </div>
                            </div>
                            <div id="reportContent" class="report-preview">
                                <!-- 内容将动态生成 -->
                            </div>
                            <div id="reportEditor" class="report-editor" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label" id="editorTitleLabel">标题</label>
                                    <input type="text" class="form-control" id="reportTitle" placeholder="请输入标题">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">内容 <small class="text-muted">(支持HTML格式)</small></label>
                                    <textarea class="form-control" id="reportContentEditor" rows="15" style="font-family: monospace;" placeholder="请输入内容..."></textarea>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" onclick="saveReportEdit()">
                                        <i class="bi bi-check"></i> 保存
                                    </button>
                                    <button class="btn btn-secondary" onclick="cancelReportEdit()">
                                        <i class="bi bi-x"></i> 取消
                                    </button>
                                    <button class="btn btn-outline-info" onclick="previewReportEdit()">
                                        <i class="bi bi-eye"></i> 预览
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab 2: 营销模板 -->
                        <div class="tab-pane fade" id="template-pane" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">模板类型</label>
                                <select class="form-select" id="templateType" onchange="generateTemplate()">
                                    <option value="email">邮件模板</option>
                                    <option value="sms">短信模板</option>
                                </select>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">模板内容</h6>
                                <div>
                                    <button class="btn btn-sm btn-outline-warning" id="editTemplateBtn" onclick="toggleTemplateEdit()">
                                        <i class="bi bi-pencil"></i> 编辑内容
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="copyTemplateContent()">
                                        <i class="bi bi-clipboard"></i> 复制内容
                                    </button>
                                </div>
                            </div>
                            <div id="templateContent" class="template-preview">
                                <!-- 模板内容将动态生成 -->
                            </div>
                            <div id="templateEditor" class="template-editor" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">邮件主题 / 短信标题</label>
                                    <input type="text" class="form-control" id="templateSubject" placeholder="请输入主题">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">模板内容 <small class="text-muted">(邮件支持HTML，短信为纯文本)</small></label>
                                    <textarea class="form-control" id="templateContentEditor" rows="12" style="font-family: monospace;"></textarea>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" onclick="saveTemplateEdit()">
                                        <i class="bi bi-check"></i> 保存
                                    </button>
                                    <button class="btn btn-secondary" onclick="cancelTemplateEdit()">
                                        <i class="bi bi-x"></i> 取消
                                    </button>
                                    <button class="btn btn-outline-info" onclick="previewTemplateEdit()">
                                        <i class="bi bi-eye"></i> 预览
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab 3: 选择客户 -->
                        <div class="tab-pane fade" id="customer-pane" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">客户来源</label>
                                <select class="form-select" id="customerSource" onchange="loadCustomerSelection()">
                                    <option value="recommendation">从推荐中提取</option>
                                    <option value="list">从客户列表选择</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="customerSearch" placeholder="搜索客户..." onkeyup="filterCustomers()">
                            </div>
                            <div id="customerList" class="customer-selection-list">
                                <!-- 客户列表将动态加载 -->
                            </div>
                        </div>
                        
                        <!-- Tab 4: 发送预览 -->
                        <div class="tab-pane fade" id="preview-pane" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">选择客户查看预览</label>
                                <select class="form-select" id="previewCustomerSelect" onchange="updateSendPreview()">
                                    <option value="">请选择客户</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">发送方式</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="sendType" id="sendTypeSms" value="sms" checked onchange="updateSendPreview()">
                                    <label class="btn btn-outline-primary" for="sendTypeSms">
                                        <i class="bi bi-chat-dots"></i> 短信
                                    </label>
                                    <input type="radio" class="btn-check" name="sendType" id="sendTypeEmail" value="email" onchange="updateSendPreview()">
                                    <label class="btn btn-outline-primary" for="sendTypeEmail">
                                        <i class="bi bi-envelope"></i> 邮件
                                    </label>
                                </div>
                            </div>
                            <div id="sendPreviewContent">
                                <!-- 发送预览内容将动态生成 -->
                            </div>
                        </div>
                        
                        <!-- Tab 5: 分享 -->
                        <div class="tab-pane fade" id="share-pane" role="tabpanel">
                            <div class="text-center mb-4">
                                <h6>分享推荐报告</h6>
                                <p class="text-muted">扫描二维码或复制链接分享给他人</p>
                            </div>
                            <div class="row">
                                <div class="col-md-6 text-center mb-3">
                                    <div id="qrcodeContainer" class="mb-3">
                                        <!-- 二维码将动态生成 -->
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="downloadQRCode()">
                                        <i class="bi bi-download"></i> 下载二维码
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">分享链接</label>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="shareLink" readonly>
                                        <button class="btn btn-outline-secondary" onclick="copyShareLink()">
                                            <i class="bi bi-clipboard"></i> 复制
                                        </button>
                                    </div>
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> 分享链接有效期为7天
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <button class="btn btn-outline-primary" id="footerCopyBtn" onclick="copyCurrentContent()">
                            <i class="bi bi-clipboard"></i> 复制内容
                        </button>
                        <button class="btn btn-outline-info" id="footerShareBtn" onclick="openSendShareModal()">
                            <i class="bi bi-share"></i> 分享
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 发送/分享模态框 -->
    <div class="modal fade" id="sendShareModal" tabindex="-1" aria-labelledby="sendShareModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sendShareModalLabel">
                        <i class="bi bi-send"></i> 发送给客户并分享
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 步骤1: 选择客户 -->
                    <div class="mb-4">
                        <h6 class="mb-3"><i class="bi bi-people"></i> 步骤 1: 选择客户 <span class="text-danger">*</span></h6>
                        <div class="mb-3">
                            <label class="form-label">客户来源</label>
                            <select class="form-select" id="sendCustomerSource" onchange="loadSendCustomerSelection()">
                                <option value="list">从客户列表选择</option>
                                <option value="recommendation">从推荐中提取</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="sendCustomerSearch" placeholder="搜索客户..." onkeyup="filterSendCustomers()">
                        </div>
                        <div id="sendCustomerList" class="customer-selection-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.5rem;">
                            <!-- 客户列表将动态加载 -->
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">已选择 <span id="selectedCustomerCount">0</span> 位客户</small>
                        </div>
                    </div>
                    
                    <!-- 步骤2: 生成分享链接和二维码 -->
                    <div class="mb-4" id="shareSection" style="display: none;">
                        <h6 class="mb-3"><i class="bi bi-share"></i> 步骤 2: 分享链接和二维码</h6>
                        <div class="row">
                            <div class="col-md-6 text-center mb-3">
                                <div id="sendQRCodeContainer" class="mb-3">
                                    <!-- 二维码将动态生成 -->
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="downloadSendQRCode()">
                                    <i class="bi bi-download"></i> 下载二维码
                                </button>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">分享链接</label>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="sendShareLink" readonly>
                                    <button class="btn btn-outline-secondary" onclick="copySendShareLink()">
                                        <i class="bi bi-clipboard"></i> 复制
                                    </button>
                                </div>
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> 分享链接有效期为7天
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="generateShareBtn" onclick="generateSendShareLink()" disabled>
                        <i class="bi bi-magic"></i> 生成分享链接
                    </button>
                    <button type="button" class="btn btn-success" id="sendBtn" onclick="sendToCustomers()" style="display: none;">
                        <i class="bi bi-send"></i> 发送给客户
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/lib/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" onerror="console.warn('QRCode库加载失败，二维码功能可能不可用')"></script>
    <script>
        // ========== 立即定义全局函数，确保onclick可以访问 ==========
        // 这些函数将在后面被实际实现替换
        function openGenerateContentModal(initialType) {
            if (typeof window._openGenerateContentModal === 'function') {
                return window._openGenerateContentModal(initialType);
            }
            // 如果实际实现还未加载，等待后重试
            var retryCount = 0;
            var maxRetries = 20;
            var checkFunction = function() {
                retryCount++;
                if (typeof window._openGenerateContentModal === 'function') {
                    window._openGenerateContentModal(initialType);
                } else if (retryCount < maxRetries) {
                    setTimeout(checkFunction, 50);
                } else {
                    console.error('openGenerateContentModal函数未初始化');
                }
            };
            setTimeout(checkFunction, 10);
        }
        
        function openSendShareModal() {
            if (typeof window._openSendShareModal === 'function') {
                return window._openSendShareModal();
            }
            // 如果实际实现还未加载，等待后重试
            var retryCount = 0;
            var maxRetries = 20;
            var checkFunction = function() {
                retryCount++;
                if (typeof window._openSendShareModal === 'function') {
                    window._openSendShareModal();
                } else if (retryCount < maxRetries) {
                    setTimeout(checkFunction, 50);
                } else {
                    console.error('openSendShareModal函数未初始化');
                }
            };
            setTimeout(checkFunction, 10);
        }
        
        // 将函数也添加到window对象
        window.openGenerateContentModal = openGenerateContentModal;
        window.openSendShareModal = openSendShareModal;
        
        // ========== 变量声明 ==========
        // 模拟推荐数据
        let recommendations = [];

        let selectedRecommendations = [];
        let selectedCustomers = [];
        let allCustomers = [];
        let currentReportData = null;
        let currentTemplateData = null;
        let shareLink = '';
        let isReportEditing = false;
        let isTemplateEditing = false;
        let editedReportContent = null;
        let editedTemplateContent = null;
        let currentContentType = 'recommendation'; // 当前内容类型
        let templates = JSON.parse(localStorage.getItem('aiRecommendationTemplates') || '[]');
        let tempContentSource = null;
        let savedTemplates = JSON.parse(localStorage.getItem('aiSavedTemplates') || '[]');
        let sendSelectedCustomers = []; // 发送/分享模态框中选择的客户
        let sendAllCustomers = []; // 发送/分享模态框中的全部客户
        let sendShareLink = ''; // 发送/分享的链接
        let pendingTemplateApply = null;

        function getPlaceholderRecommendation(type) {
            const base = {
                id: 'preview-' + type,
                customerName: '示例客户',
                customerPhone: '138****8888',
                customerEmail: 'client@example.com',
                type: 'service',
                title: '示例方案',
                content: '这里会展示为该模块自动生成的示例内容，生成后可继续编辑。',
                priority: 'medium',
                status: 'pending',
                createTime: new Date().toLocaleDateString('zh-CN'),
                confidence: 0.9,
                reason: '示例推荐理由，说明该方案的价值亮点。'
            };
            switch (type) {
                case 'marketing-long':
                    base.title = 'AI赋能业务增长方案';
                    base.content = '通过数据洞察与智能决策，打造差异化核心优势，帮助客户实现业绩增长。';
                    break;
                case 'greeting-card':
                    base.title = '节日温情贺卡';
                    base.content = '在重要节点送上祝福，传递品牌关怀，增进客户情感连接。';
                    break;
                case 'business-card':
                    base.title = '客户名片摘要';
                    base.content = '概括客户背景、需求与推荐主题，便于团队协同。';
                    break;
                case 'marketing-short':
                    base.title = '限时促销短讯';
                    base.content = '一句话点出客户痛点与解决方案，附带明确行动号召。';
                    break;
                default:
                    break;
            }
            return base;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 立即加载推荐结果（轻量级）
            loadRecommendationResults();
            // 延迟加载历史记录和模板列表（较重的操作）
            setTimeout(function() {
                loadHistoryRecords();
                renderTemplateList();
            }, 100);
        });


        // 加载推荐结果
        function loadRecommendationResults() {
            const container = document.getElementById('recommendationResults');
            if (!container) return;
            container.innerHTML = '';

            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-lightbulb display-1 text-muted"></i>
                        <h5 class="mt-3 text-muted">暂无推荐</h5>
                        <p class="mb-1">请先选择上方内容模块</p>
                        <p class="text-muted">勾选推荐后即可生成对应内容</p>
                    </div>
                `;
                return;
            }

            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'table-responsive';
            tableWrapper.innerHTML = `
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th style="width:40px;"></th>
                            <th>推荐主题</th>
                            <th>客户信息</th>
                            <th>类型/优先级</th>
                            <th>置信度</th>
                            <th class="text-end" style="width:150px;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="recommendationTableBody"></tbody>
                </table>
            `;
            container.appendChild(tableWrapper);

            const tbody = document.getElementById('recommendationTableBody');

            recommendations.forEach(rec => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    '综合优化建议',
                    '全方位提升方案',
                    '系统化改进建议',
                    '整体解决方案',
                    '全面升级建议'
                ]
            };
            
            const typeTitles = titles[type] || titles['all'];
            return typeTitles[index % typeTitles.length];
        }
        
        // 生成推荐内容
        function generateRecommendationContent(type, preferences, index) {
            const baseContent = {
                'product': '基于客户需求和市场分析，推荐适合的产品方案',
                'service': '根据客户反馈和业务需求，建议优化服务内容',
                'strategy': '基于市场趋势和竞争分析，提供战略建议',
                'action': '根据客户行为分析，建议采取的具体行动',
                'all': '基于综合分析，提供全面的优化建议'
            };
            
            let content = baseContent[type] || baseContent['all'];
            
            if (preferences.length > 0) {
                content += '，特别考虑' + preferences.join('、') + '的偏好设置。';
            }
            
            return content;
        }
        
        // 生成推荐理由
        function generateRecommendationReason(type, preferences, index) {
            const reasons = [
                '基于客户历史数据分析',
                '根据市场趋势预测',
                '考虑客户反馈意见',
                '结合行业最佳实践',
                '基于竞争对手分析'
            ];
            
            let reason = reasons[index % reasons.length];
            
            if (preferences.length > 0) {
                reason += '，符合' + preferences.join('、') + '的偏好要求。';
            }
            
            return reason;
        }
        
        // 生成随机手机号
        function generateRandomPhone() {
            const prefixes = ['138', '139', '137', '136', '135', '134', '133', '132', '150', '151', '152', '153'];
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const suffix = Math.floor(Math.random() * 100000000).toString().padStart(8, '0');
            return prefix + suffix;
        }
        
        // 生成随机邮箱
        function generateRandomEmail(customerName) {
            const domains = ['example.com', 'agritech.com', 'seedlab.com', 'farm.com', 'coop.com', 'seedgroup.com', 'ecoagri.com', 'modernfarm.com'];
            const domain = domains[Math.floor(Math.random() * domains.length)];
            const name = customerName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase() || 'customer';
            return name + '@' + domain;
        }
        
        // 获取随机客户名称
        function getRandomCustomerName() {
            const names = [
                '张三农业合作社', '李四种子公司', '王五科技农业', '赵六种植基地',
                '钱七农业发展', '孙八现代农业', '周九生态农业', '吴十智慧农场'
            ];
            return names[Math.floor(Math.random() * names.length)];
        }
        
        // 获取随机优先级
        function getRandomPriority() {
            const priorities = ['high', 'medium', 'low'];
            return priorities[Math.floor(Math.random() * priorities.length)];
        }
        
        // 显示推荐结果弹窗
        function showRecommendationModal(newRecommendations, type, preferences) {
            // 确保弹窗存在
            if (!document.getElementById('recommendationModal')) {
                createRecommendationModal();
            }
            
            const modalBody = document.getElementById('recommendationModalBody');
            let content = '<div class="alert alert-success">' +
                '<h6><i class="bi bi-check-circle"></i> 推荐生成成功！</h6>' +
                '<p>基于您的配置生成了 <strong>' + newRecommendations.length + '</strong> 条' + getTypeText(type) + '推荐</p>' +
                '<p><strong>偏好设置：</strong>' + (preferences.length > 0 ? preferences.join('、') : '通用设置') + '</p>' +
                '</div>' +
                '<div class="recommendation-list">' +
                '<h6>生成的推荐：</h6>';
            
            newRecommendations.forEach((rec, index) => {
                content += '<div class="card mb-2">' +
                    '<div class="card-body py-2">' +
                    '<div class="d-flex justify-content-between align-items-center">' +
                    '<div>' +
                    '<h6 class="mb-1">' + rec.title + '</h6>' +
                    '<p class="mb-1 text-muted small">' + rec.content + '</p>' +
                    '<span class="badge ' + getTypeClass(rec.type) + ' me-1">' + getTypeText(rec.type) + '</span>' +
                    '<span class="badge ' + getPriorityClass(rec.priority) + '">' + getPriorityText(rec.priority) + '</span>' +
                    '</div>' +
                    '<div class="text-end">' +
                    '<div class="text-success fw-bold">' + Math.round(rec.confidence * 100) + '%</div>' +
                    '<small class="text-muted">置信度</small>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            });
            
            content += '</div>';
            modalBody.innerHTML = content;
            
            // 显示弹窗 - 使用更安全的方式
            const modalElement = document.getElementById('recommendationModal');
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
            modal.show();
        }
        
        // 创建推荐结果弹窗
        function createRecommendationModal() {
            const modalHTML = `
                <div class="modal fade" id="recommendationModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-lightbulb text-warning"></i> AI推荐结果
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="recommendationModalBody">
                                <!-- 动态内容 -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary" onclick="viewAllRecommendations()">查看全部推荐</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // 查看全部推荐
        function viewAllRecommendations() {
            // 关闭弹窗
            const modalElement = document.getElementById('recommendationModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }
            
            // 滚动到推荐结果区域
            document.getElementById('recommendationResults').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }
        
        // 显示成功消息
        function showSuccessMessage(message) {
            // 创建成功提示
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                <i class="bi bi-check-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alert);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        }


        // 加载推荐结果
        function loadRecommendationResults() {
            const container = document.getElementById('recommendationResults');
            if (!container) return;
            container.innerHTML = '';

            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-lightbulb display-1 text-muted"></i>
                        <h5 class="mt-3 text-muted">暂无推荐</h5>
                        <p class="mb-1">请先选择上方内容模块</p>
                        <p class="text-muted">勾选推荐后即可生成对应内容</p>
                    </div>
                `;
                return;
            }

            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'table-responsive';
            tableWrapper.innerHTML = `
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th style="width:40px;"></th>
                            <th>推荐主题</th>
                            <th>客户信息</th>
                            <th>类型/优先级</th>
                            <th>置信度</th>
                            <th class="text-end" style="width:150px;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="recommendationTableBody"></tbody>
                </table>
            `;
            container.appendChild(tableWrapper);

            const tbody = document.getElementById('recommendationTableBody');

            recommendations.forEach(rec => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                                    <input type="checkbox" class="form-check-input" value="${rec.id}" onchange="toggleRecommendationSelection(${rec.id})">
                    </td>
                    <td>
                        <div class="d-flex flex-column gap-1">
                            <div class="d-flex align-items-center gap-2">
                                <span>${rec.title}</span>
                                ${rec.isCustom ? '<span class="badge bg-warning text-dark">自定义</span>' : ''}
                                </div>
                            <small class="text-muted table-cell-truncate">${rec.content}</small>
                                    </div>
                    </td>
                    <td>
                        <div class="small fw-semibold">${rec.customerName || '未填写'}</div>
                        <div class="text-muted text-xs">${rec.customerPhone || ''}${rec.customerEmail ? ' · ' + rec.customerEmail : ''}</div>
                    </td>
                    <td>
                        <span class="badge ${getTypeClass(rec.type)} me-1">${getTypeText(rec.type)}</span>
                        <span class="badge ${getPriorityClass(rec.priority)}">${getPriorityText(rec.priority)}</span>
                    </td>
                    <td>
                        <span class="badge bg-info-subtle text-info">置信度 ${Math.round((rec.confidence || 0) * 100)}%</span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-outline-secondary btn-sm" onclick="viewRecommendationDetail(${rec.id})">
                            <i class="bi bi-eye"></i>
                                    </button>
                        <button class="btn btn-outline-success btn-sm" onclick="adoptRecommendation(${rec.id})">
                            <i class="bi bi-check"></i>
                                    </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 加载历史记录
        function loadHistoryRecords() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (recommendations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">暂无历史记录，生成或保存推荐后可在此复盘</td>
                    </tr>
                `;
                return;
            }

            recommendations.forEach(rec => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="table-cell-truncate" title="${rec.customerName}">${rec.customerName || '-'}</td>
                    <td class="table-cell-truncate" title="${getTypeText(rec.type)}">${getTypeText(rec.type)}</td>
                    <td class="table-cell-truncate" title="${rec.title}">
                        ${rec.title}
                        ${rec.isCustom ? '<span class="badge bg-warning text-dark ms-2">自定义</span>' : ''}
                    </td>
                    <td><span class="badge ${getPriorityClass(rec.priority)}">${getPriorityText(rec.priority)}</span></td>
                    <td><span class="badge ${getStatusClass(rec.status)}">${getStatusText(rec.status)}</span></td>
                    <td class="table-cell-truncate" title="${rec.createTime}">${rec.createTime}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm" onclick="viewRecommendationDetail(${rec.id})" title="查看详情">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="adoptRecommendation(${rec.id})" title="采纳推荐">
                            <i class="bi bi-check"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 查看推荐详情
        function viewRecommendationDetail(id) {
            const rec = recommendations.find(r => r.id === id);
            if (rec) {
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>基本信息</h6>
                            <p><strong>客户名称：</strong>${rec.customerName}</p>
                            <p><strong>推荐类型：</strong>${getTypeText(rec.type)}</p>
                            <p><strong>优先级：</strong>${getPriorityText(rec.priority)}</p>
                            <p><strong>状态：</strong>${getStatusText(rec.status)}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>详细信息</h6>
                            <p><strong>置信度：</strong>${Math.round(rec.confidence * 100)}%</p>
                            <p><strong>创建时间：</strong>${rec.createTime}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>推荐内容</h6>
                            <p>${rec.content}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>推荐理由</h6>
                            <p>${rec.reason}</p>
                        </div>
                    </div>
                `;
                document.getElementById('recommendationDetailContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('recommendationDetailModal')).show();
            }
        }

        // 采纳推荐
        function adoptRecommendation(id) {
            const rec = recommendations.find(r => r.id === id);
            if (rec) {
                rec.status = 'adopted';
                rec.modifyTime = new Date().toISOString().split('T')[0];
                loadRecommendationResults();
                loadHistoryRecords();
                bootstrap.Modal.getInstance(document.getElementById('recommendationDetailModal')).hide();
                alert('推荐已采纳！');
            }
        }

        // 切换推荐选择状态
        function toggleRecommendationSelection(id) {
            const index = selectedRecommendations.indexOf(id);
            if (index > -1) {
                selectedRecommendations.splice(index, 1);
            } else {
                selectedRecommendations.push(id);
            }
        }
        

        // 批量采纳
        function batchAdopt() {
            if (selectedRecommendations.length === 0) {
                alert('请先选择要采纳的推荐！');
                return;
            }
            
            if (confirm(`确定要采纳选中的 ${selectedRecommendations.length} 条推荐吗？`)) {
                selectedRecommendations.forEach(id => {
                    const rec = recommendations.find(r => r.id === id);
                    if (rec) {
                        rec.status = 'adopted';
                        rec.modifyTime = new Date().toISOString().split('T')[0];
                    }
                });
                selectedRecommendations = [];
                loadRecommendationResults();
                loadHistoryRecords();
                alert('批量采纳成功！');
            }
        }

        // 导出推荐
        function exportRecommendations() {
            const dataStr = JSON.stringify(recommendations, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `recommendations_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // 获取类型样式类
        function getTypeClass(type) {
            switch (type) {
                case 'product': return 'bg-primary';
                case 'service': return 'bg-success';
                case 'strategy': return 'bg-warning';
                case 'action': return 'bg-info';
                default: return 'bg-secondary';
            }
        }

        // 获取优先级样式类
        function getPriorityClass(priority) {
            switch (priority) {
                case 'high': return 'bg-danger';
                case 'medium': return 'bg-warning';
                case 'low': return 'bg-success';
                default: return 'bg-secondary';
            }
        }

        // 获取状态样式类
        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-warning';
                case 'adopted': return 'bg-success';
                case 'rejected': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // 获取类型文本
        function getTypeText(type) {
            switch (type) {
                case 'product': return '产品推荐';
                case 'service': return '服务推荐';
                case 'strategy': return '策略推荐';
                case 'action': return '行动推荐';
                default: return '未知';
            }
        }

        // 获取优先级文本
        function getPriorityText(priority) {
            switch (priority) {
                case 'high': return '高';
                case 'medium': return '中';
                case 'low': return '低';
                default: return '未知';
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            switch (status) {
                case 'pending': return '待处理';
                case 'adopted': return '已采纳';
                case 'rejected': return '已拒绝';
                default: return '未知';
            }
        }

        // ========== 内容生成功能 ==========
        
        // 打开内容生成模态框（实际实现）
        function _openGenerateContentModal(initialType = null) {
            if (selectedRecommendations.length === 0 && !initialType) {
                alert('请先选择要生成内容的推荐！');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('generateContentModal'));
            modal.show();
            
            // 如果是编辑模板模式（传入了类型）
            if (initialType) {
                // 隐藏Tab导航和内容类型选择
                document.getElementById('contentTabs').style.display = 'none';
                document.getElementById('contentTypeSelector').style.display = 'none';
                
                // 设置内容类型
                document.getElementById('contentType').value = initialType;
                
                // 更新标题
                const typeNames = {
                    'recommendation': '推荐报告',
                    'meeting': '会议纪要',
                    'news': '新闻稿',
                    'report': '报道',
                    'reference': '推荐信',
                    'marketing-long': '长文营销文案',
                    'greeting-card': '祝福贺卡',
                    'business-card': '名片引荐',
                    'marketing-short': '短促销文案'
                };
                document.getElementById('generateContentModalLabel').innerHTML = 
                    '<i class="bi bi-pencil"></i> 编辑模板 - ' + typeNames[initialType];
                document.getElementById('contentTypeTitle').textContent = typeNames[initialType];
                
                // 直接生成内容（如果没有推荐，使用占位数据）
                setTimeout(() => {
                    if (selectedRecommendations.length === 0) {
                        // 使用占位数据生成内容
                        const placeholder = getPlaceholderRecommendation(initialType);
                        currentContentType = initialType;
                        generateContentByType([placeholder]);
                    } else {
                        currentContentType = initialType;
                        changeContentType();
                    }
                }, 100);
            } else {
                // 普通模式：显示Tab导航和内容类型选择
                document.getElementById('contentTabs').style.display = 'flex';
                document.getElementById('contentTypeSelector').style.display = 'block';
                document.getElementById('generateContentModalLabel').innerHTML = 
                    '<i class="bi bi-file-earmark-text"></i> 生成内容并发送';
                changeContentType();
                
                // 监听Tab切换事件，自动生成内容
                const tabButtons = document.querySelectorAll('#contentTabs button[data-bs-toggle="tab"]');
                tabButtons.forEach(button => {
                    button.addEventListener('shown.bs.tab', function(event) {
                        const targetId = event.target.getAttribute('data-bs-target');
                        if (targetId === '#template-pane') {
                            generateTemplate();
                        } else if (targetId === '#customer-pane') {
                            loadCustomerSelection();
                        } else if (targetId === '#preview-pane') {
                            updatePreviewCustomerSelect();
                        } else if (targetId === '#share-pane') {
                            if (!shareLink) {
                                generateShareLink();
                            }
                        }
                    });
                });
            }
        }
        
        // 切换内容类型
        function changeContentType() {
            currentContentType = document.getElementById('contentType').value;
            const typeNames = {
                'recommendation': '推荐报告',
                'meeting': '会议纪要',
                'news': '新闻稿',
                'report': '报道',
                'reference': '推荐信',
                'marketing-long': '长文营销文案',
                'greeting-card': '祝福贺卡',
                'business-card': '名片引荐',
                'marketing-short': '短促销文案'
            };
            
            document.getElementById('contentTypeTitle').textContent = typeNames[currentContentType] + '预览';
            document.getElementById('editorTitleLabel').textContent = typeNames[currentContentType] + '标题';
            
            // 根据类型生成内容
            generateContentByType();
        }
        
        // 根据类型生成内容
        function generateContentByType(customRecs = null) {
            const selectedRecs = customRecs || recommendations.filter(r => selectedRecommendations.includes(r.id));
            if (selectedRecs.length === 0) {
                document.getElementById('reportContent').innerHTML = '<p class="text-muted">请先选择想要生成内容的推荐</p>';
                return;
            }
            
            switch(currentContentType) {
                case 'recommendation':
                    generateRecommendationReport(selectedRecs);
                    break;
                case 'meeting':
                    generateMeetingMinutes(selectedRecs);
                    break;
                case 'news':
                    generateNewsArticle(selectedRecs);
                    break;
                case 'report':
                    generateReport(selectedRecs);
                    break;
                case 'reference':
                    generateReferenceLetter(selectedRecs);
                    break;
                case 'marketing-long':
                    generateLongMarketingCopy(selectedRecs);
                    break;
                case 'greeting-card':
                    generateGreetingCard(selectedRecs);
                    break;
                case 'business-card':
                    generateBusinessCard(selectedRecs);
                    break;
                case 'marketing-short':
                    generateShortMarketingCopy(selectedRecs);
                    break;
                default:
                    generateRecommendationReport(selectedRecs);
            }
        }
        
        function previewModule(type) {
            const previousSelection = [...selectedRecommendations];
            if (recommendations.length === 0) {
                const placeholder = getPlaceholderRecommendation(type);
                document.getElementById('contentType').value = type;
                generateContentByType([placeholder]);
                document.getElementById('reportContent').scrollIntoView({ behavior: 'smooth' });
                selectedRecommendations = previousSelection;
                return;
            }
            if (selectedRecommendations.length === 0 && recommendations.length > 0) {
                selectedRecommendations = [recommendations[0].id];
            }
            document.getElementById('contentType').value = type;
            generateContentByType();
            document.getElementById('reportContent').scrollIntoView({ behavior: 'smooth' });
            selectedRecommendations = previousSelection;
        }

        // 生成推荐报告
        function generateRecommendationReport(customList = null) {
            const selectedRecs = customList || recommendations.filter(r => selectedRecommendations.includes(r.id));
            if (selectedRecs.length === 0) {
                document.getElementById('reportContent').innerHTML = '<p class="text-muted">请先选择想要生成内容的推荐</p>';
                return;
            }
            
            let reportHtml = `
                <div class="report-header mb-4">
                    <h3>AI智能推荐报告</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                    <p class="text-muted">推荐数量：${selectedRecs.length} 条</p>
                </div>
                <div class="report-body">
            `;
            
            selectedRecs.forEach((rec, index) => {
                reportHtml += `
                    <div class="report-item mb-4 p-3 border rounded">
                        <h5 class="mb-3">推荐 ${index + 1}: ${rec.title}</h5>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <strong>客户名称：</strong>${rec.customerName || '未指定'}
                            </div>
                            <div class="col-md-6">
                                <strong>推荐类型：</strong><span class="badge ${getTypeClass(rec.type)}">${getTypeText(rec.type)}</span>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <strong>优先级：</strong><span class="badge ${getPriorityClass(rec.priority)}">${getPriorityText(rec.priority)}</span>
                            </div>
                            <div class="col-md-6">
                                <strong>置信度：</strong>${Math.round(rec.confidence * 100)}%
                            </div>
                        </div>
                        <div class="mb-2">
                            <strong>推荐内容：</strong>
                            <p class="mt-2">${rec.content}</p>
                        </div>
                        <div class="mb-2">
                            <strong>推荐理由：</strong>
                            <p class="mt-2">${rec.reason || '无'}</p>
                        </div>
                        <div class="text-muted small">
                            <strong>创建时间：</strong>${rec.createTime || '未知'}
                        </div>
                    </div>
                `;
            });
            
            reportHtml += `
                </div>
                <div class="report-footer mt-4 pt-3 border-top">
                    <p class="text-muted small">本报告由AI智能推荐系统自动生成</p>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = reportHtml;
            currentReportData = reportHtml;
            editedReportContent = null; // 重置编辑内容
            
            // 自动生成分享链接
            generateShareLink();
        }
        
        // 生成会议纪要
        function generateMeetingMinutes(selectedRecs) {
            const date = new Date().toLocaleDateString('zh-CN');
            const time = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
            
            let content = `会议纪要

会议主题：基于AI智能推荐的业务讨论会
会议时间：${date} ${time}
会议地点：线上会议
主持人：系统管理员
记录人：AI智能推荐系统

一、会议目的
本次会议旨在讨论和评估AI智能推荐系统生成的${selectedRecs.length}条推荐方案，确定后续行动计划和资源分配。

二、推荐内容讨论

`;
            
            selectedRecs.forEach((rec, index) => {
                content += `${index + 1}. ${rec.title}
   客户：${rec.customerName || '未指定'}
   类型：${getTypeText(rec.type)}
   优先级：${getPriorityText(rec.priority)}
   推荐内容：${rec.content}
   推荐理由：${rec.reason || '无'}
   
`;
            });
            
            content += `三、讨论要点
1. 对推荐方案的可行性进行了深入讨论
2. 分析了各推荐方案的优先级和资源需求
3. 确定了重点推进的推荐项目

四、决议事项
1. 采纳部分高优先级推荐方案
2. 安排专人跟进推荐方案的执行
3. 定期回顾推荐效果，优化推荐策略

五、后续行动
1. 制定详细的执行计划
2. 分配责任人和时间节点
3. 建立跟踪机制，定期汇报进展

六、会议总结
本次会议对AI智能推荐系统生成的推荐方案进行了全面评估，为后续业务发展提供了重要参考。与会人员一致认为，应充分利用AI推荐系统的优势，持续优化推荐策略，提升业务效率。

记录时间：${new Date().toLocaleString('zh-CN')}
`;
            
            const html = `
                <div class="report-header mb-4">
                    <h3>会议纪要</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <div class="report-body">
                    <div style="white-space: pre-wrap; line-height: 1.8; font-family: 'Microsoft YaHei', sans-serif;">${escapeHtml(content)}</div>
                </div>
                <div class="report-footer mt-4 pt-3 border-top">
                    <p class="text-muted small">本会议纪要由AI智能推荐系统自动生成</p>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = html;
            currentReportData = html;
            editedReportContent = null;
            generateShareLink();
        }
        
        // 生成新闻稿
        function generateNewsArticle(selectedRecs) {
            const date = new Date().toLocaleDateString('zh-CN');
            
            let content = `AI智能推荐系统助力业务发展，${selectedRecs.length}项推荐方案正式发布

【本网讯】${date}，AI智能推荐系统基于大数据分析和人工智能算法，成功生成${selectedRecs.length}项专业推荐方案，为业务发展提供有力支撑。

据了解，本次发布的推荐方案涵盖产品推荐、服务优化、策略制定等多个维度，旨在帮助企业更好地把握市场机遇，提升业务竞争力。

一、推荐方案亮点

`;
            
            selectedRecs.forEach((rec, index) => {
                content += `${index + 1}. ${rec.title}
   本次推荐针对${rec.customerName || '目标客户'}，提出了${rec.content}。该方案具有${getPriorityText(rec.priority)}优先级，置信度达到${Math.round(rec.confidence * 100)}%，${rec.reason || '具有较高的实施价值'}。

`;
            });
            
            content += `二、技术优势
AI智能推荐系统采用先进的机器学习算法，能够深度分析客户需求、市场趋势和业务数据，自动生成精准的推荐方案。系统具备以下优势：
- 数据驱动：基于海量真实业务数据进行分析
- 智能决策：运用AI算法识别最佳业务机会
- 持续优化：根据反馈不断改进推荐质量

三、应用前景
专家表示，AI智能推荐系统的应用将显著提升业务决策效率，帮助企业快速响应市场变化，实现精准营销和资源优化配置。

未来，系统将持续升级优化，为更多企业提供智能化业务推荐服务，推动行业数字化转型。

【记者】AI智能推荐系统
【编辑】系统管理员
【发布时间】${new Date().toLocaleString('zh-CN')}
`;
            
            const html = `
                <div class="report-header mb-4">
                    <h3>新闻稿</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <div class="report-body">
                    <div style="white-space: pre-wrap; line-height: 1.8; font-family: 'Microsoft YaHei', sans-serif;">${escapeHtml(content)}</div>
                </div>
                <div class="report-footer mt-4 pt-3 border-top">
                    <p class="text-muted small">本新闻稿由AI智能推荐系统自动生成</p>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = html;
            currentReportData = html;
            editedReportContent = null;
            generateShareLink();
        }
        
        // 生成报道
        function generateReport(selectedRecs) {
            const date = new Date().toLocaleDateString('zh-CN');
            
            let content = `AI智能推荐系统业务分析报道

时间：${date}
来源：AI智能推荐系统
作者：系统分析员

一、概述
本文对AI智能推荐系统近期生成的${selectedRecs.length}项推荐方案进行深度分析，从多个维度评估推荐价值，为业务决策提供参考。

二、推荐方案分析

`;
            
            selectedRecs.forEach((rec, index) => {
                content += `方案${index + 1}：${rec.title}

客户信息：${rec.customerName || '未指定'}
推荐类型：${getTypeText(rec.type)}
优先级评估：${getPriorityText(rec.priority)}
置信度：${Math.round(rec.confidence * 100)}%

方案内容：
${rec.content}

推荐理由：
${rec.reason || '基于数据分析得出的专业建议'}

实施建议：
1. 评估方案可行性和资源需求
2. 制定详细的执行计划
3. 建立效果跟踪机制
4. 根据反馈持续优化

---
`;
            });
            
            content += `三、综合分析
通过对${selectedRecs.length}项推荐方案的深入分析，我们发现：
1. 推荐方案覆盖了产品、服务、策略等多个业务领域
2. 高优先级推荐占比${Math.round(selectedRecs.filter(r => r.priority === 'high').length / selectedRecs.length * 100)}%，体现了系统对重要机会的识别能力
3. 平均置信度达到${Math.round(selectedRecs.reduce((sum, r) => sum + r.confidence, 0) / selectedRecs.length * 100)}%，推荐质量较高

四、结论与建议
AI智能推荐系统通过智能分析，为业务发展提供了有价值的参考。建议：
1. 优先实施高优先级推荐方案
2. 建立推荐方案执行跟踪机制
3. 持续优化推荐算法，提升推荐精准度
4. 加强推荐结果与实际业务效果的关联分析

报告生成时间：${new Date().toLocaleString('zh-CN')}
`;
            
            const html = `
                <div class="report-header mb-4">
                    <h3>业务分析报道</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <div class="report-body">
                    <div style="white-space: pre-wrap; line-height: 1.8; font-family: 'Microsoft YaHei', sans-serif;">${escapeHtml(content)}</div>
                </div>
                <div class="report-footer mt-4 pt-3 border-top">
                    <p class="text-muted small">本报道由AI智能推荐系统自动生成</p>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = html;
            currentReportData = html;
            editedReportContent = null;
            generateShareLink();
        }
        
        // 生成推荐信
        function generateReferenceLetter(selectedRecs) {
            const date = new Date().toLocaleDateString('zh-CN');
            
            let content = `推荐信

尊敬的合作伙伴：

您好！

基于我们对${selectedRecs.length}项AI智能推荐方案的深入分析和评估，我们诚挚地向您推荐以下业务机会和合作方案。

一、推荐背景
经过AI智能推荐系统的专业分析，我们识别出${selectedRecs.length}项具有较高价值的业务推荐方案。这些方案基于真实业务数据和市场分析，旨在为双方创造更大的商业价值。

二、推荐方案详情

`;
            
            selectedRecs.forEach((rec, index) => {
                content += `推荐${index + 1}：${rec.title}

针对客户：${rec.customerName || '目标客户群体'}
推荐类型：${getTypeText(rec.type)}
优先级：${getPriorityText(rec.priority)}
置信度：${Math.round(rec.confidence * 100)}%

方案描述：
${rec.content}

推荐理由：
${rec.reason || '该方案具有较高的实施价值和市场潜力'}

预期收益：
- 提升业务效率
- 增强市场竞争力
- 创造新的商业价值

---
`;
            });
            
            content += `三、合作建议
我们建议双方就上述推荐方案进行深入沟通，共同探讨合作机会。我们相信，通过双方的共同努力，这些推荐方案将为彼此带来显著的商业价值。

四、后续安排
1. 安排专题会议，详细讨论推荐方案
2. 制定合作计划和时间表
3. 建立定期沟通机制
4. 跟踪方案执行效果

我们期待与您进一步沟通，共同推进这些推荐方案的落地实施。

此致
敬礼！

AI智能推荐系统
${date}

联系方式：
电话：400-XXX-XXXX
邮箱：recommendation@example.com
`;
            
            const html = `
                <div class="report-header mb-4">
                    <h3>推荐信</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <div class="report-body">
                    <div style="white-space: pre-wrap; line-height: 1.8; font-family: 'Microsoft YaHei', sans-serif;">${escapeHtml(content)}</div>
                </div>
                <div class="report-footer mt-4 pt-3 border-top">
                    <p class="text-muted small">本推荐信由AI智能推荐系统自动生成</p>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = html;
            currentReportData = html;
            editedReportContent = null;
            generateShareLink();
        }
        
        // 生成营销文稿
        function generateLongMarketingCopy(selectedRecs) {
            const date = new Date().toLocaleDateString('zh-CN');
            
            let content = `【营销文稿】AI智能推荐 - 为您的业务赋能

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📢 重磅推荐 | ${selectedRecs.length}项专业方案，助力业务腾飞

亲爱的合作伙伴：

在这个快速变化的商业环境中，精准的决策和专业的方案是成功的关键。AI智能推荐系统为您精心准备了${selectedRecs.length}项专业推荐方案，助您把握商机，实现业务突破！

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✨ 推荐亮点

`;
            
            selectedRecs.forEach((rec, index) => {
                content += `🎯 方案${index + 1}：${rec.title}

👤 目标客户：${rec.customerName || '精准定位'}
📊 推荐类型：${getTypeText(rec.type)}
⭐ 优先级：${getPriorityText(rec.priority)}
🎯 置信度：${Math.round(rec.confidence * 100)}%

💡 方案内容：
${rec.content}

💎 核心优势：
${rec.reason || '基于AI智能分析，具有较高的实施价值'}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

`;
            });
            
            content += `🚀 为什么选择我们的推荐方案？

✅ 数据驱动：基于海量真实业务数据，确保推荐精准
✅ AI智能：运用先进算法，识别最佳业务机会
✅ 专业可靠：${Math.round(selectedRecs.reduce((sum, r) => sum + r.confidence, 0) / selectedRecs.length * 100)}%平均置信度，质量有保障
✅ 持续优化：根据反馈不断改进，提供更优质服务

📈 预期收益

通过实施这些推荐方案，您将获得：
• 提升业务效率${Math.round(Math.random() * 20 + 10)}%
• 增强市场竞争力
• 创造新的商业价值
• 优化资源配置

🎁 限时优惠

现在联系我们，即可享受：
• 免费方案咨询
• 专业团队支持
• 全程跟踪服务

📞 立即行动

不要错过这个提升业务的机会！立即联系我们，让AI智能推荐系统为您的业务赋能！

联系方式：
📱 电话：400-XXX-XXXX
📧 邮箱：marketing@example.com
🌐 官网：www.example.com

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

生成时间：${new Date().toLocaleString('zh-CN')}
AI智能推荐系统 | 让智能为业务赋能
`;
            
            const html = `
                <div class="report-header mb-4">
                    <h3>长文营销文案</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <div class="report-body">
                    <div style="white-space: pre-wrap; line-height: 1.8; font-family: 'Microsoft YaHei', sans-serif;">${escapeHtml(content)}</div>
                </div>
                <div class="report-footer mt-4 pt-3 border-top">
                    <p class="text-muted small">本长文营销文案由AI智能推荐系统自动生成</p>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = html;
            currentReportData = html;
            editedReportContent = null;
            generateShareLink();
        }

        // 生成祝福贺卡
        function generateGreetingCard(selectedRecs) {
            const customer = selectedRecs[0] || {};
            const date = new Date().toLocaleDateString('zh-CN');
            const content = `亲爱的 ${customer.customerName || '合作伙伴'}：

🌟 ${date}，谨以此信向您致以最真挚的祝福！

愿您的事业如春日繁花，蓬勃向上；愿您的团队如夏日繁星，闪耀前程；愿您的生活如秋日收获，硕果累累；愿您的每个梦想，都能如冬日暖阳，温暖而绽放。

感谢您一直以来的信任与支持，AI智能推荐团队将以专业与真诚，为您持续护航。

愿我们携手同行，共赴精彩！

顺祝
商祺 🌸

AI智能推荐团队
${date}`;

            const html = `
                <div class="report-header mb-4">
                    <h3>祝福贺卡</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <div class="report-body">
                    <div class="p-4 bg-light rounded" style="white-space: pre-wrap; line-height: 2; font-size: 1rem;">
                        ${escapeHtml(content)}
                    </div>
                </div>
                <div class="report-footer mt-4 pt-3 border-top">
                    <p class="text-muted small">本祝福内容由AI智能推荐系统自动生成</p>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
            currentReportData = html;
            editedReportContent = null;
            generateShareLink();
        }

        // 生成名片引荐
        function generateBusinessCard(selectedRecs) {
            const customer = selectedRecs[0] || {};
            const summary = `【客户名片】

客户：${customer.customerName || '未命名客户'}
业务方向：${getTypeText(customer.type || 'product')}
优先级：${getPriorityText(customer.priority || 'medium')}
联系方式：${customer.customerPhone || '暂无'} / ${customer.customerEmail || '暂无'}

推荐主题：${customer.title || '重点合作方案'}
推荐摘要：${customer.content || '请补充关键方案内容'}

后续建议：
1. 安排深入沟通，明确需求
2. 匹配资源与服务计划
3. 设定跟进节点，跟踪反馈

AI智能推荐系统
${new Date().toLocaleDateString('zh-CN')}`;

            const html = `
                <div class="report-header mb-4">
                    <h3>名片引荐</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <div class="report-body">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body" style="white-space: pre-wrap; line-height: 1.8; font-family: 'Microsoft YaHei', sans-serif;">
                            ${escapeHtml(summary)}
                        </div>
                    </div>
                </div>
                <div class="report-footer mt-4 pt-3 border-top">
                    <p class="text-muted small">本名片内容由AI智能推荐系统自动生成</p>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
            currentReportData = html;
            editedReportContent = null;
            generateShareLink();
        }

        // 生成短促销文案
        function generateShortMarketingCopy(selectedRecs) {
            const customer = selectedRecs[0] || {};
            const content = `【限时特惠 | ${customer.title || '高价值方案'}】

🎯 客户：${customer.customerName || '尊贵客户'}
⚡ 推荐：${customer.content || '高效方案/高价值服务'}
💡 优势：${customer.reason || '助您提效增收'}

即刻联系专属顾问，尊享定制支持！📞 ${customer.customerPhone || '400-XXX-XXXX'}`;

            const html = `
                <div class="report-header mb-4">
                    <h3>短促销文案</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <div class="report-body">
                    <div class="marketing-short-banner">
                        <div style="white-space: pre-wrap; line-height: 1.6; font-weight: 500;">
                            ${escapeHtml(content)}
                        </div>
                    </div>
                </div>
                <div class="report-footer mt-4 pt-3 border-top">
                    <p class="text-muted small">本短促销文案由AI智能推荐系统自动生成</p>
                </div>
            `;

            document.getElementById('reportContent').innerHTML = html;
            currentReportData = html;
            editedReportContent = null;
            generateShareLink();
        }
        
        // 切换报告编辑模式
        function toggleReportEdit() {
            isReportEditing = !isReportEditing;
            const previewDiv = document.getElementById('reportContent');
            const editorDiv = document.getElementById('reportEditor');
            const editBtn = document.getElementById('editReportBtn');
            
            if (isReportEditing) {
                // 切换到编辑模式
                previewDiv.style.display = 'none';
                editorDiv.style.display = 'block';
                editBtn.innerHTML = '<i class="bi bi-x"></i> 取消编辑';
                editBtn.classList.remove('btn-outline-warning');
                editBtn.classList.add('btn-outline-danger');
                
                // 填充编辑器内容
                const typeNames = {
                    'recommendation': 'AI智能推荐报告',
                    'meeting': '会议纪要',
                    'news': '新闻稿',
                    'report': '业务分析报道',
                    'reference': '推荐信',
                    'marketing-long': '长文营销文案',
                    'greeting-card': '祝福贺卡',
                    'business-card': '名片引荐',
                    'marketing-short': '短促销文案'
                };
                document.getElementById('reportTitle').value = typeNames[currentContentType] || '内容标题';
                if (editedReportContent) {
                    document.getElementById('reportContentEditor').value = editedReportContent;
                } else {
                    // 将HTML转换为纯文本（简化版）
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = currentReportData || '';
                    document.getElementById('reportContentEditor').value = tempDiv.innerText || tempDiv.textContent || '';
                }
            } else {
                // 切换到预览模式
                previewDiv.style.display = 'block';
                editorDiv.style.display = 'none';
                editBtn.innerHTML = '<i class="bi bi-pencil"></i> 编辑内容';
                editBtn.classList.remove('btn-outline-danger');
                editBtn.classList.add('btn-outline-warning');
            }
        }
        
        // 保存报告编辑
        function saveReportEdit() {
            const title = document.getElementById('reportTitle').value;
            const content = document.getElementById('reportContentEditor').value;
            
            if (!content.trim()) {
                alert('内容不能为空！');
                return;
            }
            
            const typeNames = {
                'recommendation': '推荐报告',
                'meeting': '会议纪要',
                'news': '新闻稿',
                'report': '业务分析报道',
                'reference': '推荐信',
                'marketing-long': '长文营销文案',
                'greeting-card': '祝福贺卡',
                'business-card': '名片引荐',
                'marketing-short': '短促销文案'
            };
            
            // 生成新的报告HTML
            const newReportHtml = `
                <div class="report-header mb-4">
                    <h3>${escapeHtml(title)}</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <div class="report-body">
                    <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(content)}</div>
                </div>
                <div class="report-footer mt-4 pt-3 border-top">
                    <p class="text-muted small">本${typeNames[currentContentType] || '内容'}由AI智能推荐系统自动生成</p>
                </div>
            `;
            
            // 更新显示
            document.getElementById('reportContent').innerHTML = newReportHtml;
            currentReportData = newReportHtml;
            editedReportContent = content;
            
            // 退出编辑模式
            toggleReportEdit();
            
            // 重新生成分享链接
            generateShareLink();
            
            alert('报告内容已保存！');
        }
        
        // 取消报告编辑
        function cancelReportEdit() {
            toggleReportEdit();
        }
        
        // 预览报告编辑
        function previewReportEdit() {
            const title = document.getElementById('reportTitle').value;
            const content = document.getElementById('reportContentEditor').value;
            
            if (!content.trim()) {
                alert('报告内容不能为空！');
                return;
            }
            
            const previewHtml = `
                <div class="report-header mb-4">
                    <h3>${escapeHtml(title)}</h3>
                    <p class="text-muted">生成时间：${new Date().toLocaleString('zh-CN')}</p>
                </div>
                <div class="report-body">
                    <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(content)}</div>
                </div>
            `;
            
            // 临时显示预览
            const previewDiv = document.getElementById('reportContent');
            const originalContent = previewDiv.innerHTML;
            previewDiv.innerHTML = previewHtml;
            previewDiv.style.display = 'block';
            
            setTimeout(() => {
                previewDiv.innerHTML = originalContent;
                previewDiv.style.display = 'none';
            }, 3000);
        }
        
        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 生成营销模板
        function generateTemplate() {
            const templateType = document.getElementById('templateType').value;
            const selectedRecs = recommendations.filter(r => selectedRecommendations.includes(r.id));
            if (selectedRecs.length === 0) {
                document.getElementById('templateContent').innerHTML = '<p class="text-muted">没有选中的推荐</p>';
                return;
            }
            
            let templateHtml = '';
            
            if (templateType === 'email') {
                // 邮件模板
                templateHtml = `
                    <div class="email-template p-4 border rounded">
                        <div class="email-header mb-3">
                            <h5>主题：${selectedRecs.length > 1 ? '多项智能推荐' : selectedRecs[0].title}</h5>
                            <p class="text-muted small">发件人：AI智能推荐系统</p>
                        </div>
                        <div class="email-body">
                            <p>尊敬的客户，</p>
                            <p>您好！基于您的业务需求，我们为您准备了以下智能推荐：</p>
                            <div class="recommendations-list mt-3">
                `;
                
                selectedRecs.forEach((rec, index) => {
                    templateHtml += `
                        <div class="recommendation-item mb-3 p-3 bg-light rounded">
                            <h6>${index + 1}. ${rec.title}</h6>
                            <p>${rec.content}</p>
                            <p class="small text-muted">推荐理由：${rec.reason || '无'}</p>
                            <p class="small">
                                <span class="badge ${getPriorityClass(rec.priority)}">${getPriorityText(rec.priority)}优先级</span>
                                <span class="badge bg-info">置信度 ${Math.round(rec.confidence * 100)}%</span>
                            </p>
                        </div>
                    `;
                });
                
                templateHtml += `
                            </div>
                            <p class="mt-3">如有任何疑问或需要进一步了解，欢迎随时联系我们。</p>
                            <p>此致<br>敬礼！</p>
                            <p class="mt-3">AI智能推荐系统<br>${new Date().toLocaleDateString('zh-CN')}</p>
                        </div>
                    </div>
                `;
            } else {
                // 短信模板
                let smsText = `【AI智能推荐】`;
                if (selectedRecs.length === 1) {
                    smsText += `${selectedRecs[0].title}。${selectedRecs[0].content}`;
                } else {
                    smsText += `为您推荐${selectedRecs.length}项内容：`;
                    selectedRecs.forEach((rec, index) => {
                        smsText += `${index + 1}.${rec.title}；`;
                    });
                }
                smsText += `详情请查看推荐报告。`;
                
                templateHtml = `
                    <div class="sms-template p-4 border rounded bg-light">
                        <div class="sms-preview">
                            <div class="sms-header mb-2">
                                <span class="badge bg-primary">短信模板</span>
                                <span class="text-muted small ms-2">约 ${smsText.length} 字</span>
                            </div>
                            <div class="sms-content p-3 bg-white rounded border">
                                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">${smsText}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('templateContent').innerHTML = templateHtml;
            currentTemplateData = templateHtml;
            editedTemplateContent = null; // 重置编辑内容
        }
        
        // 切换模板编辑模式
        function toggleTemplateEdit() {
            isTemplateEditing = !isTemplateEditing;
            const previewDiv = document.getElementById('templateContent');
            const editorDiv = document.getElementById('templateEditor');
            const editBtn = document.getElementById('editTemplateBtn');
            
            if (isTemplateEditing) {
                // 切换到编辑模式
                previewDiv.style.display = 'none';
                editorDiv.style.display = 'block';
                editBtn.innerHTML = '<i class="bi bi-x"></i> 取消编辑';
                editBtn.classList.remove('btn-outline-warning');
                editBtn.classList.add('btn-outline-danger');
                
                // 填充编辑器内容
                const templateType = document.getElementById('templateType').value;
                if (editedTemplateContent) {
                    document.getElementById('templateContentEditor').value = editedTemplateContent;
                } else {
                    // 从预览中提取文本内容
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = currentTemplateData || '';
                    let textContent = '';
                    
                    if (templateType === 'email') {
                        // 邮件模板，提取文本
                        textContent = tempDiv.innerText || tempDiv.textContent || '';
                    } else {
                        // 短信模板，提取pre标签内容
                        const pre = tempDiv.querySelector('pre');
                        textContent = pre ? pre.textContent : tempDiv.innerText || '';
                    }
                    
                    document.getElementById('templateContentEditor').value = textContent;
                }
                
                // 设置主题（如果有）
                const subjectMatch = currentTemplateData.match(/主题[：:]\s*(.+?)(?:\n|<\/)/);
                if (subjectMatch) {
                    document.getElementById('templateSubject').value = subjectMatch[1].trim();
                }
            } else {
                // 切换到预览模式
                previewDiv.style.display = 'block';
                editorDiv.style.display = 'none';
                editBtn.innerHTML = '<i class="bi bi-pencil"></i> 编辑内容';
                editBtn.classList.remove('btn-outline-danger');
                editBtn.classList.add('btn-outline-warning');
            }
        }
        
        // 保存模板编辑
        function saveTemplateEdit() {
            const templateType = document.getElementById('templateType').value;
            const subject = document.getElementById('templateSubject').value;
            const content = document.getElementById('templateContentEditor').value;
            
            if (!content.trim()) {
                alert('模板内容不能为空！');
                return;
            }
            
            let newTemplateHtml = '';
            
            if (templateType === 'email') {
                // 邮件模板
                newTemplateHtml = `
                    <div class="email-template p-4 border rounded">
                        <div class="email-header mb-3">
                            <h5>主题：${subject || '智能推荐'}</h5>
                            <p class="text-muted small">发件人：AI智能推荐系统</p>
                        </div>
                        <div class="email-body">
                            <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(content)}</div>
                        </div>
                    </div>
                `;
            } else {
                // 短信模板
                newTemplateHtml = `
                    <div class="sms-template p-4 border rounded bg-light">
                        <div class="sms-preview">
                            <div class="sms-header mb-2">
                                <span class="badge bg-primary">短信模板</span>
                                <span class="text-muted small ms-2">约 ${content.length} 字</span>
                            </div>
                            <div class="sms-content p-3 bg-white rounded border">
                                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(content)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 更新显示
            document.getElementById('templateContent').innerHTML = newTemplateHtml;
            currentTemplateData = newTemplateHtml;
            editedTemplateContent = content;
            
            // 退出编辑模式
            toggleTemplateEdit();
            
            // 更新发送预览（如果已选择客户）
            if (selectedCustomers.length > 0) {
                updateSendPreview();
            }
            
            alert('模板内容已保存！');
        }
        
        // 取消模板编辑
        function cancelTemplateEdit() {
            toggleTemplateEdit();
        }
        
        // 预览模板编辑
        function previewTemplateEdit() {
            const templateType = document.getElementById('templateType').value;
            const subject = document.getElementById('templateSubject').value;
            const content = document.getElementById('templateContentEditor').value;
            
            if (!content.trim()) {
                alert('模板内容不能为空！');
                return;
            }
            
            let previewHtml = '';
            
            if (templateType === 'email') {
                previewHtml = `
                    <div class="email-template p-4 border rounded">
                        <div class="email-header mb-3">
                            <h5>主题：${escapeHtml(subject || '智能推荐')}</h5>
                            <p class="text-muted small">发件人：AI智能推荐系统</p>
                        </div>
                        <div class="email-body">
                            <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(content)}</div>
                        </div>
                    </div>
                `;
            } else {
                previewHtml = `
                    <div class="sms-template p-4 border rounded bg-light">
                        <div class="sms-preview">
                            <div class="sms-header mb-2">
                                <span class="badge bg-primary">短信模板</span>
                                <span class="text-muted small ms-2">约 ${content.length} 字</span>
                            </div>
                            <div class="sms-content p-3 bg-white rounded border">
                                <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">${escapeHtml(content)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 临时显示预览
            const previewDiv = document.getElementById('templateContent');
            const originalContent = previewDiv.innerHTML;
            previewDiv.innerHTML = previewHtml;
            previewDiv.style.display = 'block';
            
            setTimeout(() => {
                previewDiv.innerHTML = originalContent;
                previewDiv.style.display = 'none';
            }, 3000);
        }
        
        // 加载客户选择
        function loadCustomerSelection() {
            const source = document.getElementById('customerSource').value;
            const customerListDiv = document.getElementById('customerList');
            selectedCustomers = [];
            
            if (source === 'recommendation') {
                // 从推荐中提取客户
                const selectedRecs = recommendations.filter(r => selectedRecommendations.includes(r.id));
                const uniqueCustomers = [...new Set(selectedRecs.map(r => r.customerName).filter(name => name))];
                
                let html = '<div class="list-group">';
                uniqueCustomers.forEach(customerName => {
                    html += `
                        <label class="list-group-item">
                            <input class="form-check-input me-2" type="checkbox" value="${customerName}" onchange="toggleCustomerSelection('${customerName}')">
                            ${customerName}
                        </label>
                    `;
                });
                html += '</div>';
                
                customerListDiv.innerHTML = html || '<p class="text-muted">推荐中未找到客户信息</p>';
            } else {
                // 从客户列表API获取
                customerListDiv.innerHTML = '<p class="text-muted">加载中...</p>';
                
                fetch('/api/customer/list?pageNum=1&pageSize=1000')
                    .then(response => response.json())
                    .then(result => {
                        if (result.code === 200 && result.data && Array.isArray(result.data)) {
                            allCustomers = result.data;
                            renderCustomerList(allCustomers);
                        } else {
                            customerListDiv.innerHTML = '<p class="text-danger">加载客户列表失败</p>';
                        }
                    })
                    .catch(error => {
                        console.error('加载客户列表失败:', error);
                        customerListDiv.innerHTML = '<p class="text-danger">加载客户列表失败: ' + error.message + '</p>';
                    });
            }
        }
        
        // 渲染客户列表
        function renderCustomerList(customers) {
            const customerListDiv = document.getElementById('customerList');
            if (customers.length === 0) {
                customerListDiv.innerHTML = '<p class="text-muted">暂无客户数据</p>';
                return;
            }
            
            let html = '<div class="list-group">';
            customers.forEach(customer => {
                const customerId = customer.id || customer.customerId;
                const customerName = customer.customerName || customer.name || `客户${customerId}`;
                const phone = customer.phone || customer.telephone || '';
                const email = customer.email || '';
                
                html += `
                    <label class="list-group-item">
                        <input class="form-check-input me-2" type="checkbox" value="${customerId}" onchange="toggleCustomerSelection('${customerId}')">
                        <div>
                            <strong>${customerName}</strong>
                            ${phone ? `<br><small class="text-muted">电话: ${phone}</small>` : ''}
                            ${email ? `<br><small class="text-muted">邮箱: ${email}</small>` : ''}
                        </div>
                    </label>
                `;
            });
            html += '</div>';
            
            customerListDiv.innerHTML = html;
        }
        
        // 过滤客户
        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            if (!searchTerm) {
                renderCustomerList(allCustomers);
                return;
            }
            
            const filtered = allCustomers.filter(customer => {
                const name = (customer.customerName || customer.name || '').toLowerCase();
                const phone = (customer.phone || customer.telephone || '').toLowerCase();
                const email = (customer.email || '').toLowerCase();
                return name.includes(searchTerm) || phone.includes(searchTerm) || email.includes(searchTerm);
            });
            
            renderCustomerList(filtered);
        }
        
        // 切换客户选择
        function toggleCustomerSelection(customerId) {
            const checkbox = event.target;
            if (checkbox.checked) {
                if (!selectedCustomers.includes(customerId)) {
                    selectedCustomers.push(customerId);
                }
            } else {
                const index = selectedCustomers.indexOf(customerId);
                if (index > -1) {
                    selectedCustomers.splice(index, 1);
                }
            }
            
            // 更新预览客户选择下拉框
            updatePreviewCustomerSelect();
        }
        
        // 更新预览客户选择下拉框
        function updatePreviewCustomerSelect() {
            const select = document.getElementById('previewCustomerSelect');
            select.innerHTML = '<option value="">请选择客户</option>';
            
            selectedCustomers.forEach(customerId => {
                let customerName = customerId;
                let phone = '';
                let email = '';
                
                // 如果是数字ID，尝试从allCustomers中查找
                if (!isNaN(customerId)) {
                    const customer = allCustomers.find(c => (c.id || c.customerId) == customerId);
                    if (customer) {
                        customerName = customer.customerName || customer.name || customerId;
                        phone = customer.phone || customer.telephone || '';
                        email = customer.email || '';
                    }
                } else {
                    // 如果是客户名称（从推荐中提取），尝试从推荐中查找联系方式
                    const selectedRecs = recommendations.filter(r => selectedRecommendations.includes(r.id));
                    const rec = selectedRecs.find(r => r.customerName === customerId);
                    if (rec && rec.customerPhone) phone = rec.customerPhone;
                    if (rec && rec.customerEmail) email = rec.customerEmail;
                }
                
                const option = document.createElement('option');
                option.value = customerId;
                option.textContent = customerName + (phone ? ` (${phone})` : '');
                option.dataset.phone = phone;
                option.dataset.email = email;
                option.dataset.name = customerName;
                select.appendChild(option);
            });
        }
        
        // 更新发送预览
        function updateSendPreview() {
            const customerId = document.getElementById('previewCustomerSelect').value;
            const sendType = document.querySelector('input[name="sendType"]:checked').value;
            
            if (!customerId) {
                document.getElementById('sendPreviewContent').innerHTML = '<p class="text-muted">请先选择客户</p>';
                return;
            }
            
            let customerName = customerId;
            let phone = '';
            let email = '';
            
            // 查找客户信息
            if (!isNaN(customerId)) {
                const customer = allCustomers.find(c => (c.id || c.customerId) == customerId);
                if (customer) {
                    customerName = customer.customerName || customer.name || customerId;
                    phone = customer.phone || customer.telephone || '';
                    email = customer.email || '';
                }
            } else {
                // 如果是客户名称（从推荐中提取），尝试从下拉框选项的data属性获取
                const option = document.querySelector(`#previewCustomerSelect option[value="${customerId}"]`);
                if (option) {
                    customerName = option.dataset.name || customerId;
                    phone = option.dataset.phone || '';
                    email = option.dataset.email || '';
                }
            }
            
            const selectedRecs = recommendations.filter(r => selectedRecommendations.includes(r.id));
            
            if (sendType === 'sms') {
                // 短信预览
                let smsText = `【AI智能推荐】`;
                if (selectedRecs.length === 1) {
                    smsText += `${selectedRecs[0].title}。${selectedRecs[0].content}`;
                } else {
                    smsText += `为您推荐${selectedRecs.length}项内容：`;
                    selectedRecs.forEach((rec, index) => {
                        smsText += `${index + 1}.${rec.title}；`;
                    });
                }
                smsText += `详情请查看推荐报告。`;
                
                document.getElementById('sendPreviewContent').innerHTML = `
                    <div class="sms-preview-container">
                        <div class="sms-phone-header p-2 bg-primary text-white rounded-top">
                            <i class="bi bi-phone"></i> ${phone || '手机号码'}
                        </div>
                        <div class="sms-content-area p-3 bg-light border rounded-bottom">
                            <div class="sms-bubble p-3 bg-white rounded shadow-sm mb-2">
                                <p class="mb-0" style="white-space: pre-wrap;">${smsText}</p>
                            </div>
                            <div class="text-end mt-2">
                                <button class="btn btn-primary btn-sm" disabled>
                                    <i class="bi bi-send"></i> 发送（预览模式）
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // 邮件预览 - 使用编辑后的模板内容或自动生成
                let emailBody = '';
                let emailSubject = '';
                
                if (editedTemplateContent) {
                    // 使用编辑后的模板内容
                    emailBody = editedTemplateContent;
                    emailSubject = document.getElementById('templateSubject').value || '智能推荐';
                } else {
                    // 自动生成
                    emailBody = `尊敬的${customerName}，\n\n您好！基于您的业务需求，我们为您准备了以下智能推荐：\n\n`;
                    selectedRecs.forEach((rec, index) => {
                        emailBody += `${index + 1}. ${rec.title}\n${rec.content}\n推荐理由：${rec.reason || '无'}\n\n`;
                    });
                    emailBody += `如有任何疑问或需要进一步了解，欢迎随时联系我们。\n\n此致\n敬礼！\n\nAI智能推荐系统\n${new Date().toLocaleDateString('zh-CN')}`;
                    emailSubject = selectedRecs.length > 1 ? '多项智能推荐' : selectedRecs[0].title;
                }
                
                let emailHtml = `
                    <div class="email-preview-container border rounded">
                        <div class="email-header p-3 bg-light border-bottom">
                            <div class="mb-2">
                                <strong>收件人：</strong>${email || 'customer@example.com'}
                            </div>
                            <div class="mb-2">
                                <strong>主题：</strong>${emailSubject}
                            </div>
                        </div>
                        <div class="email-body p-4">
                            <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(emailBody)}</div>
                        </div>
                        <div class="email-footer p-3 bg-light border-top text-end">
                            <button class="btn btn-primary" disabled>
                                <i class="bi bi-send"></i> 发送（预览模式）
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('sendPreviewContent').innerHTML = emailHtml;
            }
        }
        
        // 生成分享链接
        function generateShareLink() {
            const selectedRecs = recommendations.filter(r => selectedRecommendations.includes(r.id));
            const shareData = {
                recommendations: selectedRecs,
                generateTime: new Date().toISOString()
            };
            
            // 使用Base64编码数据
            const encodedData = btoa(JSON.stringify(shareData));
            shareLink = `${window.location.origin}/ai-recommendations-share.html?data=${encodeURIComponent(encodedData)}`;
            
            document.getElementById('shareLink').value = shareLink;
            
            // 生成二维码
            generateQRCode();
        }
        
        // 生成二维码
        function generateQRCode() {
            const container = document.getElementById('qrcodeContainer');
            container.innerHTML = '';
            
            QRCode.toCanvas(shareLink, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function (error, canvas) {
                if (error) {
                    console.error('生成二维码失败:', error);
                    container.innerHTML = '<p class="text-danger">生成二维码失败</p>';
                } else {
                    container.appendChild(canvas);
                }
            });
        }
        
        // 复制报告内容
        function copyReportContent() {
            const reportText = document.getElementById('reportContent').innerText;
            navigator.clipboard.writeText(reportText).then(() => {
                alert('报告内容已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动选择复制');
            });
        }
        
        // 下载报告
        function downloadReport() {
            const reportHtml = currentReportData || document.getElementById('reportContent').innerHTML;
            const blob = new Blob([`
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI智能推荐报告</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        @media print {
            body { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        ${reportHtml}
    </div>
</body>
</html>
            `], { type: 'text/html' });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `AI智能推荐报告_${new Date().toISOString().split('T')[0]}.html`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // 复制模板内容
        function copyTemplateContent() {
            const templateText = document.getElementById('templateContent').innerText;
            navigator.clipboard.writeText(templateText).then(() => {
                alert('模板内容已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动选择复制');
            });
        }
        
        // 复制分享链接
        function copyShareLink() {
            const linkInput = document.getElementById('shareLink');
            linkInput.select();
            document.execCommand('copy');
            alert('分享链接已复制到剪贴板');
        }
        
        // 下载二维码
        function downloadQRCode() {
            const canvas = document.querySelector('#qrcodeContainer canvas');
            if (!canvas) {
                alert('二维码未生成');
                return;
            }
            
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `推荐报告二维码_${new Date().toISOString().split('T')[0]}.png`;
                link.click();
                URL.revokeObjectURL(url);
            });
        }
        
        // 复制当前内容（统一入口）
        function copyCurrentContent() {
            // 检查是否在编辑模式
            const reportEditor = document.getElementById('reportEditor');
            const templateEditor = document.getElementById('templateEditor');
            
            if (reportEditor && reportEditor.style.display !== 'none') {
                // 编辑模式：复制编辑器内容
                const editorContent = document.getElementById('reportContentEditor').value;
                navigator.clipboard.writeText(editorContent).then(() => {
                    alert('内容已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败，请手动选择复制');
                });
            } else if (templateEditor && templateEditor.style.display !== 'none') {
                // 模板编辑模式：复制模板编辑器内容
                const templateContent = document.getElementById('templateContentEditor').value;
                navigator.clipboard.writeText(templateContent).then(() => {
                    alert('模板内容已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                    alert('复制失败，请手动选择复制');
                });
            } else {
                // 预览模式：复制预览内容
                const reportContent = document.getElementById('reportContent');
                if (reportContent && reportContent.style.display !== 'none') {
                    copyReportContent();
                } else {
                    const templateContent = document.getElementById('templateContent');
                    if (templateContent && templateContent.style.display !== 'none') {
                        copyTemplateContent();
                    } else {
                        alert('没有可复制的内容');
                    }
                }
            }
        }
        
        // 分享当前内容（统一入口）
        function shareCurrentContent() {
            // 确保已生成分享链接
            if (!shareLink) {
                generateShareLink();
            }
            
            // 显示分享链接输入框，让用户复制
            const shareLinkInput = document.getElementById('shareLink');
            if (shareLinkInput) {
                shareLinkInput.select();
                document.execCommand('copy');
                alert('分享链接已复制到剪贴板，您可以分享给他人');
            } else {
                // 如果没有分享链接输入框，直接使用Web Share API（如果支持）
                if (navigator.share) {
                    const selectedRecs = recommendations.filter(r => selectedRecommendations.includes(r.id));
                    const shareText = selectedRecs.map(r => `${r.title}: ${r.content}`).join('\n\n');
                    navigator.share({
                        title: 'AI智能推荐',
                        text: shareText,
                        url: shareLink || window.location.href
                    }).catch(err => {
                        console.error('分享失败:', err);
                        // 降级到复制链接
                        if (shareLink) {
                            navigator.clipboard.writeText(shareLink).then(() => {
                                alert('分享链接已复制到剪贴板');
                            });
                        }
                    });
                } else {
                    // 降级方案：复制链接
                    if (shareLink) {
                        navigator.clipboard.writeText(shareLink).then(() => {
                            alert('分享链接已复制到剪贴板');
                        });
                    } else {
                        generateShareLink();
                        setTimeout(() => {
                            const shareLinkInput = document.getElementById('shareLink');
                            if (shareLinkInput) {
                                shareLinkInput.select();
                                document.execCommand('copy');
                                alert('分享链接已复制到剪贴板');
                            }
                        }, 500);
                    }
                }
            }
        }
        
        // ========== 发送/分享功能 ==========
        
        // 打开发送/分享模态框（实际实现）
        function _openSendShareModal() {
            const modal = new bootstrap.Modal(document.getElementById('sendShareModal'));
            modal.show();
            
            // 重置状态
            sendSelectedCustomers = [];
            sendShareLink = '';
            document.getElementById('sendCustomerList').innerHTML = '<p class="text-muted">请选择客户来源</p>';
            document.getElementById('selectedCustomerCount').textContent = '0';
            document.getElementById('shareSection').style.display = 'none';
            document.getElementById('generateShareBtn').disabled = true;
            document.getElementById('sendBtn').style.display = 'none';
            
            // 默认加载客户列表
            loadSendCustomerSelection();
        }
        
        // 加载发送模态框的客户选择
        function loadSendCustomerSelection() {
            const source = document.getElementById('sendCustomerSource').value;
            const customerListDiv = document.getElementById('sendCustomerList');
            sendSelectedCustomers = [];
            document.getElementById('selectedCustomerCount').textContent = '0';
            document.getElementById('generateShareBtn').disabled = true;
            
            if (source === 'recommendation') {
                // 从推荐中提取客户
                const selectedRecs = recommendations.filter(r => selectedRecommendations.includes(r.id));
                const uniqueCustomers = [...new Set(selectedRecs.map(r => r.customerName).filter(name => name))];
                
                if (uniqueCustomers.length === 0) {
                    customerListDiv.innerHTML = '<p class="text-muted">推荐中未找到客户信息</p>';
                    return;
                }
                
                let html = '<div class="list-group">';
                uniqueCustomers.forEach(customerName => {
                    html += `
                        <label class="list-group-item">
                            <input class="form-check-input me-2" type="checkbox" value="${customerName}" onchange="toggleSendCustomerSelection('${customerName}', 'name')">
                            ${customerName}
                        </label>
                    `;
                });
                html += '</div>';
                
                customerListDiv.innerHTML = html;
            } else {
                // 从客户列表API获取
                customerListDiv.innerHTML = '<p class="text-muted">加载中...</p>';
                
                fetch('/api/customer/list?pageNum=1&pageSize=1000')
                    .then(response => response.json())
                    .then(result => {
                        if (result.code === 200 && result.data && Array.isArray(result.data)) {
                            sendAllCustomers = result.data;
                            renderSendCustomerList(sendAllCustomers);
                        } else {
                            customerListDiv.innerHTML = '<p class="text-danger">加载客户列表失败</p>';
                        }
                    })
                    .catch(error => {
                        console.error('加载客户列表失败:', error);
                        customerListDiv.innerHTML = '<p class="text-danger">加载客户列表失败: ' + error.message + '</p>';
                    });
            }
        }
        
        // 渲染发送模态框的客户列表
        function renderSendCustomerList(customers) {
            const customerListDiv = document.getElementById('sendCustomerList');
            if (customers.length === 0) {
                customerListDiv.innerHTML = '<p class="text-muted">暂无客户数据</p>';
                return;
            }
            
            let html = '<div class="list-group">';
            customers.forEach(customer => {
                const customerId = customer.id || customer.customerId;
                const customerName = customer.customerName || customer.name || `客户${customerId}`;
                const phone = customer.phone || customer.telephone || '';
                const email = customer.email || '';
                
                html += `
                    <label class="list-group-item">
                        <input class="form-check-input me-2" type="checkbox" value="${customerId}" onchange="toggleSendCustomerSelection('${customerId}', 'id')">
                        <div>
                            <strong>${customerName}</strong>
                            ${phone ? `<br><small class="text-muted">电话: ${phone}</small>` : ''}
                            ${email ? `<br><small class="text-muted">邮箱: ${email}</small>` : ''}
                        </div>
                    </label>
                `;
            });
            html += '</div>';
            
            customerListDiv.innerHTML = html;
        }
        
        // 切换发送客户选择
        function toggleSendCustomerSelection(value, type) {
            if (type === 'id') {
                const customerId = value;
                const index = sendSelectedCustomers.findIndex(c => c.id === customerId);
                if (index > -1) {
                    sendSelectedCustomers.splice(index, 1);
                } else {
                    const customer = sendAllCustomers.find(c => (c.id || c.customerId) == customerId);
                    if (customer) {
                        sendSelectedCustomers.push(customer);
                    }
                }
            } else {
                const customerName = value;
                const index = sendSelectedCustomers.findIndex(c => c.name === customerName);
                if (index > -1) {
                    sendSelectedCustomers.splice(index, 1);
                } else {
                    sendSelectedCustomers.push({ name: customerName });
                }
            }
            
            document.getElementById('selectedCustomerCount').textContent = sendSelectedCustomers.length;
            document.getElementById('generateShareBtn').disabled = sendSelectedCustomers.length === 0;
        }
        
        // 过滤发送客户
        function filterSendCustomers() {
            const searchTerm = document.getElementById('sendCustomerSearch').value.toLowerCase();
            if (!searchTerm) {
                renderSendCustomerList(sendAllCustomers);
                return;
            }
            
            const filtered = sendAllCustomers.filter(customer => {
                const name = (customer.customerName || customer.name || '').toLowerCase();
                const phone = (customer.phone || customer.telephone || '').toLowerCase();
                const email = (customer.email || '').toLowerCase();
                return name.includes(searchTerm) || phone.includes(searchTerm) || email.includes(searchTerm);
            });
            
            renderSendCustomerList(filtered);
        }
        
        // 生成发送分享链接
        function generateSendShareLink() {
            if (sendSelectedCustomers.length === 0) {
                alert('请先选择至少一位客户！');
                return;
            }
            
            // 获取当前内容
            const reportContent = document.getElementById('reportContent');
            const reportEditor = document.getElementById('reportEditor');
            let content = '';
            
            if (reportEditor && reportEditor.style.display !== 'none') {
                // 编辑模式：使用编辑器内容
                content = document.getElementById('reportContentEditor').value;
            } else if (reportContent && reportContent.style.display !== 'none') {
                // 预览模式：使用预览内容
                content = reportContent.innerText || reportContent.textContent;
            } else {
                // 尝试从当前内容类型生成
                const selectedRecs = recommendations.filter(r => selectedRecommendations.includes(r.id));
                if (selectedRecs.length > 0) {
                    content = selectedRecs.map(r => `${r.title}: ${r.content}`).join('\n\n');
                } else {
                    content = 'AI智能推荐内容';
                }
            }
            
            // 构建分享数据
            const shareData = {
                customers: sendSelectedCustomers.map(c => ({
                    id: c.id || c.customerId,
                    name: c.customerName || c.name || c.name,
                    phone: c.phone || c.telephone || '',
                    email: c.email || ''
                })),
                content: content,
                contentType: currentContentType,
                generateTime: new Date().toISOString()
            };
            
            // 使用Base64编码数据
            const encodedData = btoa(JSON.stringify(shareData));
            sendShareLink = `${window.location.origin}/ai-recommendations-share.html?data=${encodeURIComponent(encodedData)}`;
            
            // 显示分享链接
            document.getElementById('sendShareLink').value = sendShareLink;
            
            // 生成二维码
            generateSendQRCode();
            
            // 显示分享区域和发送按钮
            document.getElementById('shareSection').style.display = 'block';
            document.getElementById('sendBtn').style.display = 'inline-block';
        }
        
        // 生成发送二维码
        function generateSendQRCode() {
            const container = document.getElementById('sendQRCodeContainer');
            container.innerHTML = '';
            
            if (!sendShareLink) {
                container.innerHTML = '<p class="text-danger">请先生成分享链接</p>';
                return;
            }
            
            QRCode.toCanvas(sendShareLink, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function (error, canvas) {
                if (error) {
                    console.error('生成二维码失败:', error);
                    container.innerHTML = '<p class="text-danger">生成二维码失败</p>';
                } else {
                    container.appendChild(canvas);
                }
            });
        }
        
        // 复制发送分享链接
        function copySendShareLink() {
            const linkInput = document.getElementById('sendShareLink');
            if (!linkInput || !linkInput.value) {
                alert('请先生成分享链接');
                return;
            }
            linkInput.select();
            document.execCommand('copy');
            alert('分享链接已复制到剪贴板');
        }
        
        // 下载发送二维码
        function downloadSendQRCode() {
            const canvas = document.querySelector('#sendQRCodeContainer canvas');
            if (!canvas) {
                alert('二维码未生成');
                return;
            }
            
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `分享二维码_${new Date().toISOString().split('T')[0]}.png`;
                link.click();
                URL.revokeObjectURL(url);
            });
        }
        
        // 发送给客户
        function sendToCustomers() {
            if (sendSelectedCustomers.length === 0) {
                alert('请先选择客户！');
                return;
            }
            
            if (!sendShareLink) {
                alert('请先生成分享链接！');
                return;
            }
            
            // 这里可以调用后端API发送短信或邮件
            // 目前先显示成功提示
            const customerNames = sendSelectedCustomers.map(c => c.customerName || c.name || '客户').join('、');
            alert('已成功发送给 ' + customerNames + ' 等 ' + sendSelectedCustomers.length + ' 位客户！\n\n分享链接：' + sendShareLink);
            
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('sendShareModal'));
            if (modal) {
                modal.hide();
            }
        }
        
        // 将实际实现的函数立即赋值给window对象和全局变量
        // 这个赋值会在script标签执行时立即执行，确保函数可用
        if (typeof window !== 'undefined') {
            // 将实际实现赋值给window对象，替换之前的临时函数
            if (typeof _openGenerateContentModal === 'function') {
                window.openGenerateContentModal = _openGenerateContentModal;
                window._openGenerateContentModal = _openGenerateContentModal;
                // 同时更新全局函数
                openGenerateContentModal = _openGenerateContentModal;
            }
            if (typeof _openSendShareModal === 'function') {
                window.openSendShareModal = _openSendShareModal;
                window._openSendShareModal = _openSendShareModal;
                // 同时更新全局函数
                openSendShareModal = _openSendShareModal;
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>沟通记录管理 - AI客户管理系统</title>
    <link href="/lib/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <!-- 页面头部 -->
        <div class="page-header">
            <div class="page-title">
                <i class="bi bi-chat-dots-fill"></i> 沟通记录管理
            </div>
            <a href="/" class="back-home-btn">
                <i class="bi bi-house-fill"></i> 返回首页
            </a>
        </div>
        
        <!-- 操作按钮区域 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <button class="btn btn-primary" onclick="showAddCommunicationModal()">
                    <i class="bi bi-plus"></i> 新增沟通记录
                </button>
                <button class="btn btn-warning" onclick="batchDelete()">
                    <i class="bi bi-trash"></i> 批量删除
                </button>
            </div>
            <div>
                <button class="btn btn-outline-primary" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
            </div>
        </div>

        <!-- 沟通记录列表 -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>客户名称</th>
                                <th>沟通类型</th>
                                <th>沟通内容</th>
                                <th>重要程度</th>
                                <th>沟通时间</th>
                                <th>操作人</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="communicationTableBody">
                            <!-- 沟通记录数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/编辑沟通记录模态框 -->
    <div class="modal fade" id="communicationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-max-70">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="communicationModalTitle">新增沟通记录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="communicationForm">
                        <input type="hidden" id="communicationId" name="id">
                        <input type="hidden" id="modalCustomerId" name="customerId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">客户名称 *</label>
                                    <select class="form-select" id="customerSelect" required>
                                        <option value="">请选择客户</option>
                                        <option value="1">张三</option>
                                        <option value="2">李四农业科技有限公司</option>
                                        <option value="3">王五种子研究所</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">沟通类型 *</label>
                                    <select class="form-select" id="communicationTypeSelect" name="communicationType" required>
                                        <option value="">请选择类型</option>
                                        <option value="1">电话</option>
                                        <option value="2">邮件</option>
                                        <option value="3">微信</option>
                                        <option value="4">面谈</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">重要程度 *</label>
                                    <select class="form-select" id="importanceSelect" name="importance" required>
                                        <option value="">请选择重要程度</option>
                                        <option value="1">高</option>
                                        <option value="2">中</option>
                                        <option value="3">低</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">沟通时间 *</label>
                                    <input type="datetime-local" class="form-control" id="communicationTime" name="communicationTime" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">沟通主题 *</label>
                            <input type="text" class="form-control" id="subject" name="summary" required placeholder="请输入沟通主题...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">沟通内容 *</label>
                            <textarea class="form-control" id="content" name="content" rows="4" required placeholder="请详细描述沟通内容..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">后续跟进</label>
                            <textarea class="form-control" id="followUp" name="followUpTask" rows="3" placeholder="后续跟进计划..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveCommunication()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 沟通记录详情模态框 -->
    <div class="modal fade" id="communicationDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-max-70">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">沟通记录详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="communicationDetailContent">
                    <!-- 沟通记录详情内容将通过JavaScript动态加载 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/lib/bootstrap/bootstrap.bundle.min.js"></script>
    <script>
        // 模拟沟通记录数据
        let communications = [
            {
                id: 1,
                customerName: '张三',
                communicationType: 1,
                subject: '种子采购咨询',
                content: '客户咨询了水稻种子的价格和种植技术',
                importance: 1,
                communicationTime: '2024-01-25T10:30:00',
                followUp: '需要提供详细的产品资料',
                operator: '李四',
                createTime: '2024-01-25'
            },
            {
                id: 2,
                customerName: '李四农业科技有限公司',
                communicationType: 2,
                subject: '合同条款讨论',
                content: '通过邮件讨论了合同的具体条款和价格',
                importance: 2,
                communicationTime: '2024-01-24T14:20:00',
                followUp: '等待客户回复最终确认',
                operator: '王五',
                createTime: '2024-01-24'
            },
            {
                id: 3,
                customerName: '王五种子研究所',
                communicationType: 4,
                subject: '技术合作洽谈',
                content: '面谈讨论了技术合作的具体方案',
                importance: 1,
                communicationTime: '2024-01-23T09:15:00',
                followUp: '准备合作方案书',
                operator: '赵六',
                createTime: '2024-01-23'
            }
        ];

        let selectedCommunications = [];

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadCommunications();
        });

        // 加载沟通记录列表
        function loadCommunications() {
            const tbody = document.getElementById('communicationTableBody');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">加载中...</td></tr>';

            // 解析URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customerId');
            
            // 构建API请求URL
            let url = '/api/communication/list?pageNum=1&pageSize=100';
            if (customerId) {
                url += `&customerId=${customerId}`;
            }

            // 从API获取沟通记录（使用分页接口，获取前100条记录）
            fetch(url)
                .then(response => response.json())
                .then(result => {
                    if (result.code === 200 && result.data && result.data.records) {
                        communications = result.data.records || [];
                        renderCommunications(communications);
                    } else {
                        communications = [];
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暂无沟通记录</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('加载沟通记录失败:', error);
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">加载失败，请刷新重试</td></tr>';
                });
        }

        // 渲染沟通记录
        function renderCommunications(commList) {
            const tbody = document.getElementById('communicationTableBody');
            tbody.innerHTML = '';

            if (!commList || commList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暂无沟通记录</td></tr>';
                return;
            }

            commList.forEach(communication => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="communication-checkbox" value="${communication.id}" onchange="toggleCommunicationSelection(${communication.id})">
                    </td>
                    <td class="table-cell-truncate" title="${communication.customerName}">${communication.customerName}</td>
                    <td class="table-cell-truncate" title="${getCommunicationTypeText(communication.communicationType)}">${getCommunicationTypeText(communication.communicationType)}</td>
                    <td class="table-cell-truncate" title="${communication.summary || communication.content}">${communication.summary || communication.content}</td>
                    <td><span class="badge ${getImportanceClass(communication.importance)}">${getImportanceText(communication.importance)}</span></td>
                    <td class="table-cell-truncate" title="${formatDateTime(communication.communicationTime)}">${formatDateTime(communication.communicationTime)}</td>
                    <td class="table-cell-truncate" title="${communication.communicatorName || communication.operator}">${communication.communicatorName || communication.operator}</td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm" onclick="viewCommunication(${communication.id})" title="查看详情">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="editCommunication(${communication.id})" title="编辑">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteCommunication(${communication.id})" title="删除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 搜索沟通记录
        function searchCommunications() {
            // 获取搜索条件元素并检查存在性
            const communicationTypeElement = document.getElementById('communicationType');
            const customerIdElement = document.getElementById('customerId');
            const importanceElement = document.getElementById('importance');
            const startDateElement = document.getElementById('startDate');
            const endDateElement = document.getElementById('endDate');
            
            // 获取元素值
            const communicationType = communicationTypeElement ? communicationTypeElement.value : '';
            const customerId = customerIdElement ? customerIdElement.value : '';
            const importance = importanceElement ? importanceElement.value : '';
            const startDate = startDateElement ? startDateElement.value : '';
            const endDate = endDateElement ? endDateElement.value : '';

            // 构建查询参数
            const params = new URLSearchParams();
            params.append('pageNum', '1');
            params.append('pageSize', '100'); // 一次获取较多数据用于前端展示
            
            if (communicationType) {
                params.append('communicationType', communicationType);
            }
            if (customerId) {
                params.append('customerId', customerId);
            }
            if (importance) {
                params.append('importance', importance);
            }
            // 注意：后端API目前没有直接支持按日期范围过滤的参数
            // 我们可以在获取数据后在前端进行日期过滤

            // 显示加载状态
            const tbody = document.getElementById('communicationTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">加载中...</td></tr>';
            }

            // 发送搜索请求到后端
            fetch(`/api/communication/list?${params.toString()}`)
                .then(response => response.json())
                .then(result => {
                    if (result.code === 200 && result.data && result.data.records) {
                        let filteredCommunications = result.data.records || [];
                        
                        // 如果有日期范围过滤条件，在前端进行过滤
                        if (startDate) {
                            filteredCommunications = filteredCommunications.filter(communication => 
                                new Date(communication.communicationTime) >= new Date(startDate)
                            );
                        }
                        if (endDate) {
                            filteredCommunications = filteredCommunications.filter(communication => 
                                new Date(communication.communicationTime) <= new Date(endDate + 'T23:59:59')
                            );
                        }
                        
                        renderCommunications(filteredCommunications);
                    } else {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暂无沟通记录</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('搜索沟通记录失败:', error);
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">搜索失败，请刷新重试</td></tr>';
                });
        }

        // 重置搜索条件
        function resetSearch() {
            // 获取DOM元素并检查存在性
            const communicationTypeElement = document.getElementById('communicationType');
            const customerIdElement = document.getElementById('customerId');
            const importanceElement = document.getElementById('importance');
            const startDateElement = document.getElementById('startDate');
            const endDateElement = document.getElementById('endDate');
            
            // 重置元素值
            if (communicationTypeElement) communicationTypeElement.value = '';
            if (customerIdElement) customerIdElement.value = '';
            if (importanceElement) importanceElement.value = '';
            if (startDateElement) startDateElement.value = '';
            if (endDateElement) endDateElement.value = '';
            
            loadCommunications();
        }

        // 显示新增沟通记录模态框
        function showAddCommunicationModal() {
            // 获取DOM元素并检查存在性
            const communicationModalTitle = document.getElementById('communicationModalTitle');
            const communicationForm = document.getElementById('communicationForm');
            const communicationId = document.getElementById('communicationId');
            const customerId = document.getElementById('modalCustomerId');
            const customerSelect = document.getElementById('customerSelect');
            const communicationModal = document.getElementById('communicationModal');
            
            // 设置模态框标题
            if (communicationModalTitle) {
                communicationModalTitle.textContent = '新增沟通记录';
            }
            
            // 重置表单
            if (communicationForm) {
                communicationForm.reset();
            }
            
            // 清空ID字段
            if (communicationId) {
                communicationId.value = '';
            }
            
            // 清空客户ID
            if (customerId) {
                customerId.value = '';
            }
            
            // 添加事件监听器，当客户选择变化时更新customerId隐藏字段
            if (customerSelect) {
                // 先移除可能存在的旧事件监听器
                customerSelect.replaceWith(customerSelect.cloneNode(true));
                const newCustomerSelect = document.getElementById('customerSelect');
                newCustomerSelect.addEventListener('change', function() {
                    const customerIdElement = document.getElementById('modalCustomerId');
                    if (customerIdElement) {
                        customerIdElement.value = this.value;
                    }
                });
            }
            
            // 显示模态框
            if (communicationModal) {
                new bootstrap.Modal(communicationModal).show();
            }
        }

        // 查看沟通记录详情
        function viewCommunication(id) {
            // 从API获取沟通记录详情
            fetch(`/api/communication/${id}`)
                .then(response => response.json())
                .then(result => {
                    if (result.code === 200 && result.data) {
                        const communication = result.data;
                        const content = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>基本信息</h6>
                                    <p><strong>客户名称：</strong>${communication.customerName}</p>
                                    <p><strong>沟通类型：</strong>${getCommunicationTypeText(communication.communicationType)}</p>
                                    <p><strong>重要程度：</strong>${getImportanceText(communication.importance)}</p>
                                    <p><strong>沟通时间：</strong>${formatDateTime(communication.communicationTime)}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>其他信息</h6>
                                    <p><strong>操作人员：</strong>${communication.communicatorName || communication.createBy || '未知'}</p>
                                    <p><strong>创建时间：</strong>${formatDateTime(communication.createTime)}</p>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>沟通主题</h6>
                                    <p>${communication.summary || '无'}</p>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>沟通内容</h6>
                                    <p>${communication.content || '无'}</p>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>后续跟进</h6>
                                    <p>${communication.followUpTask || '无'}</p>
                                </div>
                            </div>
                        `;
                        
                        // 获取DOM元素并检查存在性
                        const communicationDetailContent = document.getElementById('communicationDetailContent');
                        const communicationDetailModal = document.getElementById('communicationDetailModal');
                        
                        // 设置详情内容
                        if (communicationDetailContent) {
                            communicationDetailContent.innerHTML = content;
                        }
                        
                        // 显示详情模态框
                        if (communicationDetailModal) {
                            new bootstrap.Modal(communicationDetailModal).show();
                        }
                    } else {
                        alert('获取沟通记录详情失败: ' + (result.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('获取沟通记录详情失败:', error);
                    alert('获取沟通记录详情失败: 网络错误');
                });
        }

        // 编辑沟通记录
        function editCommunication(id) {
            // 从API获取沟通记录详情
            fetch(`/api/communication/${id}`)
                .then(response => response.json())
                .then(result => {
                    if (result.code === 200 && result.data) {
                        const communication = result.data;
                        
                        // 获取DOM元素并检查存在性
                        const communicationModalTitle = document.getElementById('communicationModalTitle');
                        const communicationId = document.getElementById('communicationId');
                        const customerSelect = document.getElementById('customerSelect');
                        const customerIdElem = document.getElementById('modalCustomerId');
                        const communicationTypeSelect = document.getElementById('communicationTypeSelect');
                        const importanceSelect = document.getElementById('importanceSelect');
                        const communicationTime = document.getElementById('communicationTime');
                        const subject = document.getElementById('subject');
                        const content = document.getElementById('content');
                        const followUp = document.getElementById('followUp');
                        const communicationModal = document.getElementById('communicationModal');
                        
                        // 设置模态框标题
                        if (communicationModalTitle) {
                            communicationModalTitle.textContent = '编辑沟通记录';
                        }
                        
                        // 设置沟通记录ID
                        if (communicationId) {
                            communicationId.value = communication.id;
                        }
                        
                        // 设置客户选择
                        if (customerSelect) {
                            customerSelect.value = communication.customerId || '';
                            customerSelect.readOnly = true;
                        }
                        
                        // 设置客户ID隐藏字段
                        if (customerIdElem) {
                            customerIdElem.value = communication.customerId || '';
                        }
                        
                        // 设置沟通类型
                        if (communicationTypeSelect) {
                            communicationTypeSelect.value = communication.communicationType || '';
                        }
                        
                        // 设置重要程度
                        if (importanceSelect) {
                            importanceSelect.value = communication.importance || '';
                        }
                        
                        // 格式化时间用于datetime-local输入
                        if (communication.communicationTime && communicationTime) {
                            const date = new Date(communication.communicationTime);
                            const localDateTime = date.toISOString().slice(0, 16);
                            communicationTime.value = localDateTime;
                        }
                        
                        // 设置主题
                        if (subject) {
                            subject.value = communication.summary || '';
                        }
                        
                        // 设置内容
                        if (content) {
                            content.value = communication.content || '';
                        }
                        
                        // 设置后续跟进
                        if (followUp) {
                            followUp.value = communication.followUpTask || '';
                        }
                        
                        // 显示模态框
                        if (communicationModal) {
                            new bootstrap.Modal(communicationModal).show();
                        }
                    } else {
                        alert('获取沟通记录详情失败: ' + (result.message || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('获取沟通记录详情失败:', error);
                    alert('获取沟通记录详情失败: 网络错误');
                });
        }

        // 保存沟通记录
        function saveCommunication() {
            const form = document.getElementById('communicationForm');
            if (!form) {
                alert('表单元素不存在');
                return;
            }
            
            const formData = new FormData(form);
            
            // 获取沟通记录ID
            const communicationIdElement = document.getElementById('communicationId');
            const communicationId = communicationIdElement ? communicationIdElement.value : '';
            
            // 获取客户ID
            const customerIdElement = document.getElementById('modalCustomerId');
            let customerId = customerIdElement ? customerIdElement.value : '';
            
            if (!customerId) {
                // 尝试从customerSelect获取
                const customerSelect = document.getElementById('customerSelect');
                if (customerSelect && customerSelect.value) {
                    customerId = customerSelect.value;
                } else {
                    alert('客户ID不能为空！');
                    return;
                }
            }
            
            // 获取客户名称
            const customerSelect = document.getElementById('customerSelect');
            let customerName = '';
            if (customerSelect && customerSelect.selectedIndex >= 0) {
                customerName = customerSelect.options[customerSelect.selectedIndex].text;
            }
            
            // 处理日期时间格式：将 datetime-local 格式转换为 ISO 8601 格式
            let communicationTime = formData.get('communicationTime');
            if (communicationTime) {
                // datetime-local 格式是 "YYYY-MM-DDTHH:mm"，需要转换为 "YYYY-MM-DDTHH:mm:ss"
                if (communicationTime.length === 16) {
                    communicationTime = communicationTime + ':00';
                }
            }
            
            // 构建沟通记录数据
            const communicationData = {
                customerId: parseInt(customerId),
                customerName: customerName || '',
                communicationType: parseInt(formData.get('communicationType')),
                importance: parseInt(formData.get('importance')) || 1,
                communicationTime: communicationTime || null,
                summary: formData.get('subject') || '',
                content: formData.get('content') || '',
                followUpTask: formData.get('followUp') || ''
            };

            let url = '/api/communication';
            let method = 'POST';
            
            if (communicationId) {
                // 编辑模式
                url = `/api/communication/${communicationId}`;
                method = 'PUT';
                communicationData.id = parseInt(communicationId);
            }

            // 发送请求到后端
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(communicationData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.code === 200) {
                    loadCommunications();
                    // 获取模态框实例并隐藏
                    const communicationModal = document.getElementById('communicationModal');
                    if (communicationModal) {
                        const modalInstance = bootstrap.Modal.getInstance(communicationModal);
                        if (modalInstance) {
                            modalInstance.hide();
                        }
                    }
                    alert('保存成功！');
                } else {
                    alert('保存失败: ' + result.message);
                }
            })
            .catch(error => {
                console.error('保存沟通记录失败:', error);
                alert('保存失败: 网络错误');
            });
        }

        // 删除沟通记录
        function deleteCommunication(id) {
            if (confirm('确定要删除这个沟通记录吗？')) {
                // 发送删除请求到后端
                fetch(`/api/communication/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.code === 200) {
                        loadCommunications();
                        alert('删除成功！');
                    } else {
                        alert('删除失败: ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('删除沟通记录失败:', error);
                    alert('删除失败: 网络错误');
                });
            }
        }

        // 批量删除
        function batchDelete() {
            if (selectedCommunications.length === 0) {
                alert('请先选择要删除的沟通记录！');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${selectedCommunications.length} 条沟通记录吗？`)) {
                // 批量删除，为每条记录调用删除API
                const deletePromises = selectedCommunications.map(id => {
                    return fetch(`/api/communication/${id}`, {
                        method: 'DELETE'
                    }).then(response => response.json());
                });

                Promise.all(deletePromises)
                .then(results => {
                    const successCount = results.filter(result => result.code === 200).length;
                    const failedCount = selectedCommunications.length - successCount;
                    
                    loadCommunications();
                    selectedCommunications = [];
                    
                    if (failedCount === 0) {
                        alert(`成功删除 ${successCount} 条沟通记录！`);
                    } else {
                        alert(`成功删除 ${successCount} 条沟通记录，失败 ${failedCount} 条！`);
                    }
                })
                .catch(error => {
                    console.error('批量删除沟通记录失败:', error);
                    alert('批量删除失败: 网络错误');
                });
            }
        }

        // 全选/取消全选
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.communication-checkbox');
            
            if (!selectAll) return;
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                if (selectAll.checked) {
                    if (!selectedCommunications.includes(parseInt(checkbox.value))) {
                        selectedCommunications.push(parseInt(checkbox.value));
                    }
                } else {
                    selectedCommunications = selectedCommunications.filter(id => id !== parseInt(checkbox.value));
                }
            });
        }

        // 切换沟通记录选择状态
        function toggleCommunicationSelection(id) {
            const index = selectedCommunications.indexOf(id);
            if (index > -1) {
                selectedCommunications.splice(index, 1);
            } else {
                selectedCommunications.push(id);
            }
        }

        // 刷新数据
        function refreshData() {
            loadCommunications();
            alert('刷新成功！');
        }

        // 导出沟通记录
        function exportCommunications() {
            const dataStr = JSON.stringify(communications, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `communications_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // 获取沟通类型文本
        function getCommunicationTypeText(type) {
            switch (type) {
                case 1: return '电话';
                case 2: return '邮件';
                case 3: return '微信';
                case 4: return '面谈';
                default: return '未知';
            }
        }

        // 获取重要程度文本
        function getImportanceText(importance) {
            switch (importance) {
                case 1: return '高';
                case 2: return '中';
                case 3: return '低';
                default: return '未知';
            }
        }

        // 获取重要程度样式类
        function getImportanceClass(importance) {
            switch (importance) {
                case 1: return 'bg-danger';
                case 2: return 'bg-warning';
                case 3: return 'bg-success';
                default: return 'bg-secondary';
            }
        }

        // 格式化日期时间
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('zh-CN');
        }
    </script>
</body>
</html>
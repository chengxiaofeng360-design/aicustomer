<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户档案管理 - AI客户管理系统</title>
    <link href="/lib/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <!-- 页面头部 -->
        <div class="page-header">
            <div class="page-title">
                <i class="bi bi-people-fill"></i> 客户档案管理
            </div>
            <a href="/" class="back-home-btn">
                <i class="bi bi-house-fill"></i> 返回首页
            </a>
        </div>
        
        <!-- 统计卡片 -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="stats-card" style="padding: 1rem; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <div class="stats-label" style="font-size: 0.9rem; margin-bottom: 0.25rem;">客户总数</div>
                        <div class="stats-number" style="font-size: 1.5rem; font-weight: bold;">1,234</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="padding: 1rem; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <div class="stats-label" style="font-size: 0.9rem; margin-bottom: 0.25rem;">客户满意度</div>
                        <div class="stats-number" style="font-size: 1.5rem; font-weight: bold;">89%</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="padding: 1rem; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <div class="stats-label" style="font-size: 0.9rem; margin-bottom: 0.25rem;">本月新增</div>
                        <div class="stats-number" style="font-size: 1.5rem; font-weight: bold;">156</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="padding: 1rem; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <div class="stats-label" style="font-size: 0.9rem; margin-bottom: 0.25rem;">潜在客户</div>
                        <div class="stats-number" style="font-size: 1.5rem; font-weight: bold;">45</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜索和筛选区域 -->
        <div class="card mb-3">
            <div class="card-body">
                <!-- 第一排：搜索条件 -->
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label">客户名称</label>
                        <input type="text" class="form-control" id="customerName" placeholder="请输入客户名称...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">客户类型</label>
                        <select class="form-select" id="customerType">
                            <option value="">全部</option>
                            <option value="个人">个人</option>
                            <option value="企业">企业</option>
                            <option value="科研院所">科研院所</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">客户等级</label>
                        <select class="form-select" id="customerLevel">
                            <option value="">全部</option>
                            <option value="普通">普通</option>
                            <option value="VIP">VIP</option>
                            <option value="钻石">钻石</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">申请性质</label>
                        <select class="form-select" id="applicationType">
                            <option value="">全部</option>
                            <option value="新品种保护">新品种保护</option>
                            <option value="品种审定">品种审定</option>
                            <option value="商标注册">商标注册</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">地区</label>
                        <select class="form-select" id="region">
                            <option value="">全部</option>
                            <option value="北京">北京</option>
                            <option value="上海">上海</option>
                            <option value="广东">广东</option>
                            <option value="江苏">江苏</option>
                        </select>
                    </div>
                </div>
                
                <!-- 第二排：操作按钮 -->
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2 justify-content-between">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-success" onclick="showAddCustomerModal()">
                                    <i class="bi bi-plus"></i> 新增
                                </button>
                            <button class="btn btn-info" onclick="showAIRecognition()">
                                <i class="bi bi-robot"></i> AI识别
                            </button>
                            <button class="btn btn-success" onclick="showFileUpload()">
                                <i class="bi bi-upload"></i> 批量导入
                            </button>
                                <button class="btn btn-warning" onclick="exportCustomers()">
                                    <i class="bi bi-download"></i> 导出数据
                                </button>
                                <button class="btn btn-danger" onclick="batchDelete()">
                                    <i class="bi bi-trash"></i> 批量删除
                                </button>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-primary" onclick="searchCustomers()">
                                    <i class="bi bi-search"></i> 搜索
                                </button>
                                <button class="btn btn-secondary" onclick="resetFilters()">
                                    <i class="bi bi-arrow-clockwise"></i> 重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 记录统计信息 - 移到右下角 -->
        <div class="position-fixed" style="bottom: 20px; right: 20px; z-index: 1000;">
            <span class="badge bg-secondary fs-6">共 <span id="totalCustomers">0</span> 条记录</span>
        </div>

        <!-- 客户列表 -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>客户名称</th>
                                <th>联系人</th>
                                <th>电话</th>
                                <th>客户类型</th>
                                <th>客户等级</th>
                                <th>申请性质</th>
                                <th>地区</th>
                                <th>敏感信息</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            <!-- 客户数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/编辑客户模态框 -->
    <div class="modal fade" id="customerModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalTitle">新增客户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId" name="id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">客户名称 *</label>
                                    <input type="text" class="form-control" id="customerNameInput" name="customerName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">联系人 *</label>
                                    <input type="text" class="form-control" id="contactPerson" name="contactPerson" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">电话 *</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">邮箱</label>
                                    <input type="email" class="form-control" id="email" name="email">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">客户类型 *</label>
                                    <select class="form-select" id="customerTypeSelect" name="customerType" required>
                                        <option value="">请选择</option>
                                        <option value="个人">个人</option>
                                        <option value="企业">企业</option>
                                        <option value="科研院所">科研院所</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">客户等级 *</label>
                                    <select class="form-select" id="customerLevelSelect" name="customerLevel" required>
                                        <option value="">请选择</option>
                                        <option value="普通" selected>普通</option>
                                        <option value="VIP">VIP</option>
                                        <option value="钻石">钻石</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">地区 *</label>
                                    <select class="form-select" id="regionSelect" name="region" required>
                                        <option value="">请选择</option>
                                        <option value="北京">北京</option>
                                        <option value="上海">上海</option>
                                        <option value="广东">广东</option>
                                        <option value="江苏">江苏</option>
                                        <option value="浙江">浙江</option>
                                        <option value="山东">山东</option>
                                        <option value="河南">河南</option>
                                        <option value="四川">四川</option>
                                        <option value="湖北">湖北</option>
                                        <option value="湖南">湖南</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">申请性质 *</label>
                                    <select class="form-select" id="applicationTypeSelect" name="applicationType" required>
                                        <option value="">请选择</option>
                                        <option value="新品种保护">新品种保护</option>
                                        <option value="品种审定">品种审定</option>
                                        <option value="商标注册">商标注册</option>
                                        <option value="专利保护">专利保护</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">公司规模</label>
                                    <select class="form-select" id="companySize" name="companySize">
                                        <option value="">请选择</option>
                                        <option value="小型企业">小型企业</option>
                                        <option value="中型企业">中型企业</option>
                                        <option value="大型企业">大型企业</option>
                                        <option value="上市公司">上市公司</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">行业</label>
                                    <select class="form-select" id="industry" name="industry">
                                        <option value="">请选择</option>
                                        <option value="农业">农业</option>
                                        <option value="种业">种业</option>
                                        <option value="生物技术">生物技术</option>
                                        <option value="科研院所">科研院所</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">年营业额</label>
                                    <select class="form-select" id="annualRevenue" name="annualRevenue">
                                        <option value="">请选择</option>
                                        <option value="100万以下">100万以下</option>
                                        <option value="100-500万">100-500万</option>
                                        <option value="500-1000万">500-1000万</option>
                                        <option value="1000万以上">1000万以上</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">详细地址</label>
                            <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">备注</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomer()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 客户详情模态框 -->
    <div class="modal fade" id="customerDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">客户详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="customerDetailContent">
                    <!-- 客户详情内容将通过JavaScript动态加载 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI识别模态框 -->
    <div class="modal fade" id="aiRecognitionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-robot me-2"></i>AI智能识别客户信息
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> 使用说明：</h6>
                        <ul class="mb-0">
                            <li>支持从Excel、Word等文档中复制数据直接粘贴</li>
                            <li>每行一个客户，字段用制表符或逗号分隔</li>
                            <li>必填字段：客户名称、联系人、电话、客户类型、申请性质、地区</li>
                            <li>系统会自动识别和整理数据格式</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">数据格式示例：</label>
                        <div class="bg-light p-3 rounded">
                            <code>
                                张三公司 | 李四 | 13800138000 | 企业客户 | 新品种申请 | 北京 | 农业 | 1000万<br>
                                王五农场 | 赵六 | 13900139000 | 个人客户 | 品种权申请 | 上海 | 种植业 | 500万
                            </code>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">客户数据录入：</label>
                        <div class="input-group">
                            <textarea class="form-control" id="batchImportData" rows="10" 
                                      placeholder="请在此处粘贴客户数据，或使用语音录入功能..."></textarea>
                            <div class="input-group-append">
                                <button class="btn btn-outline-success" type="button" onclick="startVoiceInput()" id="voiceInputBtn">
                                    <i class="bi bi-mic"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                支持语音录入，直接说"木木"开始录音，停顿5秒自动结束
                            </small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="parseImportData()">
                                <i class="bi bi-gear"></i> 解析数据
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearImportData()">
                                <i class="bi bi-trash"></i> 清空
                            </button>
                            <button class="btn btn-outline-info" onclick="showVoiceHelp()">
                                <i class="bi bi-question-circle"></i> 语音帮助
                            </button>
                        </div>
                    </div>

                    <!-- 语音录入状态显示 -->
                    <div id="voiceStatus" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span id="voiceStatusText">正在听取语音...</span>
                        </div>
                    </div>

                    <div id="importPreview" style="display: none;">
                        <h6>数据预览：</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>客户名称</th>
                                        <th>联系人</th>
                                        <th>电话</th>
                                        <th>客户类型</th>
                                        <th>申请性质</th>
                                        <th>地区</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="importPreviewBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveBatchImport()" id="saveImportBtn" disabled>
                        <i class="bi bi-save"></i> 保存到数据库
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 密码验证模态框 -->
    <div class="modal fade" id="passwordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock me-2"></i>敏感信息保护
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        此客户信息包含敏感数据，需要输入保护密码才能查看完整信息。
                    </div>
                    <div class="mb-3">
                        <label class="form-label">保护密码</label>
                        <input type="password" class="form-control" id="protectionPassword" placeholder="请输入保护密码">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="verifyPassword()">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 文件上传批量导入模态框 -->
    <div class="modal fade" id="fileUploadModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-upload me-2"></i>文件批量导入客户信息
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <h6><i class="bi bi-info-circle"></i> 支持的文件格式：</h6>
                        <ul class="mb-0">
                            <li><strong>Excel文件</strong>：.xlsx, .xls - 自动解析表格数据</li>
                            <li><strong>PDF文件</strong>：.pdf - AI智能识别文本内容</li>
                            <li><strong>Word文件</strong>：.docx, .doc - 自动提取表格和文本</li>
                            <li><strong>CSV文件</strong>：.csv - 逗号分隔值文件</li>
                            <li><strong>TXT文件</strong>：.txt - 纯文本文件</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">选择文件：</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-upload-content">
                                <i class="bi bi-cloud-upload file-upload-icon"></i>
                                <h6>拖拽文件到此处或点击选择文件</h6>
                                <p class="text-muted">支持 Excel、PDF、Word、CSV、TXT 格式</p>
                                <input type="file" id="fileInput" class="file-input" multiple accept=".xlsx,.xls,.pdf,.docx,.doc,.csv,.txt">
                                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                    <i class="bi bi-folder2-open"></i> 选择文件
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="filePreview" style="display: none;">
                        <h6>文件预览：</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>文件名</th>
                                        <th>文件类型</th>
                                        <th>文件大小</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="filePreviewBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="dataPreview" style="display: none;">
                        <h6>数据预览：</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>客户名称</th>
                                        <th>联系人</th>
                                        <th>电话</th>
                                        <th>客户类型</th>
                                        <th>申请性质</th>
                                        <th>地区</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="dataPreviewBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="processUploadedFiles()" id="processFilesBtn" disabled>
                        <i class="bi bi-gear"></i> 处理文件
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveUploadedData()" id="saveUploadedBtn" disabled>
                        <i class="bi bi-save"></i> 保存到数据库
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/customers.js"></script>
    <script src="/lib/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户档案管理 - AI客户管理系统</title>
    <link href="/lib/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="/lib/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <!-- 页面头部 -->
        <div class="page-header">
            <div class="page-title">
                <i class="bi bi-people-fill"></i> 客户档案管理
            </div>
            <a href="/" class="back-home-btn">
                <i class="bi bi-house-fill"></i> 返回首页
            </a>
        </div>
        
        <!-- 统计卡片 -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="stats-card" style="padding: 1rem; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <div class="stats-label" style="font-size: 0.9rem; margin-bottom: 0.25rem;">客户总数</div>
                        <div class="stats-number" style="font-size: 1.5rem; font-weight: bold;">1,234</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="padding: 1rem; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <div class="stats-label" style="font-size: 0.9rem; margin-bottom: 0.25rem;">客户满意度</div>
                        <div class="stats-number" style="font-size: 1.5rem; font-weight: bold;">89%</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="padding: 1rem; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <div class="stats-label" style="font-size: 0.9rem; margin-bottom: 0.25rem;">本月新增</div>
                        <div class="stats-number" style="font-size: 1.5rem; font-weight: bold;">156</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="padding: 1rem; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <div class="stats-label" style="font-size: 0.9rem; margin-bottom: 0.25rem;">潜在客户</div>
                        <div class="stats-number" style="font-size: 1.5rem; font-weight: bold;">45</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜索和筛选区域 -->
        <div class="card mb-3">
            <div class="card-body">
                <!-- 第一排：搜索条件 -->
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label">客户名称</label>
                        <input type="text" class="form-control" id="customerName" placeholder="请输入客户名称...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">客户类型</label>
                        <select class="form-select" id="customerType">
                            <option value="">全部</option>
                            <option value="个人">个人</option>
                            <option value="企业">企业</option>
                            <option value="科研院所">科研院所</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">申请性质</label>
                        <select class="form-select" id="applicationType">
                            <option value="">全部</option>
                            <option value="新品种保护">新品种保护</option>
                            <option value="品种审定">品种审定</option>
                            <option value="商标注册">商标注册</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">地区</label>
                        <select class="form-select" id="region">
                            <option value="">全部</option>
                            <option value="北京">北京</option>
                            <option value="上海">上海</option>
                            <option value="广东">广东</option>
                            <option value="江苏">江苏</option>
                        </select>
                    </div>
                </div>
                
                <!-- 第二排：操作按钮 -->
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2 justify-content-between">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-success" onclick="showAddCustomerModal()">
                                    <i class="bi bi-plus"></i> 新增
                                </button>
                            <button class="btn btn-info" onclick="showAIRecognition()">
                                <i class="bi bi-robot"></i> AI识别
                            </button>
                            <button class="btn btn-success" onclick="showFileUpload()">
                                <i class="bi bi-upload"></i> 批量导入
                            </button>
                                <button class="btn btn-warning" onclick="exportCustomers()">
                                    <i class="bi bi-download"></i> 导出数据
                                </button>
                                <button class="btn btn-danger" onclick="batchDelete()">
                                    <i class="bi bi-trash"></i> 批量删除
                                </button>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-primary" onclick="searchCustomers()">
                                    <i class="bi bi-search"></i> 搜索
                                </button>
                                <button class="btn btn-secondary" onclick="resetFilters()">
                                    <i class="bi bi-arrow-clockwise"></i> 重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 记录统计信息 - 移到右下角 -->
        <div class="position-fixed" style="bottom: 20px; right: 20px; z-index: 1000;">
            <span class="badge bg-secondary fs-6">共 <span id="totalCustomers">0</span> 条记录</span>
        </div>

        <!-- 客户列表 -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>客户名称</th>
                                <th>联系人</th>
                                <th>电话</th>
                                <th>客户类型</th>
                                <th>申请性质</th>
                                <th>地区</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            <!-- 客户数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增/编辑客户模态框 -->
    <div class="modal fade" id="customerModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalTitle">新增客户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId" name="id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">客户名称 *</label>
                                    <input type="text" class="form-control" id="customerNameInput" name="customerName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">联系人 *</label>
                                    <input type="text" class="form-control" id="contactPerson" name="contactPerson" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">电话 *</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">邮箱</label>
                                    <input type="email" class="form-control" id="email" name="email">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">客户类型 *</label>
                                    <select class="form-select" id="customerTypeSelect" name="customerType" required>
                                        <option value="">请选择</option>
                                        <option value="个人">个人</option>
                                        <option value="企业">企业</option>
                                        <option value="科研院所">科研院所</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">地区 *</label>
                                    <select class="form-select" id="regionSelect" name="region" required>
                                        <option value="">请选择</option>
                                        <option value="北京">北京</option>
                                        <option value="上海">上海</option>
                                        <option value="广东">广东</option>
                                        <option value="江苏">江苏</option>
                                        <option value="浙江">浙江</option>
                                        <option value="山东">山东</option>
                                        <option value="河南">河南</option>
                                        <option value="四川">四川</option>
                                        <option value="湖北">湖北</option>
                                        <option value="湖南">湖南</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">申请性质 *</label>
                                    <select class="form-select" id="applicationTypeSelect" name="applicationType" required>
                                        <option value="">请选择</option>
                                        <option value="新品种保护">新品种保护</option>
                                        <option value="品种审定">品种审定</option>
                                        <option value="商标注册">商标注册</option>
                                        <option value="专利保护">专利保护</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">公司规模</label>
                                    <select class="form-select" id="companySize" name="companySize">
                                        <option value="">请选择</option>
                                        <option value="小型企业">小型企业</option>
                                        <option value="中型企业">中型企业</option>
                                        <option value="大型企业">大型企业</option>
                                        <option value="上市公司">上市公司</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">行业</label>
                                    <select class="form-select" id="industry" name="industry">
                                        <option value="">请选择</option>
                                        <option value="农业">农业</option>
                                        <option value="种业">种业</option>
                                        <option value="生物技术">生物技术</option>
                                        <option value="科研院所">科研院所</option>
                                        <option value="其他">其他</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">年营业额</label>
                                    <select class="form-select" id="annualRevenue" name="annualRevenue">
                                        <option value="">请选择</option>
                                        <option value="100万以下">100万以下</option>
                                        <option value="100-500万">100-500万</option>
                                        <option value="500-1000万">500-1000万</option>
                                        <option value="1000万以上">1000万以上</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 植物新品种保护申请信息 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">植物新品种保护申请信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">品种名称</label>
                                            <input type="text" class="form-control" id="varietyName" name="varietyName">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">品种类型</label>
                                            <select class="form-select" id="varietyType" name="varietyType">
                                                <option value="">请选择</option>
                                                <option value="玉米">玉米</option>
                                                <option value="水稻">水稻</option>
                                                <option value="小麦">小麦</option>
                                                <option value="大豆">大豆</option>
                                                <option value="其他">其他</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">申请号</label>
                                            <input type="text" class="form-control" id="applicationNumber" name="applicationNumber">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">申请日期</label>
                                            <input type="date" class="form-control" id="applicationDate" name="applicationDate">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 培育人信息 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">培育人信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">培育人姓名</label>
                                            <input type="text" class="form-control" id="breederName" name="breederName">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">培育人单位</label>
                                            <input type="text" class="form-control" id="breederUnit" name="breederUnit">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">培育人地址</label>
                                            <input type="text" class="form-control" id="breederAddress" name="breederAddress">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">培育人电话</label>
                                            <input type="text" class="form-control" id="breederPhone" name="breederPhone">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 申请人信息 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">申请人信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">申请人姓名</label>
                                            <input type="text" class="form-control" id="applicantName" name="applicantName">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">申请人单位</label>
                                            <input type="text" class="form-control" id="applicantUnit" name="applicantUnit">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">申请人地址</label>
                                            <input type="text" class="form-control" id="applicantAddress" name="applicantAddress">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label">申请人电话</label>
                                            <input type="text" class="form-control" id="applicantPhone" name="applicantPhone">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 其他信息 -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">其他信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">品种描述</label>
                                            <textarea class="form-control" id="varietyDescription" name="varietyDescription" rows="4"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">技术特点</label>
                                            <textarea class="form-control" id="technicalFeatures" name="technicalFeatures" rows="4"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">市场前景</label>
                                            <textarea class="form-control" id="marketProspect" name="marketProspect" rows="4"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">详细地址</label>
                            <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">备注</label>
                            <textarea class="form-control" id="remarks" name="remarks" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomer()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 客户详情模态框 -->
    <div class="modal fade" id="customerDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">客户详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="customerDetailContent">
                    <!-- 客户详情内容将通过JavaScript动态加载 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI识别模态框 -->
    <div class="modal fade" id="aiRecognitionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-robot me-2"></i>AI智能识别客户信息
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> 使用说明：</h6>
                        <ul class="mb-0">
                            <li>支持从Excel、Word等文档中复制数据直接粘贴</li>
                            <li>每行一个客户，字段用制表符或逗号分隔</li>
                            <li>必填字段：客户名称、联系人、电话、客户类型、申请性质、地区</li>
                            <li>系统会自动识别和整理数据格式</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">数据格式示例：</label>
                        <div class="bg-light p-3 rounded">
                            <code>
                                张三公司 | 李四 | 13800138000 | 企业客户 | 新品种申请 | 北京 | 农业 | 1000万<br>
                                王五农场 | 赵六 | 13900139000 | 个人客户 | 品种权申请 | 上海 | 种植业 | 500万
                            </code>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">客户数据录入：</label>
                        <div class="input-group">
                            <textarea class="form-control" id="batchImportData" rows="10" 
                                      placeholder="请在此处粘贴客户数据，或使用语音录入功能..."></textarea>
                            <div class="input-group-append">
                                <button class="btn btn-outline-success" type="button" onclick="startVoiceInput()" id="voiceInputBtn">
                                    <i class="bi bi-mic"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                支持语音录入，直接说"木木"开始录音，停顿5秒自动结束
                            </small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="parseImportData()">
                                <i class="bi bi-gear"></i> 解析数据
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearImportData()">
                                <i class="bi bi-trash"></i> 清空
                            </button>
                            <button class="btn btn-outline-info" onclick="showVoiceHelp()">
                                <i class="bi bi-question-circle"></i> 语音帮助
                            </button>
                        </div>
                    </div>

                    <!-- 语音录入状态显示 -->
                    <div id="voiceStatus" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span id="voiceStatusText">正在听取语音...</span>
                        </div>
                    </div>

                    <div id="importPreview" style="display: none;">
                        <h6>数据预览：</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>客户名称</th>
                                        <th>联系人</th>
                                        <th>电话</th>
                                        <th>客户类型</th>
                                        <th>申请性质</th>
                                        <th>地区</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="importPreviewBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveBatchImport()" id="saveImportBtn" disabled>
                        <i class="bi bi-save"></i> 保存到数据库
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 文件上传批量导入模态框 -->
    <div class="modal fade" id="fileUploadModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-upload me-2"></i>文件批量导入客户信息
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <h6><i class="bi bi-info-circle"></i> 支持的文件格式：</h6>
                        <ul class="mb-0">
                            <li><strong>Excel文件</strong>：.xlsx, .xls - 自动解析表格数据</li>
                            <li><strong>PDF文件</strong>：.pdf - AI智能识别文本内容</li>
                            <li><strong>Word文件</strong>：.docx, .doc - 自动提取表格和文本</li>
                            <li><strong>CSV文件</strong>：.csv - 逗号分隔值文件</li>
                            <li><strong>TXT文件</strong>：.txt - 纯文本文件</li>
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">选择文件：</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-upload-content">
                                <i class="bi bi-cloud-upload file-upload-icon"></i>
                                <h6>拖拽文件到此处或点击选择文件</h6>
                                <p class="text-muted">支持 Excel、PDF、Word、CSV、TXT 格式</p>
                                <input type="file" id="fileInput" class="file-input" multiple accept=".xlsx,.xls,.pdf,.docx,.doc,.csv,.txt">
                                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                                    <i class="bi bi-folder2-open"></i> 选择文件
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="filePreview" style="display: none;">
                        <h6>文件预览：</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>文件名</th>
                                        <th>文件类型</th>
                                        <th>文件大小</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="filePreviewBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="dataPreview" style="display: none;">
                        <h6>数据预览：</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>客户名称</th>
                                        <th>联系人</th>
                                        <th>电话</th>
                                        <th>客户类型</th>
                                        <th>申请性质</th>
                                        <th>地区</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="dataPreviewBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="processUploadedFiles()" id="processFilesBtn" disabled>
                        <i class="bi bi-gear"></i> 处理文件
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveUploadedData()" id="saveUploadedBtn" disabled>
                        <i class="bi bi-save"></i> 保存到数据库
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 模拟客户数据
        let customers = [
            {
                id: 1,
                customerName: '张三',
                contactPerson: '张三',
                phone: '13612345678',
                email: 'zhangsan@example.com',
                customerType: '个人',
                applicationType: '新品种保护',
                region: '北京',
                companySize: '',
                industry: '农业',
                annualRevenue: '100万以下',
                varietyName: '京优1号玉米',
                varietyType: '玉米',
                applicationNumber: 'CNA2024001234',
                applicationDate: '2024-01-15',
                breederName: '张三',
                breederUnit: '个人育种',
                breederAddress: '北京市朝阳区农业科技园',
                breederPhone: '13612345678',
                applicantName: '张三',
                applicantUnit: '个人申请',
                applicantAddress: '北京市朝阳区农业科技园A座101室',
                applicantPhone: '13612345678',
                varietyDescription: '京优1号玉米是我经过5年精心培育的高产优质玉米品种，具有抗病性强、适应性广、产量高等特点。该品种在华北地区表现优异，平均亩产可达800公斤以上，比对照品种增产15%以上。',
                technicalFeatures: '1. 抗病性强：对玉米大斑病、小斑病、茎腐病等主要病害具有良好抗性；2. 适应性广：适合华北、东北等地区种植；3. 产量高：平均亩产800公斤以上；4. 品质优：籽粒饱满，蛋白质含量高；5. 抗倒伏：株高适中，抗倒伏能力强。',
                marketProspect: '随着人们对优质粮食需求的增加，京优1号玉米具有广阔的市场前景。预计未来3-5年内，该品种在华北地区的推广面积可达100万亩以上，年产值超过8亿元。同时，该品种还可作为饲料玉米，满足畜牧业发展需求。',
                address: '北京市朝阳区农业科技园A座101室',
                remarks: '种子培育专家，从事玉米育种工作20余年，具有丰富的育种经验和技术积累。该品种已通过初步试验，表现优异，具有很好的推广价值。',
                createTime: '2024-01-15',
                updateTime: '2024-01-20'
            },
            {
                id: 2,
                customerName: '李四农业科技有限公司',
                contactPerson: '李四',
                phone: '13987654321',
                email: 'lisi@company.com',
                customerType: '企业',
                applicationType: '品种审定',
                region: '上海',
                companySize: '中型企业',
                industry: '种业',
                annualRevenue: '500-1000万',
                varietyName: '沪优2号水稻',
                varietyType: '水稻',
                applicationNumber: 'CNA2024002567',
                applicationDate: '2024-01-20',
                breederName: '李四',
                breederUnit: '李四农业科技有限公司',
                breederAddress: '上海市浦东新区农业科技园B座201室',
                breederPhone: '13987654321',
                applicantName: '李四',
                applicantUnit: '李四农业科技有限公司',
                applicantAddress: '上海市浦东新区农业科技园B座201室',
                applicantPhone: '13987654321',
                varietyDescription: '沪优2号水稻是我公司自主研发的优质高产水稻品种，具有抗倒伏、抗病性强、米质优良等特点。该品种适合长江中下游地区种植，平均亩产可达650公斤以上。',
                technicalFeatures: '1. 抗倒伏：株高适中，茎秆粗壮；2. 抗病性强：对稻瘟病、纹枯病等主要病害具有良好抗性；3. 米质优良：米粒饱满，口感好；4. 适应性广：适合长江中下游地区；5. 产量稳定：平均亩产650公斤以上。',
                marketProspect: '随着优质大米市场需求的增长，沪优2号水稻具有很好的市场前景。预计在长江中下游地区的推广面积可达50万亩以上，年产值超过3亿元。',
                address: '上海市浦东新区农业科技园B座201室',
                remarks: '专业从事水稻育种，公司成立15年，拥有完善的育种体系和丰富的品种资源。该品种已通过区域试验，表现优异。',
                createTime: '2024-01-20',
                updateTime: '2024-01-25'
            },
            {
                id: 3,
                customerName: '王五种子研究所',
                contactPerson: '王五',
                phone: '13888888888',
                email: 'wangwu@institute.com',
                customerType: '科研院所',
                applicationType: '专利保护',
                region: '广东',
                companySize: '',
                industry: '科研院所',
                annualRevenue: '1000万以上',
                varietyName: '粤优3号小麦',
                varietyType: '小麦',
                applicationNumber: 'CNA2024003890',
                applicationDate: '2024-01-25',
                breederName: '王五',
                breederUnit: '王五种子研究所',
                breederAddress: '广东省广州市天河区农业科学院',
                breederPhone: '13888888888',
                applicantName: '王五',
                applicantUnit: '王五种子研究所',
                applicantAddress: '广东省广州市天河区农业科学院',
                applicantPhone: '13888888888',
                varietyDescription: '粤优3号小麦是我所经过8年系统选育的优质强筋小麦品种，具有抗寒性强、抗病性好、蛋白质含量高等特点。该品种适合华南地区种植，平均亩产可达450公斤以上。',
                technicalFeatures: '1. 抗寒性强：适合华南地区冬季种植；2. 抗病性好：对小麦条锈病、白粉病等主要病害具有良好抗性；3. 蛋白质含量高：蛋白质含量达14%以上；4. 强筋特性：面筋质量好，适合制作优质面包；5. 产量稳定：平均亩产450公斤以上。',
                marketProspect: '随着优质强筋小麦需求的增加，粤优3号小麦具有广阔的市场前景。预计在华南地区的推广面积可达30万亩以上，年产值超过1.5亿元。',
                address: '广东省广州市天河区农业科学院',
                remarks: '国家级种子研究机构，拥有50年的育种历史，培育出多个优良品种。该品种已通过国家审定，具有很好的推广价值。',
                createTime: '2024-01-25',
                updateTime: '2024-01-30'
            }
        ];

        let selectedCustomers = [];

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomers();
            updateTotalCount();
            
            // 初始化文件上传功能
            initFileUpload();
            
            // 自动启动语音监听
            setTimeout(() => {
                autoStartVoiceListening();
            }, 2000); // 延迟2秒启动，确保页面完全加载
        });

        // 加载客户列表
        function loadCustomers() {
            const tbody = document.getElementById('customerTableBody');
            tbody.innerHTML = '';

            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = 
                    '<td>' +
                        '<input type="checkbox" class="customer-checkbox" value="' + customer.id + '" onchange="toggleCustomerSelection(' + customer.id + ')">' +
                    '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.customerName + '">' + customer.customerName + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.contactPerson + '">' + customer.contactPerson + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.phone + '">' + customer.phone + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.customerType + '">' + customer.customerType + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.applicationType + '">' + customer.applicationType + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.region + '">' + customer.region + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.createTime + '">' + customer.createTime + '</td>' +
                    '<td>' +
                        '<button class="btn btn-sm btn-outline-primary me-1" onclick="viewCustomer(' + customer.id + ')">' +
                            '<i class="bi bi-eye"></i> 详情' +
                        '</button>' +
                        '<button class="btn btn-sm btn-outline-warning me-1" onclick="editCustomer(' + customer.id + ')">' +
                            '<i class="bi bi-pencil"></i> 编辑' +
                        '</button>' +
                        '<button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(' + customer.id + ')">' +
                            '<i class="bi bi-trash"></i> 删除' +
                        '</button>' +
                    '</td>';
                tbody.appendChild(row);
            });
            
            updateTotalCount();
        }

        // 更新总记录数
        function updateTotalCount() {
            const totalCountElement = document.getElementById('totalCustomers');
            if (totalCountElement) {
                totalCountElement.textContent = customers.length;
            }
        }

        // 搜索客户
        function searchCustomers() {
            const name = document.getElementById('customerName').value;
            const type = document.getElementById('customerType').value;
            const application = document.getElementById('applicationType').value;
            const region = document.getElementById('region').value;

            let filteredCustomers = customers.filter(customer => {
                return (!name || customer.customerName.includes(name)) &&
                       (!type || customer.customerType === type) &&
                       (!application || customer.applicationType === application) &&
                       (!region || customer.region === region);
            });

            // 重新渲染表格
            const tbody = document.getElementById('customerTableBody');
            tbody.innerHTML = '';

            filteredCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = 
                    '<td>' +
                        '<input type="checkbox" class="customer-checkbox" value="' + customer.id + '" onchange="toggleCustomerSelection(' + customer.id + ')">' +
                    '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.customerName + '">' + customer.customerName + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.contactPerson + '">' + customer.contactPerson + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.phone + '">' + customer.phone + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.customerType + '">' + customer.customerType + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.applicationType + '">' + customer.applicationType + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.region + '">' + customer.region + '</td>' +
                    '<td class="table-cell-truncate" title="' + customer.createTime + '">' + customer.createTime + '</td>' +
                    '<td>' +
                        '<button class="btn btn-sm btn-outline-primary me-1" onclick="viewCustomer(' + customer.id + ')">' +
                            '<i class="bi bi-eye"></i> 详情' +
                        '</button>' +
                        '<button class="btn btn-sm btn-outline-warning me-1" onclick="editCustomer(' + customer.id + ')">' +
                            '<i class="bi bi-pencil"></i> 编辑' +
                        '</button>' +
                        '<button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(' + customer.id + ')">' +
                            '<i class="bi bi-trash"></i> 删除' +
                        '</button>' +
                    '</td>';
                tbody.appendChild(row);
            });
            
            // 更新搜索结果数量
            const totalCountElement = document.getElementById('totalCustomers');
            if (totalCountElement) {
                totalCountElement.textContent = filteredCustomers.length;
            }
        }

        // 重置筛选条件
        function resetFilters() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerType').value = '';
            document.getElementById('applicationType').value = '';
            document.getElementById('region').value = '';
            loadCustomers();
        }

        // 显示新增客户模态框
        function showAddCustomerModal() {
            document.getElementById('customerModalTitle').textContent = '新增客户';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            new bootstrap.Modal(document.getElementById('customerModal')).show();
        }

        // 显示AI识别模态框
        function showAIRecognition() {
            new bootstrap.Modal(document.getElementById('aiRecognitionModal')).show();
        }

        // 显示文件上传模态框
        function showFileUpload() {
            new bootstrap.Modal(document.getElementById('fileUploadModal')).show();
        }

        // 解析导入数据
        function parseImportData() {
            const data = document.getElementById('batchImportData').value.trim();
            if (!data) {
                alert('请先粘贴要导入的数据！');
                return;
            }

            const lines = data.split('\n').filter(line => line.trim());
            const parsedData = [];
            let hasError = false;

            lines.forEach((line, index) => {
                const fields = line.split(/[\t,|]/).map(field => field.trim());
                
                if (fields.length < 6) {
                    hasError = true;
                    parsedData.push({
                        customerName: fields[0] || '',
                        contactPerson: fields[1] || '',
                        phone: fields[2] || '',
                        customerType: fields[3] || '',
                        applicationType: fields[4] || '',
                        region: fields[5] || '',
                        industry: fields[6] || '',
                        annualRevenue: fields[7] || '',
                        status: 'error',
                        error: '字段不足，至少需要6个字段'
                    });
                    return;
                }

                // 验证必填字段
                const requiredFields = [fields[0], fields[1], fields[2], fields[3], fields[4], fields[5]];
                const missingFields = requiredFields.some(field => !field);
                
                if (missingFields) {
                    hasError = true;
                    parsedData.push({
                        customerName: fields[0] || '',
                        contactPerson: fields[1] || '',
                        phone: fields[2] || '',
                        customerType: fields[3] || '',
                        applicationType: fields[4] || '',
                        region: fields[5] || '',
                        industry: fields[6] || '',
                        annualRevenue: fields[7] || '',
                        status: 'error',
                        error: '必填字段不能为空'
                    });
                } else {
                    parsedData.push({
                        customerName: fields[0],
                        contactPerson: fields[1],
                        phone: fields[2],
                        customerType: fields[3],
                        applicationType: fields[4],
                        region: fields[5],
                        industry: fields[6] || '',
                        annualRevenue: fields[7] || '',
                        varietyName: fields[8] || '',
                        varietyType: fields[9] || '',
                        applicationNumber: fields[10] || '',
                        applicationDate: fields[11] || '',
                        breederName: fields[12] || '',
                        breederUnit: fields[13] || '',
                        breederAddress: fields[14] || '',
                        breederPhone: fields[15] || '',
                        applicantName: fields[16] || '',
                        applicantUnit: fields[17] || '',
                        applicantAddress: fields[18] || '',
                        applicantPhone: fields[19] || '',
                        varietyDescription: fields[20] || '',
                        technicalFeatures: fields[21] || '',
                        marketProspect: fields[22] || '',
                        address: fields[23] || '',
                        remarks: fields[24] || '',
                        status: 'valid'
                    });
                }
            });

            // 显示预览
            displayImportPreview(parsedData);
            
            if (!hasError) {
                document.getElementById('saveImportBtn').disabled = false;
            }
        }

        // 显示导入预览
        function displayImportPreview(data) {
            const previewBody = document.getElementById('importPreviewBody');
            previewBody.innerHTML = '';

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = item.status === 'error' ? 'table-danger' : 'table-success';
                
                row.innerHTML = `
                    <td>${item.customerName}</td>
                    <td>${item.contactPerson}</td>
                    <td>${item.phone}</td>
                    <td>${item.customerType}</td>
                    <td>${item.applicationType}</td>
                    <td>${item.region}</td>
                    <td>
                        ${item.status === 'error' ? 
                            `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> ${item.error}</span>` : 
                            `<span class="text-success"><i class="bi bi-check-circle"></i> 有效</span>`
                        }
                    </td>
                `;
                previewBody.appendChild(row);
            });

            document.getElementById('importPreview').style.display = 'block';
        }

        // 清空导入数据
        function clearImportData() {
            document.getElementById('batchImportData').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('saveImportBtn').disabled = true;
        }

        // 语音录入相关变量
        let recognition = null;
        let isRecording = false;
        let isListeningForKeyword = true; // 默认始终监听关键词
        let silenceTimer = null;
        let lastSpeechTime = 0;
        const SILENCE_TIMEOUT = 5000; // 5秒无语音自动结束
        const KEYWORD = '木木';

        // 初始化语音识别
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'zh-CN';

                recognition.onstart = function() {
                    isRecording = true;
                    updateVoiceButton(true);
                    if (isListeningForKeyword) {
                        showVoiceStatus('正在等待关键词"木木"触发录音...');
                    } else {
                        showVoiceStatus('正在听取语音，请开始说话...');
                    }
                };

                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    // 检查是否包含关键词
                    if (isListeningForKeyword && finalTranscript.toLowerCase().includes(KEYWORD)) {
                        isListeningForKeyword = false;
                        showVoiceStatus('关键词检测成功！开始录音，请说出客户信息...');
                        startSilenceTimer();
                        return;
                    }

                    // 如果正在录音，处理语音内容
                    if (!isListeningForKeyword && finalTranscript) {
                        lastSpeechTime = Date.now();
                        const processedText = processVoiceInput(finalTranscript);
                        const textarea = document.getElementById('batchImportData');
                        const currentText = textarea.value;
                        textarea.value = currentText + processedText;
                        showVoiceStatus('已识别并处理：' + finalTranscript);
                        startSilenceTimer(); // 重置静音计时器
                    }

                    // 显示临时识别结果
                    if (interimTranscript) {
                        if (isListeningForKeyword) {
                            showVoiceStatus('正在等待关键词"木木"...');
                        } else {
                            showVoiceStatus('正在听取：' + interimTranscript);
                        }
                    }
                };

                recognition.onerror = function(event) {
                    console.error('语音识别错误:', event.error);
                    showVoiceStatus('语音识别出错：' + event.error);
                    stopVoiceInput();
                };

                recognition.onend = function() {
                    isRecording = false;
                    isListeningForKeyword = true; // 重新开始监听关键词
                    updateVoiceButton(false);
                    hideVoiceStatus();
                    clearSilenceTimer();
                    
                    // 自动重新开始监听（延迟1秒避免频繁重启）
                    setTimeout(() => {
                        if (!isRecording) {
                            autoStartVoiceListening();
                        }
                    }, 1000);
                };
            } else {
                alert('您的浏览器不支持语音识别功能，请使用Chrome或Edge浏览器。');
            }
        }

        // 开始语音录入（现在用于手动控制）
        function startVoiceInput() {
            if (!recognition) {
                initVoiceRecognition();
            }

            if (isRecording) {
                stopVoiceInput();
            } else {
                // 启动关键词检测模式
                isListeningForKeyword = true;
                try {
                    recognition.start();
                } catch (error) {
                    console.error('启动语音识别失败:', error);
                    alert('启动语音识别失败，请检查麦克风权限。');
                }
            }
        }

        // 自动启动语音监听
        function autoStartVoiceListening() {
            if (!recognition) {
                initVoiceRecognition();
            }
            
            if (!isRecording) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('自动启动语音识别失败:', error);
                    // 静默失败，不显示错误提示
                }
            }
        }

        // 停止语音录入
        function stopVoiceInput() {
            if (recognition && isRecording) {
                recognition.stop();
            }
            clearSilenceTimer();
        }

        // 开始静音计时器
        function startSilenceTimer() {
            clearSilenceTimer();
            silenceTimer = setTimeout(() => {
                if (isRecording && !isListeningForKeyword) {
                    showVoiceStatus('检测到5秒无语音输入，自动结束录音...');
                    setTimeout(() => {
                        stopVoiceInput();
                    }, 1000);
                }
            }, SILENCE_TIMEOUT);
        }

        // 清除静音计时器
        function clearSilenceTimer() {
            if (silenceTimer) {
                clearTimeout(silenceTimer);
                silenceTimer = null;
            }
        }

        // 更新语音按钮状态
        function updateVoiceButton(recording) {
            const btn = document.getElementById('voiceInputBtn');
            const icon = btn.querySelector('i');
            
            if (recording) {
                btn.className = 'btn btn-danger';
                icon.className = 'bi bi-mic-mute';
                btn.title = '停止语音录入';
            } else {
                btn.className = 'btn btn-outline-success';
                icon.className = 'bi bi-mic';
                btn.title = '开始语音录入';
            }
        }

        // 显示语音状态
        function showVoiceStatus(message) {
            const statusDiv = document.getElementById('voiceStatus');
            const statusText = document.getElementById('voiceStatusText');
            statusText.textContent = message;
            statusDiv.style.display = 'block';
        }

        // 隐藏语音状态
        function hideVoiceStatus() {
            const statusDiv = document.getElementById('voiceStatus');
            statusDiv.style.display = 'none';
        }

        // 处理语音输入
        function processVoiceInput(text) {
            // 替换常见的语音识别错误
            let processedText = text
                .replace(/，/g, ' | ')  // 将中文逗号替换为分隔符
                .replace(/,/g, ' | ')   // 将英文逗号替换为分隔符
                .replace(/下一个客户/g, '\n')  // 将"下一个客户"替换为换行
                .replace(/下一位客户/g, '\n')  // 将"下一位客户"替换为换行
                .replace(/下一个/g, '\n')      // 将"下一个"替换为换行
                .replace(/客户类型企业客户/g, '企业客户')  // 修复客户类型识别
                .replace(/客户类型个人客户/g, '个人客户')  // 修复客户类型识别
                .replace(/申请性质新品种申请/g, '新品种申请')  // 修复申请性质识别
                .replace(/申请性质品种权申请/g, '品种权申请')  // 修复申请性质识别
                .replace(/年收入/g, '')  // 移除"年收入"文字，只保留数字
                .replace(/万/g, '万')    // 确保"万"字正确
                .replace(/\s+/g, ' ')   // 合并多个空格
                .trim();

            // 如果文本以分隔符结尾，添加换行
            if (processedText.endsWith(' | ')) {
                processedText = processedText.slice(0, -3) + '\n';
            }

            return processedText;
        }

        // 显示语音帮助
        function showVoiceHelp() {
            const helpText = `
语音录入使用说明：

🎤 始终监听模式：
1. 页面加载后自动开始语音监听
2. 直接说出关键词"木木"开始录音
3. 系统检测到关键词后自动开始录音
4. 说出客户信息，系统自动识别和格式化
5. 停顿5秒以上或无语音输入自动结束录音
6. 录音结束后自动重新开始监听

📝 录音格式示例：
"张三公司，联系人李四，电话13800138000，企业客户，新品种申请，北京，农业，年收入1000万，下一个客户，王五农场，联系人赵六，电话13900139000，个人客户，品种权申请，上海，种植业，年收入500万"

⚙️ 操作流程：
1. 页面加载 → 自动开始监听
2. 说出"木木" → 开始录音
3. 说出客户信息 → 自动识别和格式化
4. 停顿5秒 → 自动结束录音
5. 自动重新监听 → 等待下次"木木"
6. 点击"解析数据" → 处理录入内容

💡 语音识别技巧：
- 关键词：清晰说出"木木"触发录音
- 数字：13800138000 说成 "一三八零零一三八零零零"
- 客户类型：说"企业客户"或"个人客户"
- 申请性质：说"新品种申请"或"品种权申请"
- 地区：说具体的城市名称
- 客户分隔：说"下一个客户"来分隔

🔧 自动功能：
- 始终监听：页面加载后自动开始监听
- 关键词检测：自动识别"木木"关键词
- 静音检测：5秒无语音自动结束
- 自动重启：录音结束后自动重新监听
- 数据格式化：自动处理语音识别结果
- 错误修复：自动修复常见识别错误

注意事项：
- 请确保在安静的环境中录入
- 说话要清晰，语速适中
- 必填字段：客户名称、联系人、电话、客户类型、申请性质、地区
- 可选字段：行业、年收入、品种名称等
- 麦克风按钮可用于手动控制监听状态
            `;
            
            alert(helpText);
        }

        // 文件上传相关变量
        let uploadedFiles = [];
        let processedData = [];

        // 初始化文件上传
        function initFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');

            // 文件选择事件
            fileInput.addEventListener('change', handleFileSelect);

            // 拖拽事件
            fileUploadArea.addEventListener('dragover', handleDragOver);
            fileUploadArea.addEventListener('dragleave', handleDragLeave);
            fileUploadArea.addEventListener('drop', handleFileDrop);
        }

        // 处理文件选择
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }

        // 处理拖拽悬停
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        // 处理拖拽离开
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        // 处理文件拖拽
        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            const files = Array.from(event.dataTransfer.files);
            addFiles(files);
        }

        // 添加文件
        function addFiles(files) {
            files.forEach(file => {
                if (isValidFileType(file)) {
                    uploadedFiles.push({
                        file: file,
                        name: file.name,
                        type: getFileType(file.name),
                        size: formatFileSize(file.size),
                        status: '待处理'
                    });
                } else {
                    alert(`不支持的文件格式：${file.name}`);
                }
            });
            updateFilePreview();
            document.getElementById('processFilesBtn').disabled = false;
        }

        // 验证文件类型
        function isValidFileType(file) {
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                'application/vnd.ms-excel', // .xls
                'application/pdf', // .pdf
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document', // .docx
                'application/msword', // .doc
                'text/csv', // .csv
                'text/plain' // .txt
            ];
            return validTypes.includes(file.type) || 
                   file.name.endsWith('.xlsx') || 
                   file.name.endsWith('.xls') || 
                   file.name.endsWith('.pdf') || 
                   file.name.endsWith('.docx') || 
                   file.name.endsWith('.doc') || 
                   file.name.endsWith('.csv') || 
                   file.name.endsWith('.txt');
        }

        // 获取文件类型
        function getFileType(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            const typeMap = {
                'xlsx': 'Excel文件',
                'xls': 'Excel文件',
                'pdf': 'PDF文件',
                'docx': 'Word文件',
                'doc': 'Word文件',
                'csv': 'CSV文件',
                'txt': '文本文件'
            };
            return typeMap[extension] || '未知类型';
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 更新文件预览
        function updateFilePreview() {
            const tbody = document.getElementById('filePreviewBody');
            tbody.innerHTML = '';

            uploadedFiles.forEach((fileData, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fileData.name}</td>
                    <td>${fileData.type}</td>
                    <td>${fileData.size}</td>
                    <td>
                        <span class="badge bg-secondary">${fileData.status}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('filePreview').style.display = 'block';
        }

        // 移除文件
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFilePreview();
            if (uploadedFiles.length === 0) {
                document.getElementById('filePreview').style.display = 'none';
                document.getElementById('processFilesBtn').disabled = true;
            }
        }

        // 处理上传的文件
        function processUploadedFiles() {
            if (uploadedFiles.length === 0) {
                alert('请先选择文件！');
                return;
            }

            processedData = [];
            let processedCount = 0;

            uploadedFiles.forEach((fileData, index) => {
                const file = fileData.file;
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = parseFileContent(e.target.result, file.name);
                        processedData = processedData.concat(data);
                        fileData.status = '已处理';
                        processedCount++;

                        if (processedCount === uploadedFiles.length) {
                            updateFilePreview();
                            displayDataPreview();
                            document.getElementById('saveUploadedBtn').disabled = false;
                        }
                    } catch (error) {
                        console.error('文件处理错误:', error);
                        fileData.status = '处理失败';
                        updateFilePreview();
                    }
                };

                reader.readAsText(file);
            });
        }

        // 解析文件内容
        function parseFileContent(content, fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            
            switch (extension) {
                case 'csv':
                    return parseCSV(content);
                case 'txt':
                    return parseTXT(content);
                default:
                    // 对于Excel、PDF、Word等复杂格式，这里模拟解析
                    return parseComplexFile(content, fileName);
            }
        }

        // 解析CSV文件
        function parseCSV(content) {
            const lines = content.split('\n').filter(line => line.trim());
            const data = [];
            
            lines.forEach((line, index) => {
                if (index === 0) return; // 跳过标题行
                
                const fields = line.split(',').map(field => field.trim().replace(/"/g, ''));
                if (fields.length >= 6) {
                    data.push({
                        customerName: fields[0] || '',
                        contactPerson: fields[1] || '',
                        phone: fields[2] || '',
                        customerType: fields[3] || '',
                        applicationType: fields[4] || '',
                        region: fields[5] || '',
                        industry: fields[6] || '',
                        annualRevenue: fields[7] || '',
                        status: 'valid'
                    });
                }
            });
            
            return data;
        }

        // 解析TXT文件
        function parseTXT(content) {
            const lines = content.split('\n').filter(line => line.trim());
            const data = [];
            
            lines.forEach(line => {
                const fields = line.split(/[\t,|]/).map(field => field.trim());
                if (fields.length >= 6) {
                    data.push({
                        customerName: fields[0] || '',
                        contactPerson: fields[1] || '',
                        phone: fields[2] || '',
                        customerType: fields[3] || '',
                        applicationType: fields[4] || '',
                        region: fields[5] || '',
                        industry: fields[6] || '',
                        annualRevenue: fields[7] || '',
                        status: 'valid'
                    });
                }
            });
            
            return data;
        }

        // 解析复杂文件（Excel、PDF、Word等）
        function parseComplexFile(content, fileName) {
            // 这里模拟解析复杂文件，实际项目中需要集成相应的解析库
            const mockData = [
                {
                    customerName: '示例公司1',
                    contactPerson: '联系人1',
                    phone: '13800138001',
                    customerType: '企业客户',
                    applicationType: '新品种申请',
                    region: '北京',
                    industry: '农业',
                    annualRevenue: '1000万',
                    status: 'valid'
                },
                {
                    customerName: '示例公司2',
                    contactPerson: '联系人2',
                    phone: '13800138002',
                    customerType: '个人客户',
                    applicationType: '品种权申请',
                    region: '上海',
                    industry: '种植业',
                    annualRevenue: '500万',
                    status: 'valid'
                }
            ];
            
            return mockData;
        }

        // 显示数据预览
        function displayDataPreview() {
            const tbody = document.getElementById('dataPreviewBody');
            tbody.innerHTML = '';

            processedData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = item.status === 'valid' ? 'table-success' : 'table-danger';
                
                row.innerHTML = `
                    <td>${item.customerName}</td>
                    <td>${item.contactPerson}</td>
                    <td>${item.phone}</td>
                    <td>${item.customerType}</td>
                    <td>${item.applicationType}</td>
                    <td>${item.region}</td>
                    <td>
                        ${item.status === 'valid' ? 
                            `<span class="text-success"><i class="bi bi-check-circle"></i> 有效</span>` : 
                            `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> 无效</span>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('dataPreview').style.display = 'block';
        }

        // 保存上传的数据
        function saveUploadedData() {
            if (processedData.length === 0) {
                alert('没有要保存的数据！');
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            processedData.forEach((item, index) => {
                if (item.status === 'valid') {
                    const newCustomer = {
                        id: Date.now() + index,
                        customerName: item.customerName,
                        contactPerson: item.contactPerson,
                        phone: item.phone,
                        email: '',
                        companySize: '',
                        customerType: item.customerType,
                        applicationType: item.applicationType,
                        region: item.region,
                        industry: item.industry || '',
                        annualRevenue: item.annualRevenue || '',
                        varietyName: '',
                        varietyType: '',
                        applicationNumber: '',
                        applicationDate: '',
                        breederName: '',
                        breederUnit: '',
                        breederAddress: '',
                        breederPhone: '',
                        applicantName: '',
                        applicantUnit: '',
                        applicantAddress: '',
                        applicantPhone: '',
                        varietyDescription: '',
                        technicalFeatures: '',
                        marketProspect: '',
                        address: '',
                        remarks: '',
                        createTime: new Date().toLocaleString(),
                        updateTime: new Date().toLocaleString()
                    };

                    customers.push(newCustomer);
                    successCount++;
                } else {
                    errorCount++;
                }
            });

            // 刷新客户列表
            loadCustomers();
            
            // 关闭模态框
            bootstrap.Modal.getInstance(document.getElementById('fileUploadModal')).hide();
            
            // 显示结果
            alert(`文件导入完成！\n成功导入：${successCount} 条\n失败：${errorCount} 条`);
            
            // 清空数据
            uploadedFiles = [];
            processedData = [];
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('dataPreview').style.display = 'none';
            document.getElementById('processFilesBtn').disabled = true;
            document.getElementById('saveUploadedBtn').disabled = true;
        }

        // 保存批量导入数据
        function saveBatchImport() {
            const data = document.getElementById('batchImportData').value.trim();
            if (!data) {
                alert('没有要保存的数据！');
                return;
            }

            const lines = data.split('\n').filter(line => line.trim());
            let successCount = 0;
            let errorCount = 0;

            lines.forEach((line, index) => {
                const fields = line.split(/[\t,|]/).map(field => field.trim());
                
                if (fields.length >= 6) {
                    const requiredFields = [fields[0], fields[1], fields[2], fields[3], fields[4], fields[5]];
                    const missingFields = requiredFields.some(field => !field);
                    
                    if (!missingFields) {
                        // 创建新客户对象
                        const newCustomer = {
                            id: Date.now() + index,
                            customerName: fields[0],
                            contactPerson: fields[1],
                            phone: fields[2],
                            email: fields[3] || '',
                            companySize: fields[4] || '',
                            customerType: fields[5],
                            applicationType: fields[6],
                            region: fields[7],
                            industry: fields[8] || '',
                            annualRevenue: fields[9] || '',
                            varietyName: fields[10] || '',
                            varietyType: fields[11] || '',
                            applicationNumber: fields[12] || '',
                            applicationDate: fields[13] || '',
                            breederName: fields[14] || '',
                            breederUnit: fields[15] || '',
                            breederAddress: fields[16] || '',
                            breederPhone: fields[17] || '',
                            applicantName: fields[18] || '',
                            applicantUnit: fields[19] || '',
                            applicantAddress: fields[20] || '',
                            applicantPhone: fields[21] || '',
                            varietyDescription: fields[22] || '',
                            technicalFeatures: fields[23] || '',
                            marketProspect: fields[24] || '',
                            address: fields[25] || '',
                            remarks: fields[26] || '',
                            createTime: new Date().toLocaleString(),
                            updateTime: new Date().toLocaleString()
                        };

                        customers.push(newCustomer);
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } else {
                    errorCount++;
                }
            });

            // 刷新客户列表
            loadCustomers();
            
            // 关闭模态框
            bootstrap.Modal.getInstance(document.getElementById('batchImportModal')).hide();
            
            // 显示结果
            alert(`批量导入完成！\n成功导入：${successCount} 条\n失败：${errorCount} 条`);
            
            // 清空数据
            clearImportData();
        }

        // 查看客户详情
        function viewCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                const content = 
                    '<div class="row">' +
                        '<div class="col-md-4">' +
                            '<h6>基本信息</h6>' +
                            '<p><strong>客户名称：</strong>' + customer.customerName + '</p>' +
                            '<p><strong>联系人：</strong>' + customer.contactPerson + '</p>' +
                            '<p><strong>电话：</strong>' + customer.phone + '</p>' +
                            '<p><strong>邮箱：</strong>' + (customer.email || '未填写') + '</p>' +
                            '<p><strong>公司规模：</strong>' + (customer.companySize || '未填写') + '</p>' +
                        '</div>' +
                        '<div class="col-md-4">' +
                            '<h6>业务信息</h6>' +
                            '<p><strong>客户类型：</strong>' + customer.customerType + '</p>' +
                            '<p><strong>申请性质：</strong>' + customer.applicationType + '</p>' +
                            '<p><strong>地区：</strong>' + customer.region + '</p>' +
                            '<p><strong>行业：</strong>' + (customer.industry || '未填写') + '</p>' +
                            '<p><strong>年营业额：</strong>' + (customer.annualRevenue || '未填写') + '</p>' +
                        '</div>' +
                        '<div class="col-md-4">' +
                            '<h6>植物新品种保护申请信息</h6>' +
                            '<p><strong>品种名称：</strong>' + (customer.varietyName || '未填写') + '</p>' +
                            '<p><strong>品种类型：</strong>' + (customer.varietyType || '未填写') + '</p>' +
                            '<p><strong>申请号：</strong>' + (customer.applicationNumber || '未填写') + '</p>' +
                            '<p><strong>申请日期：</strong>' + (customer.applicationDate || '未填写') + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="row mt-3">' +
                        '<div class="col-md-4">' +
                            '<h6>培育人信息</h6>' +
                            '<p><strong>培育人姓名：</strong>' + (customer.breederName || '未填写') + '</p>' +
                            '<p><strong>培育人单位：</strong>' + (customer.breederUnit || '未填写') + '</p>' +
                            '<p><strong>培育人地址：</strong>' + (customer.breederAddress || '未填写') + '</p>' +
                            '<p><strong>培育人电话：</strong>' + (customer.breederPhone || '未填写') + '</p>' +
                        '</div>' +
                        '<div class="col-md-4">' +
                            '<h6>申请人信息</h6>' +
                            '<p><strong>申请人姓名：</strong>' + (customer.applicantName || '未填写') + '</p>' +
                            '<p><strong>申请人单位：</strong>' + (customer.applicantUnit || '未填写') + '</p>' +
                            '<p><strong>申请人地址：</strong>' + (customer.applicantAddress || '未填写') + '</p>' +
                            '<p><strong>申请人电话：</strong>' + (customer.applicantPhone || '未填写') + '</p>' +
                        '</div>' +
                        '<div class="col-md-4">' +
                            '<h6>系统信息</h6>' +
                            '<p><strong>创建时间：</strong>' + customer.createTime + '</p>' +
                            '<p><strong>最后更新：</strong>' + (customer.updateTime || customer.createTime) + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="row mt-3">' +
                        '<div class="col-md-4">' +
                            '<h6>品种描述</h6>' +
                            '<p>' + (customer.varietyDescription || '未填写') + '</p>' +
                        '</div>' +
                        '<div class="col-md-4">' +
                            '<h6>技术特点</h6>' +
                            '<p>' + (customer.technicalFeatures || '未填写') + '</p>' +
                        '</div>' +
                        '<div class="col-md-4">' +
                            '<h6>市场前景</h6>' +
                            '<p>' + (customer.marketProspect || '未填写') + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="row mt-3">' +
                        '<div class="col-md-6">' +
                            '<h6>地址信息</h6>' +
                            '<p><strong>详细地址：</strong>' + (customer.address || '未填写') + '</p>' +
                        '</div>' +
                        '<div class="col-md-6">' +
                            '<h6>备注信息</h6>' +
                            '<p><strong>备注：</strong>' + (customer.remarks || '无') + '</p>' +
                        '</div>' +
                    '</div>';
                document.getElementById('customerDetailContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('customerDetailModal')).show();
            }
        }

        // 编辑客户
        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                document.getElementById('customerModalTitle').textContent = '编辑客户';
                document.getElementById('customerId').value = customer.id;
                document.getElementById('customerNameInput').value = customer.customerName;
                document.getElementById('contactPerson').value = customer.contactPerson;
                document.getElementById('phone').value = customer.phone;
                document.getElementById('email').value = customer.email || '';
                document.getElementById('customerTypeSelect').value = customer.customerType;
                document.getElementById('regionSelect').value = customer.region;
                document.getElementById('applicationTypeSelect').value = customer.applicationType;
                document.getElementById('companySize').value = customer.companySize || '';
                document.getElementById('industry').value = customer.industry || '';
                document.getElementById('annualRevenue').value = customer.annualRevenue || '';
                document.getElementById('varietyName').value = customer.varietyName || '';
                document.getElementById('varietyType').value = customer.varietyType || '';
                document.getElementById('applicationNumber').value = customer.applicationNumber || '';
                document.getElementById('applicationDate').value = customer.applicationDate || '';
                document.getElementById('breederName').value = customer.breederName || '';
                document.getElementById('breederUnit').value = customer.breederUnit || '';
                document.getElementById('breederAddress').value = customer.breederAddress || '';
                document.getElementById('breederPhone').value = customer.breederPhone || '';
                document.getElementById('applicantName').value = customer.applicantName || '';
                document.getElementById('applicantUnit').value = customer.applicantUnit || '';
                document.getElementById('applicantAddress').value = customer.applicantAddress || '';
                document.getElementById('applicantPhone').value = customer.applicantPhone || '';
                document.getElementById('varietyDescription').value = customer.varietyDescription || '';
                document.getElementById('technicalFeatures').value = customer.technicalFeatures || '';
                document.getElementById('marketProspect').value = customer.marketProspect || '';
                document.getElementById('address').value = customer.address || '';
                document.getElementById('remarks').value = customer.remarks || '';
                new bootstrap.Modal(document.getElementById('customerModal')).show();
            }
        }

        // 保存客户
        function saveCustomer() {
            const form = document.getElementById('customerForm');
            const formData = new FormData(form);
            
            const customerData = {
                customerName: formData.get('customerName'),
                contactPerson: formData.get('contactPerson'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                customerType: formData.get('customerType'),
                region: formData.get('region'),
                applicationType: formData.get('applicationType'),
                companySize: formData.get('companySize'),
                industry: formData.get('industry'),
                annualRevenue: formData.get('annualRevenue'),
                varietyName: formData.get('varietyName'),
                varietyType: formData.get('varietyType'),
                applicationNumber: formData.get('applicationNumber'),
                applicationDate: formData.get('applicationDate'),
                breederName: formData.get('breederName'),
                breederUnit: formData.get('breederUnit'),
                breederAddress: formData.get('breederAddress'),
                breederPhone: formData.get('breederPhone'),
                applicantName: formData.get('applicantName'),
                applicantUnit: formData.get('applicantUnit'),
                applicantAddress: formData.get('applicantAddress'),
                applicantPhone: formData.get('applicantPhone'),
                varietyDescription: formData.get('varietyDescription'),
                technicalFeatures: formData.get('technicalFeatures'),
                marketProspect: formData.get('marketProspect'),
                address: formData.get('address'),
                remarks: formData.get('remarks')
            };

            const customerId = document.getElementById('customerId').value;
            
            if (customerId) {
                // 编辑模式
                const index = customers.findIndex(c => c.id == customerId);
                if (index !== -1) {
                    customers[index] = { ...customers[index], ...customerData };
                }
            } else {
                // 新增模式
                const newCustomer = {
                    id: customers.length + 1,
                    ...customerData,
                    createTime: new Date().toISOString().split('T')[0]
                };
                customers.push(newCustomer);
            }

            loadCustomers();
            bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
            alert('保存成功！');
        }

        // 删除客户
        function deleteCustomer(id) {
            if (confirm('确定要删除这个客户吗？')) {
                customers = customers.filter(c => c.id !== id);
                loadCustomers();
                alert('删除成功！');
            }
        }

        // 批量删除
        function batchDelete() {
            if (selectedCustomers.length === 0) {
                alert('请先选择要删除的客户！');
                return;
            }
            
            if (confirm('确定要删除选中的 ' + selectedCustomers.length + ' 个客户吗？')) {
                customers = customers.filter(c => !selectedCustomers.includes(c.id));
                selectedCustomers = [];
                loadCustomers();
                alert('批量删除成功！');
            }
        }

        // 全选/取消全选
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.customer-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                if (selectAll.checked) {
                    if (!selectedCustomers.includes(parseInt(checkbox.value))) {
                        selectedCustomers.push(parseInt(checkbox.value));
                    }
                } else {
                    selectedCustomers = selectedCustomers.filter(id => id !== parseInt(checkbox.value));
                }
            });
        }

        // 切换客户选择状态
        function toggleCustomerSelection(id) {
            const index = selectedCustomers.indexOf(id);
            if (index > -1) {
                selectedCustomers.splice(index, 1);
            } else {
                selectedCustomers.push(id);
            }
        }

        // 刷新客户列表
        function refreshCustomers() {
            loadCustomers();
            alert('刷新成功！');
        }

        // 导入客户
        function importCustomers() {
            alert('导入功能开发中...');
        }

        // 导出客户
        function exportCustomers() {
            const dataStr = JSON.stringify(customers, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'customers_' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            URL.revokeObjectURL(url);
        }
    </script>
    <script src="/lib/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>